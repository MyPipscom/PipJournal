<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PipJournal | Professional Trading Journal</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #16161f;
      --bg-elevated: #1a1a24;
      --border: #2a2a3a;
      --border-subtle: #1f1f2a;
      --text-primary: #f0f0f5;
      --text-secondary: #8a8a9a;
      --text-muted: #5a5a6a;
      --accent-green: #00d4a1;
      --accent-green-dim: rgba(0, 212, 161, 0.15);
      --accent-red: #ff4757;
      --accent-red-dim: rgba(255, 71, 87, 0.15);
      --accent-blue: #4a9eff;
      --accent-blue-dim: rgba(74, 158, 255, 0.15);
      --accent-purple: #a855f7;
      --accent-yellow: #ffc107;
      --gradient-green: linear-gradient(135deg, #00d4a1 0%, #00b890 100%);
      --gradient-red: linear-gradient(135deg, #ff4757 0%, #e63946 100%);
      --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --sidebar-width: 240px;
    }
    [data-theme="light"] {
      --bg-primary: #f5f5f7;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --bg-elevated: #f0f0f2;
      --border: #d1d1d6;
      --border-subtle: #e5e5ea;
      --text-primary: #1a1a1f;
      --text-secondary: #6a6a75;
      --text-muted: #8a8a95;
      --accent-green: #00b890;
      --accent-green-dim: rgba(0, 184, 144, 0.12);
      --accent-red: #e63946;
      --accent-red-dim: rgba(230, 57, 70, 0.12);
      --accent-blue: #3a8eef;
      --accent-blue-dim: rgba(58, 142, 239, 0.12);
      --accent-purple: #9333ea;
      --accent-yellow: #e6a800;
      --gradient-green: linear-gradient(135deg, #00b890 0%, #00a67c 100%);
      --gradient-red: linear-gradient(135deg, #e63946 0%, #d32836 100%);
      --shadow-md: 0 4px 20px rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    *::-webkit-scrollbar { width: 8px; height: 8px; }
    *::-webkit-scrollbar-track { background: var(--bg-elevated); }
    *::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    *::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    * { scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-elevated); }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
    body::before { content: ''; position: fixed; inset: 0; background-image: linear-gradient(var(--border-subtle) 1px, transparent 1px), linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; z-index: 0; opacity: 0.5; }
    .app-container { display: flex; min-height: 100vh; position: relative; z-index: 1; }
    .sidebar { background: var(--bg-secondary); border-right: 1px solid var(--border-subtle); padding: 24px 16px; display: flex; flex-direction: column; width: var(--sidebar-width); flex-shrink: 0; height: 100vh; position: sticky; top: 0; overflow-y: auto; transition: width 0.3s ease; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
    .sidebar::-webkit-scrollbar { width: 6px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    .sidebar.collapsed { width: 72px; padding: 24px 12px; }
    .sidebar.collapsed .logo-text { display: none; }
    .sidebar.collapsed .nav-label { display: none; }
    .sidebar.collapsed .nav-text { display: none; }
    .sidebar.collapsed .nav-item { justify-content: center; padding: 12px; }
    .sidebar.collapsed .nav-item svg { margin-right: 0; }
    .sidebar.collapsed .account-balance { display: none; }
    .sidebar.collapsed .collapse-btn { transform: rotate(180deg); }
    .collapse-btn { width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; margin-top: 16px; transition: all 0.2s ease; }
    .collapse-btn:hover { background: var(--bg-card); color: var(--text-primary); }
    .collapse-btn svg { width: 18px; height: 18px; transition: transform 0.3s ease; }
    .nav-text { white-space: nowrap; }
    .logo { display: flex; align-items: center; gap: 10px; padding: 0 8px 24px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 24px; }
    .logo-icon { width: 36px; height: 36px; background: var(--gradient-green); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: var(--bg-primary); }
    .logo-text { font-size: 20px; font-weight: 700; }
    .logo-text span { color: var(--accent-green); }
    .nav-section { margin-bottom: 28px; }
    .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; font-size: 14px; font-weight: 500; }
    .nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-green-dim); color: var(--accent-green); }
    .nav-item svg { width: 18px; height: 18px; opacity: 0.8; }
    .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-subtle); }
    .account-balance { background: var(--bg-elevated); border-radius: var(--radius-md); padding: 16px; }
    .balance-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 6px; }
    .balance-amount { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 600; color: var(--accent-green); }
    .main-content { flex: 1; min-width: 0; padding: 24px 32px; }
    .main-inner { max-width: 1400px; margin: 0 auto; }
    .page { display: none; }
    .page.active { display: block; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .header-left h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .header-left p { color: var(--text-secondary); font-size: 14px; }
    .header-actions { display: flex; gap: 12px; }
    .btn { padding: 12px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--gradient-green); color: var(--bg-primary); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,212,161,0.3); }
    .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 20px; position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--border); }
    .stat-card.positive::before { background: var(--gradient-green); }
    .stat-card.negative::before { background: var(--gradient-red); }
    .stat-card.neutral::before { background: linear-gradient(135deg, var(--accent-blue), #3d8bdb); }
    .stat-card.purple::before { background: linear-gradient(135deg, var(--accent-purple), #9333ea); }
    .stat-card.yellow::before { background: linear-gradient(135deg, var(--accent-yellow), #f59e0b); }
    .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; }
    .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .stat-change { font-size: 13px; color: var(--text-muted); }
    .stat-change.positive { color: var(--accent-green); }
    .stat-change.negative { color: var(--accent-red); }
    .content-grid { display: grid; grid-template-columns: 1fr 360px; gap: 24px; }
    .card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); overflow: hidden; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 16px; font-weight: 600; }
    .card-actions { display: flex; gap: 8px; align-items: center; }
    .filter-btn { padding: 6px 12px; font-size: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; }
    .filter-btn:hover, .filter-btn.active { background: var(--bg-primary); color: var(--text-primary); border-color: var(--text-muted); }
    .search-input { padding: 8px 12px; font-size: 13px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); width: 180px; }
    .search-input:focus { outline: none; border-color: var(--accent-green); }
    .trades-table { width: 100%; overflow-x: auto; }
    .table-header, .table-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 60px; padding: 14px 24px; min-width: 550px; }
    .table-header { background: var(--bg-elevated); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); }
    .table-row { border-bottom: 1px solid var(--border-subtle); align-items: center; }
    .table-row.clickable-row { cursor: pointer; transition: background 0.15s ease; }
    .table-row.clickable-row:hover { background: var(--bg-elevated); }
    .table-row:hover { background: var(--bg-elevated); }
    .trade-symbol { display: flex; align-items: center; gap: 12px; }
    .symbol-icon { width: 36px; height: 36px; border-radius: var(--radius-sm); background: var(--bg-elevated); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600; color: var(--text-secondary); }
    .symbol-name { font-weight: 600; font-size: 14px; }
    .symbol-date { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .trade-direction { display: inline-flex; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .trade-direction.long { background: var(--accent-green-dim); color: var(--accent-green); }
    .trade-direction.short { background: var(--accent-red-dim); color: var(--accent-red); }
    .trade-entry, .trade-exit { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
    .trade-pnl { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }
    .trade-pnl.positive { color: var(--accent-green); }
    .trade-pnl.negative { color: var(--accent-red); }
    .trade-rr { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-secondary); }
    .delete-btn { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; padding: 6px 10px; border-radius: var(--radius-sm); font-size: 14px; }
    .delete-btn:hover { background: var(--accent-red-dim); color: var(--accent-red); border-color: var(--accent-red); }
    .right-column { display: flex; flex-direction: column; gap: 24px; }
    .chart-container { padding: 24px; height: 240px; position: relative; }
    .chart-tooltip { position: absolute; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px 12px; pointer-events: none; opacity: 0; transition: opacity 0.15s ease; z-index: 10; white-space: nowrap; }
    .chart-tooltip-trade { font-size: 11px; color: var(--text-muted); margin-bottom: 2px; }
    .chart-tooltip-balance { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; color: var(--accent-green); }
    .chart-point { cursor: pointer; transition: r 0.15s ease; }
    .chart-point:hover { r: 6; }
    .chart-svg { width: 100%; height: 100%; }
    .chart-line { fill: none; stroke: var(--accent-green); stroke-width: 2.5; stroke-linecap: round; }
    .chart-area { fill: url(#chartGradient); }
    .win-rate-container { padding: 24px; display: flex; flex-direction: column; align-items: center; }
    .win-rate-ring { position: relative; width: 140px; height: 140px; margin-bottom: 20px; }
    .win-rate-ring svg { transform: rotate(-90deg); }
    .ring-bg { fill: none; stroke: var(--bg-elevated); stroke-width: 12; }
    .ring-progress { fill: none; stroke: url(#ringGradient); stroke-width: 12; stroke-linecap: round; stroke-dasharray: 377; stroke-dashoffset: 377; transition: stroke-dashoffset 1s ease; }
    .win-rate-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .win-rate-percent { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; color: var(--accent-green); }
    .win-rate-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
    .win-rate-stats { display: flex; gap: 32px; }
    .win-rate-stat { text-align: center; }
    .win-rate-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; }
    .win-rate-stat-value.wins { color: var(--accent-green); }
    .win-rate-stat-value.losses { color: var(--accent-red); }
    .win-rate-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .quick-stats { padding: 20px 24px; }
    .quick-stat-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border-subtle); }
    .quick-stat-item:last-child { border-bottom: none; }
    .quick-stat-label { font-size: 13px; color: var(--text-secondary); }
    .quick-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }
    .modal-overlay { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: flex-start; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; padding: 0; overflow-y: auto; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-primary); border: none; border-radius: 0; width: 100%; max-width: 100%; min-height: 100vh; max-height: none; overflow-y: visible; transform: translateY(0); transition: opacity 0.3s ease; }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 40px; border-bottom: 1px solid var(--border-subtle); position: sticky; top: 0; background: var(--bg-primary); z-index: 10; }
    .modal-title { font-size: 24px; font-weight: 700; }
    .modal-close { width: 40px; height: 40px; border-radius: var(--radius-sm); background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; font-size: 20px; }
    .modal-close:hover { background: var(--bg-card); color: var(--text-primary); }
    .modal-body { padding: 32px 40px; max-width: 800px; margin: 0 auto; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full-width { grid-column: span 2; }
    .form-label { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .form-input, .form-select, .form-textarea { padding: 14px 16px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 15px; width: 100%; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-green); }
    .form-textarea { resize: vertical; min-height: 100px; font-family: 'DM Sans', sans-serif; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 24px 40px; border-top: 1px solid var(--border-subtle); max-width: 800px; margin: 0 auto; }
    .empty-state { padding: 60px 24px; text-align: center; color: var(--text-muted); }
    .full-table .table-header, .full-table .table-row { grid-template-columns: 50px 1.5fr 1fr 1fr 1fr 1fr 1fr 1fr 1.5fr 60px; min-width: 900px; }
    .trade-notes { font-size: 12px; color: var(--text-muted); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .trade-strategy { font-size: 12px; color: var(--accent-blue); text-transform: capitalize; }
    .trade-id { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); }
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-top: 1px solid var(--border-subtle); }
    .pagination-info { font-size: 13px; color: var(--text-muted); }
    .pagination-btns { display: flex; gap: 8px; }
    .pagination-btn { padding: 8px 12px; font-size: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .toast { position: fixed; left: 24px; bottom: 24px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px 14px; display: flex; align-items: center; gap: 12px; z-index: 2000; opacity: 0; transform: translateY(10px); pointer-events: none; transition: all 0.2s ease; }
    .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .toast-text { font-size: 13px; color: var(--text-secondary); }
    .toast-actions { margin-left: auto; display: flex; gap: 8px; }
    .toast-btn { padding: 6px 10px; border-radius: var(--radius-sm); border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; }
    .toast-btn.undo { background: var(--accent-green-dim); border-color: rgba(0,212,161,0.35); color: var(--accent-green); }
    .analytics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px; }
    .streak-display { display: flex; gap: 24px; padding: 20px 24px; }
    .streak-item { flex: 1; text-align: center; padding: 16px; background: var(--bg-elevated); border-radius: var(--radius-md); }
    .streak-value { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .streak-label { font-size: 12px; color: var(--text-muted); }
    .streak-item.wins .streak-value { color: var(--accent-green); }
    .streak-item.losses .streak-value { color: var(--accent-red); }
    .streak-item.current .streak-value { color: var(--accent-blue); }
    .day-heatmap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 20px 24px; }
    .day-cell { aspect-ratio: 1; border-radius: var(--radius-sm); display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-elevated); }
    .day-cell.positive { background: var(--accent-green-dim); }
    .day-cell.negative { background: var(--accent-red-dim); }
    .day-name { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .day-value { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; }
    .day-cell.positive .day-value { color: var(--accent-green); }
    .day-cell.negative .day-value { color: var(--accent-red); }
    .distribution-bars { padding: 20px 24px; }
    .dist-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .dist-label { font-size: 12px; color: var(--text-muted); width: 80px; }
    .dist-bar { flex: 1; height: 24px; background: var(--bg-elevated); border-radius: 4px; overflow: hidden; display: flex; }
    .dist-bar-win { background: var(--accent-green); height: 100%; }
    .dist-bar-loss { background: var(--accent-red); height: 100%; }
    .dist-value { font-family: 'JetBrains Mono', monospace; font-size: 12px; width: 60px; text-align: right; }
    .strategy-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-subtle); }
    .strategy-item:last-child { border-bottom: none; }
    .strategy-name { font-size: 14px; font-weight: 500; text-transform: capitalize; }
    .strategy-stats { display: flex; gap: 16px; }
    .strategy-stat { text-align: right; }
    .strategy-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }
    .strategy-stat-label { font-size: 11px; color: var(--text-muted); }
    .playbook-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); margin-bottom: 20px; overflow: hidden; }
    .playbook-card-header { display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; }
    .playbook-card-header:hover { background: var(--bg-elevated); }
    .playbook-title-row { display: flex; align-items: center; gap: 12px; }
    .playbook-category { font-size: 11px; font-weight: 600; text-transform: uppercase; padding: 4px 8px; border-radius: 4px; background: var(--accent-blue-dim); color: var(--accent-blue); }
    .playbook-category.breakout { background: var(--accent-green-dim); color: var(--accent-green); }
    .playbook-category.pullback { background: var(--accent-blue-dim); color: var(--accent-blue); }
    .playbook-category.reversal { background: rgba(168,85,247,0.15); color: #a855f7; }
    .playbook-category.momentum { background: rgba(255,193,7,0.15); color: #ffc107; }
    .playbook-category.scalp { background: var(--accent-red-dim); color: var(--accent-red); }
    .playbook-category.swing { background: rgba(0,200,200,0.15); color: #00c8c8; }
    .playbook-name { font-size: 18px; font-weight: 600; }
    .playbook-stats { display: flex; gap: 20px; margin-top: 8px; }
    .playbook-stat { text-align: center; }
    .playbook-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }
    .playbook-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
    .playbook-actions { display: flex; gap: 8px; }
    .playbook-btn { padding: 6px 12px; font-size: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; }
    .playbook-btn:hover { background: var(--bg-primary); color: var(--text-primary); }
    .playbook-btn.delete:hover { background: var(--accent-red-dim); color: var(--accent-red); border-color: var(--accent-red); }
    .playbook-content { padding: 20px 24px; display: none; border-top: 1px solid var(--border-subtle); }
    .playbook-content.expanded { display: block; }
    .playbook-section { margin-bottom: 20px; }
    .playbook-section:last-child { margin-bottom: 0; }
    .playbook-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 8px; }
    .playbook-section-text { font-size: 14px; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; }
    .playbook-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .playbook-grid { grid-template-columns: 1fr; } }
    .trade-has-image { position: relative; }
    .trade-image-icon { width: 20px; height: 20px; background: var(--accent-blue-dim); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; margin-left: 8px; }
    .trade-image-icon:hover { background: var(--accent-blue); color: var(--bg-primary); }
    .image-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; padding: 20px; }
    .image-modal.active { opacity: 1; visibility: visible; }
    .image-modal img { max-width: 90vw; max-height: 90vh; border-radius: var(--radius-md); }
    .image-modal-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: var(--bg-elevated); border: none; border-radius: 50%; color: var(--text-primary); font-size: 24px; cursor: pointer; }
    .calendar-container { padding: 20px 24px; }
    .calendar-header-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 8px; }
    .calendar-day-name { text-align: center; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; padding: 8px 0; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .calendar-day { min-height: 80px; background: var(--bg-elevated); border-radius: var(--radius-sm); padding: 8px; position: relative; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
    .calendar-day:hover { border-color: var(--border); }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-day.empty:hover { border-color: transparent; }
    .calendar-day.positive { background: var(--accent-green-dim); }
    .calendar-day.negative { background: var(--accent-red-dim); }
    .calendar-day.selected { border-color: var(--accent-blue); }
    .calendar-day.today { box-shadow: inset 0 0 0 2px var(--accent-blue); }
    .calendar-day-number { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
    .calendar-day.positive .calendar-day-number, .calendar-day.negative .calendar-day-number { color: var(--text-primary); }
    .calendar-day-pnl { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; }
    .calendar-day.positive .calendar-day-pnl { color: var(--accent-green); }
    .calendar-day.negative .calendar-day-pnl { color: var(--accent-red); }
    .calendar-day-trades { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
    .calendar-day.positive .calendar-day-trades, .calendar-day.negative .calendar-day-trades { color: var(--text-secondary); }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-card); border-radius: var(--radius-sm); margin-bottom: 6px; }
    .checklist-item:last-child { margin-bottom: 0; }
    .checklist-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-green); }
    .checklist-item span { flex: 1; font-size: 14px; }
    .checklist-item .remove-rule { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 16px; border-radius: 4px; }
    .checklist-item .remove-rule:hover { background: var(--accent-red-dim); color: var(--accent-red); }
    .checklist-item.checked span { text-decoration: line-through; color: var(--text-muted); }
    .trade-checklist { background: var(--bg-elevated); border-radius: var(--radius-sm); padding: 16px; margin-top: 12px; }
    .trade-checklist-title { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; }
    .star-rating { display: flex; gap: 4px; }
    .star-rating .star { font-size: 28px; color: var(--border); cursor: pointer; transition: color 0.15s ease, transform 0.15s ease; }
    .star-rating .star:hover { transform: scale(1.1); }
    .star-rating .star.active { color: #ffc107; }
    .star-rating .star:hover, .star-rating .star:hover ~ .star { color: var(--border); }
    .star-rating:hover .star { color: #ffc107; }
    .star-rating:hover .star:hover ~ .star { color: var(--border); }
    .star-display { color: #ffc107; font-size: 14px; letter-spacing: -2px; }
    .star-display .empty { color: var(--border); }
    .trade-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--accent-blue-dim); color: var(--accent-blue); border-radius: 20px; font-size: 12px; font-weight: 500; }
    .trade-tag .remove-tag { cursor: pointer; opacity: 0.7; }
    .trade-tag .remove-tag:hover { opacity: 1; }
    .quick-tag { padding: 4px 10px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-muted); border-radius: 20px; font-size: 11px; cursor: pointer; transition: all 0.15s ease; }
    .quick-tag:hover { background: var(--accent-blue-dim); border-color: var(--accent-blue); color: var(--accent-blue); }
    .tag-filter { padding: 4px 12px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.15s ease; }
    .tag-filter:hover { border-color: var(--accent-blue); }
    .tag-filter.active { background: var(--accent-blue-dim); border-color: var(--accent-blue); color: var(--accent-blue); }
    .journal-entry { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s ease; }
    .journal-entry:hover { border-color: var(--accent-blue); }
    .journal-entry-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .journal-entry-date { font-size: 18px; font-weight: 600; }
    .journal-entry-weekday { font-size: 13px; color: var(--text-muted); margin-left: 8px; }
    .journal-entry-pnl { font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; }
    .journal-entry-mood { display: flex; gap: 4px; margin-bottom: 12px; }
    .mood-indicator { font-size: 20px; }
    .journal-entry-preview { color: var(--text-secondary); font-size: 14px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .journal-section { margin-bottom: 20px; }
    .journal-section-title { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .journal-textarea { width: 100%; min-height: 100px; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: inherit; font-size: 14px; line-height: 1.6; resize: vertical; }
    .journal-textarea:focus { outline: none; border-color: var(--accent-blue); }
    .mood-selector { display: flex; gap: 8px; }
    .mood-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg-elevated); font-size: 22px; cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; }
    .mood-btn:hover { border-color: var(--accent-blue); transform: scale(1.1); }
    .mood-btn.active { border-color: var(--accent-green); background: var(--accent-green-dim); }
    .time-heatmap { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    .time-slot { background: var(--bg-elevated); border-radius: var(--radius-sm); padding: 12px 8px; text-align: center; }
    .time-slot-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
    .time-slot-value { font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; }
    .time-slot-trades { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    .time-slot.positive { background: var(--accent-green-dim); }
    .time-slot.positive .time-slot-value { color: var(--accent-green); }
    .time-slot.negative { background: var(--accent-red-dim); }
    .time-slot.negative .time-slot-value { color: var(--accent-red); }
    .tag-perf-item { display: flex; align-items: center; gap: 16px; padding: 14px 16px; background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: 8px; }
    .tag-perf-item:last-child { margin-bottom: 0; }
    .tag-perf-name { flex: 1; font-weight: 500; }
    .tag-perf-stats { display: flex; gap: 24px; align-items: center; }
    .tag-perf-stat { text-align: center; min-width: 70px; }
    .tag-perf-stat-value { font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 600; }
    .tag-perf-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
    .tag-perf-bar { width: 100px; height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden; }
    .tag-perf-bar-fill { height: 100%; border-radius: 3px; }
    .risk-violation { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--accent-red-dim); border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid var(--accent-red); }
    .risk-violation:last-child { margin-bottom: 0; }
    .risk-violation-icon { font-size: 18px; }
    .risk-violation-info { flex: 1; }
    .risk-violation-title { font-weight: 500; font-size: 14px; }
    .risk-violation-detail { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .risk-violation-amount { font-family: 'JetBrains Mono'; font-weight: 600; color: var(--accent-red); }
    @media (max-width: 1200px) { .content-grid, .analytics-grid { grid-template-columns: 1fr; } }
    @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    #authOverlay input:focus { border-color: #00d4a1; }
    #authSubmitBtn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,212,161,0.3); }
    #authSubmitBtn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .user-bar { display: flex; align-items: center; gap: 10px; padding: 12px; margin-bottom: 12px; background: var(--bg-elevated); border-radius: 10px; cursor: default; }
    .user-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, #00d4a1, #00b890); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: #000; flex-shrink: 0; }
    .user-info { overflow: hidden; flex: 1; min-width: 0; }
    .user-email { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-plan { font-size: 10px; color: var(--accent-green); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .sidebar.collapsed .user-info { display: none; }
    .sidebar.collapsed .user-bar { justify-content: center; padding: 8px; }
    .sync-indicator { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; padding: 8px 12px; }
    .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); }
    .sync-dot.offline { background: var(--accent-yellow); }
    .sync-dot.syncing { background: var(--accent-blue); animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    .logout-btn { width: 100%; padding: 8px; background: transparent; border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); font-size: 12px; cursor: pointer; font-family: inherit; transition: all 0.2s; margin-top: 8px; }
    .logout-btn:hover { border-color: var(--accent-red); color: var(--accent-red); }
    @media (max-width: 768px) { .sidebar { display: none; } .form-row { grid-template-columns: 1fr; } .form-group.full-width { grid-column: span 1; } .day-heatmap { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Auth Overlay -->
  <div id="authOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;transition:opacity 0.3s">
    <div style="width:100%;max-width:420px;padding:24px">
      <div style="text-align:center;margin-bottom:32px">
        <div style="display:inline-flex;align-items:center;gap:12px;margin-bottom:16px">
          <div style="width:48px;height:48px;background:linear-gradient(135deg,#00d4a1,#00b890);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#000">PJ</div>
          <span style="font-size:26px;font-weight:700;color:var(--text-primary)">Pip<span style="color:#00d4a1">Journal</span></span>
        </div>
        <p style="color:var(--text-secondary);font-size:15px" id="authSubtitle">Sign in to sync your trades across devices</p>
      </div>
      <div id="authBox" style="background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:32px">
        <div id="authError" style="display:none;background:var(--accent-red-dim);border:1px solid var(--accent-red);color:var(--accent-red);padding:12px 16px;border-radius:8px;font-size:13px;margin-bottom:16px"></div>
        <div id="authSuccess" style="display:none;background:var(--accent-green-dim);border:1px solid var(--accent-green);color:var(--accent-green);padding:12px 16px;border-radius:8px;font-size:13px;margin-bottom:16px"></div>
        
        <!-- Login Form -->
        <div id="loginForm">
          <div style="margin-bottom:16px">
            <label style="display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Email</label>
            <input type="email" id="authEmail" placeholder="your@email.com" style="width:100%;padding:12px 16px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:15px;outline:none;font-family:inherit" autocomplete="email">
          </div>
          <div style="margin-bottom:24px">
            <label style="display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">Password</label>
            <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;padding:12px 16px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:15px;outline:none;font-family:inherit" autocomplete="current-password">
          </div>
          <button id="authSubmitBtn" onclick="handleAuth()" style="width:100%;padding:14px;background:linear-gradient(135deg,#00d4a1,#00b890);color:#000;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s">Sign In</button>
          <div style="text-align:center;margin-top:16px;font-size:14px;color:var(--text-secondary)">
            <span id="authToggleText">Don't have an account?</span> <a href="#" onclick="toggleAuthMode(event)" style="color:#00d4a1;text-decoration:none;font-weight:600" id="authToggleLink">Sign Up</a>
          </div>
          <div style="position:relative;margin:24px 0;text-align:center">
            <div style="border-top:1px solid var(--border);position:absolute;top:50%;left:0;right:0"></div>
            <span style="background:var(--bg-card);padding:0 12px;position:relative;font-size:13px;color:var(--text-muted)">or</span>
          </div>
          <button onclick="continueOffline()" style="width:100%;padding:14px;background:var(--bg-elevated);color:var(--text-secondary);border:1px solid var(--border);border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;font-family:inherit;transition:all 0.2s">Continue without account</button>
          <p style="text-align:center;margin-top:12px;font-size:12px;color:var(--text-muted)">Data will only be saved locally on this device</p>
        </div>
      </div>
    </div>
  </div>
  <div class="app-container">
    <aside class="sidebar" id="sidebar">
      <div class="logo"><div class="logo-icon">PJ</div><div class="logo-text">Pip<span>Journal</span></div></div>
      <div id="userBar" class="user-bar" style="display:none">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-info">
          <div class="user-email" id="userEmail">-</div>
          <div class="user-plan" id="userPlan">Free</div>
        </div>
      </div>
      <div id="syncIndicator" class="sync-indicator" style="display:none">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncText">Synced</span>
      </div>
      <nav class="nav-section">
        <div class="nav-label">Main</div>
        <div class="nav-item active" onclick="showPage('dashboard', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span class="nav-text">Dashboard</span></div>
        <div class="nav-item" onclick="showPage('tradelog', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><span class="nav-text">Trade Log</span></div>
        <div class="nav-item" onclick="showPage('journal', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg><span class="nav-text">Journal</span></div>
        <div class="nav-item" onclick="showPage('analytics', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg><span class="nav-text">Analytics</span></div>
        <div class="nav-item" onclick="showPage('calendar', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><span class="nav-text">Calendar</span></div>
      </nav>
      <nav class="nav-section">
        <div class="nav-label">Tools</div>
        <div class="nav-item" onclick="showPage('riskcalc', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg><span class="nav-text">Risk Calculator</span></div>
        <div class="nav-item" onclick="showPage('playbook', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><span class="nav-text">Playbook</span></div>
        <div class="nav-item" onclick="showPage('settings', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span class="nav-text">Settings</span></div>
        <div class="nav-item" onclick="showPage('subscription', this)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg><span class="nav-text">Subscription</span></div>
      </nav>
      <div class="sidebar-footer">
        <div class="account-balance"><div class="balance-label">Account Balance</div><div class="balance-amount" id="accountBalance">$10,000.00</div></div>
        <button id="logoutBtn" class="logout-btn" onclick="handleLogout()" style="display:none">Sign Out</button>
        <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="collapseIcon"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
        </button>
      </div>
    </aside>
    <main class="main-content">
      <div class="main-inner">
        <!-- DASHBOARD -->
        <div class="page active" id="page-dashboard">
          <header class="header"><div class="header-left"><h1>Trading Dashboard</h1><p>Track your performance and analyze your trades</p></div><div class="header-actions"><button class="btn btn-secondary" onclick="exportTrades()">Export</button><button class="btn btn-primary" onclick="openModal()">+ New Trade</button></div></header>
          
          <!-- Trade Limit Warning (Free Plan) -->
          <div class="card" id="tradeLimitCard" style="margin-bottom:24px;display:none;border:1px solid var(--accent-yellow)">
            <div style="padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
              <div style="display:flex;align-items:center;gap:12px">
                <span style="font-size:24px">‚ö†Ô∏è</span>
                <div>
                  <div style="font-weight:600" id="tradeLimitText">3 trades remaining this month</div>
                  <div style="font-size:13px;color:var(--text-secondary)">Upgrade to Premium for unlimited trades</div>
                </div>
              </div>
              <button class="btn btn-primary" onclick="showPage('subscription', document.querySelector('[onclick*=subscription]'))" style="padding:10px 20px">Upgrade</button>
            </div>
          </div>
          
          <!-- Overtrading Warning -->
          <div class="card" id="overtradingCard" style="margin-bottom:24px;display:none;border:1px solid var(--accent-yellow)">
            <div style="padding:16px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
              <div style="display:flex;align-items:center;gap:12px">
                <span style="font-size:24px" id="overtradingIcon">‚ö†Ô∏è</span>
                <div>
                  <div style="font-weight:600" id="overtradingText">5 / 5 trades today</div>
                  <div style="font-size:13px;color:var(--text-secondary)" id="overtradingSubtext">You've reached your daily trade limit</div>
                </div>
              </div>
              <div id="overtradingBadge" style="padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600">LIMIT REACHED</div>
            </div>
          </div>
          
          <!-- Daily Goal Progress -->
          <div class="card" id="goalCard" style="margin-bottom:24px;display:none">
            <div style="padding:20px 24px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                <span style="font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px">Today's Performance</span>
                <div id="goalTodayPnl" style="font-family:'JetBrains Mono';font-size:20px;font-weight:600;color:var(--accent-green)">+$0.00</div>
              </div>
              
              <!-- Profit Target -->
              <div id="profitTargetSection" style="margin-bottom:16px;display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                  <span style="font-size:13px;color:var(--text-secondary)">üéØ Profit Target</span>
                  <span id="profitTargetStatus" style="font-size:13px;font-family:'JetBrains Mono'">$0 / $500</span>
                </div>
                <div style="background:var(--bg-elevated);border-radius:6px;height:10px;overflow:hidden">
                  <div id="profitProgressBar" style="height:100%;width:0%;background:var(--gradient-green);border-radius:6px;transition:width 0.5s ease"></div>
                </div>
              </div>
              
              <!-- Loss Limit -->
              <div id="lossLimitSection" style="display:none">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                  <span style="font-size:13px;color:var(--text-secondary)">üõë Loss Limit</span>
                  <span id="lossLimitStatus" style="font-size:13px;font-family:'JetBrains Mono'">$0 / $200</span>
                </div>
                <div style="background:var(--bg-elevated);border-radius:6px;height:10px;overflow:hidden">
                  <div id="lossProgressBar" style="height:100%;width:0%;background:var(--gradient-red);border-radius:6px;transition:width 0.5s ease"></div>
                </div>
              </div>
              
              <!-- Status Message -->
              <div id="goalMessage" style="margin-top:16px;padding:12px;border-radius:var(--radius-sm);display:none">
                <span id="goalMessageText" style="font-size:13px"></span>
              </div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card neutral" id="pnlCard"><div class="stat-label">Total P/L</div><div class="stat-value" id="totalPnl">$0.00</div><div class="stat-change neutral" id="pnlChange">No trades yet</div></div>
            <div class="stat-card neutral"><div class="stat-label">Total Trades</div><div class="stat-value" id="totalTrades">0</div><div class="stat-change neutral" id="tradesChange">Start trading</div></div>
            <div class="stat-card neutral" id="pfCard"><div class="stat-label">Profit Factor</div><div class="stat-value" id="profitFactor">-</div><div class="stat-change neutral" id="pfChange">Need trades</div></div>
            <div class="stat-card neutral" id="avgRCard"><div class="stat-label">Avg R-Multiple</div><div class="stat-value" id="avgR">-</div><div class="stat-change neutral" id="avgRChange">Need trades</div></div>
          </div>
          <div class="content-grid">
            <div class="card">
              <div class="card-header"><h2 class="card-title">Recent Trades</h2><div class="card-actions"><button class="filter-btn active" onclick="setFilter('all', this)">All</button><button class="filter-btn" onclick="setFilter('winners', this)">Winners</button><button class="filter-btn" onclick="setFilter('losers', this)">Losers</button></div></div>
              <div class="trades-table"><div class="table-header"><div>Symbol</div><div>Direction</div><div>Entry</div><div>Exit</div><div>P/L</div><div>R:R</div><div>Action</div></div><div id="tradesContainer"></div></div>
            </div>
            <div class="right-column">
              <div class="card"><div class="card-header"><h2 class="card-title">Equity Curve</h2></div><div class="chart-container" id="chartContainer"><div class="chart-tooltip" id="chartTooltip"><div class="chart-tooltip-trade" id="tooltipTrade">Trade #0</div><div class="chart-tooltip-balance" id="tooltipBalance">$10,000.00</div></div><svg class="chart-svg" id="chartSvg" preserveAspectRatio="xMidYMid meet"><defs><linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:rgba(0,212,161,0.3)"/><stop offset="100%" style="stop-color:rgba(0,212,161,0)"/></linearGradient></defs><g id="chartYAxis"></g><g id="chartXAxis"></g><g class="chart-grid" id="chartGrid"></g><path class="chart-area" id="chartArea" d=""/><path class="chart-line" id="chartLine" d=""/><g id="chartPoints"></g><text id="chartNoData" x="50%" y="50%" text-anchor="middle" fill="#5a5a6a">No data yet</text></svg></div></div>
              <div class="card"><div class="card-header"><h2 class="card-title">Win Rate</h2></div><div class="win-rate-container"><div class="win-rate-ring"><svg width="140" height="140" viewBox="0 0 140 140"><defs><linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#00d4a1"/><stop offset="100%" style="stop-color:#00b890"/></linearGradient></defs><circle class="ring-bg" cx="70" cy="70" r="60"/><circle class="ring-progress" id="winRateRing" cx="70" cy="70" r="60"/></svg><div class="win-rate-value"><div class="win-rate-percent" id="winRatePercent">0%</div><div class="win-rate-label">Win Rate</div></div></div><div class="win-rate-stats"><div class="win-rate-stat"><div class="win-rate-stat-value wins" id="totalWins">0</div><div class="win-rate-stat-label">Wins</div></div><div class="win-rate-stat"><div class="win-rate-stat-value losses" id="totalLosses">0</div><div class="win-rate-stat-label">Losses</div></div></div></div></div>
              <div class="card"><div class="card-header"><h2 class="card-title">Key Metrics</h2></div><div class="quick-stats"><div class="quick-stat-item"><span class="quick-stat-label">Average Win</span><span class="quick-stat-value" style="color:var(--accent-green)" id="avgWin">$0.00</span></div><div class="quick-stat-item"><span class="quick-stat-label">Average Loss</span><span class="quick-stat-value" style="color:var(--accent-red)" id="avgLoss">$0.00</span></div><div class="quick-stat-item"><span class="quick-stat-label">Largest Win</span><span class="quick-stat-value" style="color:var(--accent-green)" id="largestWin">$0.00</span></div><div class="quick-stat-item"><span class="quick-stat-label">Largest Loss</span><span class="quick-stat-value" style="color:var(--accent-red)" id="largestLoss">$0.00</span></div><div class="quick-stat-item"><span class="quick-stat-label">Expectancy</span><span class="quick-stat-value" id="expectancy">$0.00</span></div></div></div>
            </div>
          </div>
        </div>
        <!-- TRADE LOG -->
        <div class="page" id="page-tradelog">
          <header class="header"><div class="header-left"><h1>Trade Log</h1><p>Complete history of all your trades</p></div><div class="header-actions"><button class="btn btn-secondary" onclick="exportTrades()">Export CSV</button><button class="btn btn-primary" onclick="openModal()">+ New Trade</button></div></header>
          <div class="card">
            <div class="card-header"><div class="card-actions"><input type="text" class="search-input" id="searchInput" placeholder="Search symbol..." oninput="renderFullTradeLog()"><button class="filter-btn active" onclick="setLogFilter('all', this)">All</button><button class="filter-btn" onclick="setLogFilter('winners', this)">Winners</button><button class="filter-btn" onclick="setLogFilter('losers', this)">Losers</button></div><span style="font-size:13px;color:var(--text-muted)" id="tradeCount">0 trades</span></div>
            <div id="tagFiltersContainer" style="padding:0 24px 16px;display:none"><div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center"><span style="font-size:12px;color:var(--text-muted);margin-right:4px">Filter by tag:</span><div id="tagFiltersList"></div><button class="tag-filter" id="clearTagFilter" onclick="clearTagFilter()" style="display:none">Clear filter √ó</button></div></div>
            <div class="trades-table full-table"><div class="table-header"><div>#</div><div>Symbol</div><div>Direction</div><div>Entry</div><div>Exit</div><div>P/L</div><div>R:R</div><div>Strategy</div><div>Notes</div><div>Action</div></div><div id="fullTradesContainer"></div></div>
            <div class="pagination"><div class="pagination-info" id="paginationInfo">Showing 0 of 0</div><div class="pagination-btns"><button class="pagination-btn" id="prevPageBtn" onclick="prevPage()" disabled>‚Üê Prev</button><button class="pagination-btn" id="nextPageBtn" onclick="nextPage()" disabled>Next ‚Üí</button></div></div>
          </div>
        </div>
        
        <!-- JOURNAL -->
        <div class="page" id="page-journal">
          <header class="header">
            <div class="header-left">
              <h1>Daily Journal</h1>
              <p>Record your thoughts, market conditions, and daily reflections</p>
            </div>
            <div class="header-actions">
              <button class="btn btn-primary" onclick="openJournalModal()">+ New Entry</button>
            </div>
          </header>
          
          <!-- Today's Quick Entry -->
          <div class="card" style="margin-bottom:24px">
            <div class="card-header">
              <h2 class="card-title">üìù Today's Entry</h2>
              <span style="font-size:13px;color:var(--text-muted)" id="journalTodayDate"></span>
            </div>
            <div style="padding:24px" id="todayJournalContent">
              <div class="empty-state">
                <p>No entry for today yet</p>
                <button class="btn btn-primary" onclick="openJournalModal()" style="margin-top:12px">Write Today's Entry</button>
              </div>
            </div>
          </div>
          
          <!-- Past Entries -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Past Entries</h2>
              <span style="font-size:13px;color:var(--text-muted)" id="journalCount">0 entries</span>
            </div>
            <div style="padding:24px" id="journalEntriesList">
              <div class="empty-state">
                <p>No journal entries yet</p>
                <p style="color:var(--text-muted);font-size:13px;margin-top:8px">Start documenting your trading journey</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ANALYTICS -->
        <div class="page" id="page-analytics">
          <header class="header"><div class="header-left"><h1>Analytics</h1><p>Deep dive into your trading performance</p></div></header>
          <div class="card" id="analyticsLocked"><div class="empty-state"><p><strong>Analytics unlock at 5 trades</strong></p><p id="analyticsProgressText">0 / 5 trades logged</p><div style="margin-top:16px;background:#111;border-radius:10px;height:10px;overflow:hidden;max-width:300px;margin:16px auto 0"><div id="analyticsProgressBar" style="height:100%;width:0%;background:linear-gradient(135deg,#00d4a1,#00b890)"></div></div></div></div>
          <div id="analyticsContent" style="display:none">
            <div class="stats-grid" style="margin-bottom:24px">
              <div class="stat-card positive"><div class="stat-label">Best Trade</div><div class="stat-value" id="anBestTrade" style="color:var(--accent-green)">$0.00</div><div class="stat-change neutral" id="anBestTradeInfo">-</div></div>
              <div class="stat-card negative"><div class="stat-label">Worst Trade</div><div class="stat-value" id="anWorstTrade" style="color:var(--accent-red)">$0.00</div><div class="stat-change neutral" id="anWorstTradeInfo">-</div></div>
              <div class="stat-card neutral"><div class="stat-label">Risk/Reward</div><div class="stat-value" id="anRiskReward">-</div><div class="stat-change neutral" id="anRiskRewardInfo">Avg win / Avg loss</div></div>
              <div class="stat-card purple"><div class="stat-label">Expectancy</div><div class="stat-value" id="anExpectancy">$0.00</div><div class="stat-change neutral">Per trade</div></div>
            </div>
            <div class="card" style="margin-bottom:24px"><div class="card-header"><h2 class="card-title">Win & Loss Streaks</h2></div><div class="streak-display"><div class="streak-item wins"><div class="streak-value" id="anMaxWinStreak">0</div><div class="streak-label">Max Win Streak</div></div><div class="streak-item losses"><div class="streak-value" id="anMaxLossStreak">0</div><div class="streak-label">Max Loss Streak</div></div><div class="streak-item current"><div class="streak-value" id="anCurrentStreak">0</div><div class="streak-label" id="anCurrentStreakLabel">Current Streak</div></div></div></div>
            
            <!-- Drawdown Tracker -->
            <div class="card" style="margin-bottom:24px">
              <div class="card-header"><h2 class="card-title">üìâ Drawdown Tracker</h2></div>
              <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);padding:24px;padding-bottom:0">
                <div class="stat-card negative" style="text-align:center">
                  <div class="stat-label">Max Drawdown</div>
                  <div class="stat-value" id="ddMaxDrawdown" style="color:var(--accent-red)">$0.00</div>
                  <div class="stat-change neutral" id="ddMaxDrawdownPct">0% from peak</div>
                </div>
                <div class="stat-card neutral" style="text-align:center">
                  <div class="stat-label">Current Drawdown</div>
                  <div class="stat-value" id="ddCurrentDrawdown">$0.00</div>
                  <div class="stat-change neutral" id="ddCurrentDrawdownPct">0% from peak</div>
                </div>
                <div class="stat-card positive" style="text-align:center">
                  <div class="stat-label">Peak Balance</div>
                  <div class="stat-value" id="ddPeakBalance" style="color:var(--accent-green)">$0.00</div>
                  <div class="stat-change neutral" id="ddPeakDate">-</div>
                </div>
              </div>
              <div style="padding:24px">
                <div style="background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                    <span style="font-size:12px;color:var(--text-muted)">DRAWDOWN CHART</span>
                    <span style="font-size:12px;color:var(--text-muted)" id="ddRecoveryStatus"></span>
                  </div>
                  <div style="position:relative;height:120px" id="drawdownChartContainer">
                    <canvas id="drawdownChart" style="width:100%;height:100%"></canvas>
                  </div>
                </div>
                <div style="margin-top:16px;display:flex;gap:24px;justify-content:center">
                  <div style="display:flex;align-items:center;gap:8px">
                    <div style="width:12px;height:12px;background:var(--accent-green);border-radius:2px"></div>
                    <span style="font-size:12px;color:var(--text-muted)">Equity</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:8px">
                    <div style="width:12px;height:12px;background:var(--accent-red);border-radius:2px;opacity:0.5"></div>
                    <span style="font-size:12px;color:var(--text-muted)">Drawdown</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="analytics-grid">
              <div class="card"><div class="card-header"><h2 class="card-title">Performance by Day</h2></div><div class="day-heatmap" id="dayHeatmap"></div></div>
              <div class="card"><div class="card-header"><h2 class="card-title">Long vs Short</h2></div><div class="distribution-bars" id="longShortBars"></div></div>
            </div>
            
            <!-- Time of Day Analysis -->
            <div class="card" style="margin-bottom:24px">
              <div class="card-header"><h2 class="card-title">‚è∞ Time of Day Analysis</h2></div>
              <div id="timeAnalysisContent">
                <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);padding:24px;padding-bottom:0">
                  <div class="stat-card positive" style="text-align:center">
                    <div class="stat-label">Best Time</div>
                    <div class="stat-value" id="taBestTime" style="color:var(--accent-green)">-</div>
                    <div class="stat-change neutral" id="taBestTimeInfo">-</div>
                  </div>
                  <div class="stat-card negative" style="text-align:center">
                    <div class="stat-label">Worst Time</div>
                    <div class="stat-value" id="taWorstTime" style="color:var(--accent-red)">-</div>
                    <div class="stat-change neutral" id="taWorstTimeInfo">-</div>
                  </div>
                  <div class="stat-card neutral" style="text-align:center">
                    <div class="stat-label">Trades with Time</div>
                    <div class="stat-value" id="taTradesWithTime">0</div>
                    <div class="stat-change neutral" id="taTradesWithTimePct">0% of total</div>
                  </div>
                </div>
                <div style="padding:24px">
                  <div style="display:flex;gap:16px;margin-bottom:16px">
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:12px;height:12px;background:var(--accent-green);border-radius:2px"></div>
                      <span style="font-size:12px;color:var(--text-muted)">Profitable</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                      <div style="width:12px;height:12px;background:var(--accent-red);border-radius:2px"></div>
                      <span style="font-size:12px;color:var(--text-muted)">Loss</span>
                    </div>
                  </div>
                  <div class="time-heatmap" id="timeHeatmap"></div>
                  <div id="timeNoDataMsg" style="text-align:center;padding:24px;color:var(--text-muted);display:none">
                    <p>Add entry times to your trades to see time-based analysis</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card" style="margin-bottom:24px"><div class="card-header"><h2 class="card-title">Strategy Performance</h2></div><div class="quick-stats" id="strategyPerformance"><div class="empty-state"><p>No strategies recorded</p></div></div></div>
            
            <!-- Tag Performance -->
            <div class="card" style="margin-bottom:24px">
              <div class="card-header"><h2 class="card-title">üè∑Ô∏è Tag Performance</h2></div>
              <div id="tagPerformanceContent">
                <div class="stats-grid" style="grid-template-columns:repeat(2,1fr);padding:24px;padding-bottom:0">
                  <div class="stat-card positive" style="text-align:center">
                    <div class="stat-label">Most Profitable Tag</div>
                    <div class="stat-value" id="tpBestTag" style="color:var(--accent-green);font-size:20px">-</div>
                    <div class="stat-change neutral" id="tpBestTagInfo">-</div>
                  </div>
                  <div class="stat-card negative" style="text-align:center">
                    <div class="stat-label">Worst Performing Tag</div>
                    <div class="stat-value" id="tpWorstTag" style="color:var(--accent-red);font-size:20px">-</div>
                    <div class="stat-change neutral" id="tpWorstTagInfo">-</div>
                  </div>
                </div>
                <div style="padding:24px">
                  <div id="tagPerformanceList"></div>
                  <div id="tagNoDataMsg" style="text-align:center;padding:24px;color:var(--text-muted);display:none">
                    <p>Add tags to your trades to see tag-based analysis</p>
                    <p style="font-size:12px;margin-top:8px">Tags like "FOMO", "A+ Setup", "Revenge" help identify patterns</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Risk Tracking -->
            <div class="card" style="margin-bottom:24px">
              <div class="card-header"><h2 class="card-title">‚ö†Ô∏è Risk Tracking</h2></div>
              <div id="riskTrackingContent">
                <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);padding:24px;padding-bottom:0">
                  <div class="stat-card" id="rtComplianceCard" style="text-align:center">
                    <div class="stat-label">Risk Compliance</div>
                    <div class="stat-value" id="rtCompliance">-</div>
                    <div class="stat-change neutral" id="rtComplianceInfo">Trades within risk limit</div>
                  </div>
                  <div class="stat-card neutral" style="text-align:center">
                    <div class="stat-label">Avg Risk/Trade</div>
                    <div class="stat-value" id="rtAvgRisk">-</div>
                    <div class="stat-change neutral" id="rtAvgRiskPct">-</div>
                  </div>
                  <div class="stat-card" id="rtMaxRiskCard" style="text-align:center">
                    <div class="stat-label">Largest Risk</div>
                    <div class="stat-value" id="rtMaxRisk">-</div>
                    <div class="stat-change neutral" id="rtMaxRiskInfo">-</div>
                  </div>
                  <div class="stat-card neutral" style="text-align:center">
                    <div class="stat-label">Trades with Risk</div>
                    <div class="stat-value" id="rtTradesWithRisk">0</div>
                    <div class="stat-change neutral" id="rtTradesWithRiskPct">-</div>
                  </div>
                </div>
                <div style="padding:24px">
                  <div id="riskComplianceBar" style="margin-bottom:20px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                      <span style="font-size:13px;color:var(--text-secondary)">Risk Compliance Rate</span>
                      <span style="font-size:13px;font-family:'JetBrains Mono'" id="rtComplianceBarPct">0%</span>
                    </div>
                    <div style="background:var(--bg-elevated);border-radius:6px;height:12px;overflow:hidden">
                      <div id="rtComplianceBarFill" style="height:100%;width:0%;background:var(--accent-green);border-radius:6px;transition:width 0.5s ease"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:6px">
                      <span style="font-size:11px;color:var(--text-muted)">Your max risk: <span id="rtMaxRiskSetting">2%</span></span>
                      <span style="font-size:11px;color:var(--text-muted)"><span id="rtViolations">0</span> violations</span>
                    </div>
                  </div>
                  <div id="riskViolationsList"></div>
                  <div id="riskNoDataMsg" style="text-align:center;padding:24px;color:var(--text-muted);display:none">
                    <p>Add risk amount to your trades to track risk compliance</p>
                    <p style="font-size:12px;margin-top:8px">Set your default risk % in Settings</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
              <div class="stat-card neutral"><div class="stat-label">Most Traded</div><div class="stat-value" id="anTopSymbol">-</div><div class="stat-change neutral" id="anTopSymbolCount">0 trades</div></div>
              <div class="stat-card yellow"><div class="stat-label">Trades / Week</div><div class="stat-value" id="anTradesPerWeek">0</div><div class="stat-change neutral">Trading frequency</div></div>
              <div class="stat-card neutral"><div class="stat-label">Consistency</div><div class="stat-value" id="anConsistency">-</div><div class="stat-change neutral" id="anConsistencyInfo">Profitable days %</div></div>
            </div>
          </div>
        </div>
        <!-- PLAYBOOK -->
        <div class="page" id="page-playbook">
          <header class="header">
            <div class="header-left"><h1>Playbook</h1><p>Document and track your trading strategies</p></div>
            <div class="header-actions">
              <button class="btn btn-primary" onclick="openPlaybookModal()">+ New Strategy</button>
            </div>
          </header>
          <div id="playbookList"></div>
          <div class="card" id="playbookEmpty">
            <div class="empty-state">
              <p><strong>No strategies yet</strong></p>
              <p>Create your first strategy to start building your playbook</p>
              <button class="btn btn-primary" style="margin-top:16px" onclick="openPlaybookModal()">+ New Strategy</button>
            </div>
          </div>
        </div>
        <!-- RISK CALCULATOR -->
        <div class="page" id="page-riskcalc">
          <header class="header">
            <div class="header-left"><h1>Risk Calculator</h1><p>Plan your trades with proper position sizing</p></div>
          </header>
          
          <!-- Trading Mode Toggle -->
          <div style="display:flex;gap:8px;margin-bottom:24px">
            <button class="btn btn-primary" id="spotModeBtn" onclick="setTradingMode('spot')" style="flex:1;padding:14px">üìà Spot Trading</button>
            <button class="btn btn-secondary" id="marginModeBtn" onclick="setTradingMode('margin')" style="flex:1;padding:14px">‚ö° Margin / Leverage</button>
          </div>
          
          <div class="analytics-grid">
            <!-- SPOT MODE INPUTS -->
            <div class="card" id="spotInputs">
              <div class="card-header"><h2 class="card-title">Position Size Calculator</h2></div>
              <div class="modal-body">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Account Balance *</label>
                    <input type="number" step="0.01" class="form-input" id="rcAccountBalance" placeholder="10000.00" oninput="calculateRisk()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Risk % Per Trade *</label>
                    <div style="display:flex;gap:8px">
                      <input type="number" step="0.1" class="form-input" id="rcRiskPercent" placeholder="2" oninput="calculateRisk()" style="flex:1">
                      <button class="btn btn-secondary" style="padding:8px 12px;font-size:12px" onclick="setRiskPercent(1)">1%</button>
                      <button class="btn btn-secondary" style="padding:8px 12px;font-size:12px" onclick="setRiskPercent(2)">2%</button>
                      <button class="btn btn-secondary" style="padding:8px 12px;font-size:12px" onclick="setRiskPercent(3)">3%</button>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Entry Price *</label>
                    <input type="number" step="0.01" class="form-input" id="rcEntryPrice" placeholder="150.00" oninput="calculateRisk()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Stop Loss *</label>
                    <input type="number" step="0.01" class="form-input" id="rcStopLoss" placeholder="147.00" oninput="calculateRisk()">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Take Profit (optional)</label>
                    <input type="number" step="0.01" class="form-input" id="rcTakeProfit" placeholder="159.00" oninput="calculateRisk()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Direction</label>
                    <select class="form-select" id="rcDirection" onchange="calculateRisk()">
                      <option value="long">Long</option>
                      <option value="short">Short</option>
                    </select>
                  </div>
                </div>
                <div style="margin-top:8px">
                  <button class="btn btn-secondary" onclick="useCurrentBalance()" style="width:100%">Use Current Account Balance ($<span id="rcCurrentBal">10,000.00</span>)</button>
                </div>
              </div>
            </div>
            
            <!-- MARGIN MODE INPUTS -->
            <div class="card" id="marginInputs" style="display:none">
              <div class="card-header"><h2 class="card-title">Leverage Calculator</h2></div>
              <div class="modal-body">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Position Size ($) *</label>
                    <input type="number" step="0.01" class="form-input" id="rcMarginPositionSize" placeholder="10000" oninput="calculateMarginRisk()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Leverage *</label>
                    <select class="form-select" id="rcLeverage" onchange="calculateMarginRisk()">
                      <option value="2">2x</option>
                      <option value="3">3x</option>
                      <option value="5">5x</option>
                      <option value="10" selected>10x</option>
                      <option value="20">20x</option>
                      <option value="25">25x</option>
                      <option value="50">50x</option>
                      <option value="75">75x</option>
                      <option value="100">100x</option>
                      <option value="125">125x</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Entry Price *</label>
                    <input type="number" step="0.0001" class="form-input" id="rcMarginEntryPrice" placeholder="50000" oninput="calculateMarginRisk()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Direction *</label>
                    <select class="form-select" id="rcMarginDirection" onchange="calculateMarginRisk()">
                      <option value="long">Long</option>
                      <option value="short">Short</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Stop Loss *</label>
                    <input type="number" step="0.0001" class="form-input" id="rcMarginStopLoss" placeholder="49000" oninput="calculateMarginRisk()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Take Profit (optional)</label>
                    <input type="number" step="0.0001" class="form-input" id="rcMarginTakeProfit" placeholder="52000" oninput="calculateMarginRisk()">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- SPOT RESULTS -->
            <div class="card" id="spotResults">
              <div class="card-header"><h2 class="card-title">Results</h2></div>
              <div class="quick-stats" id="rcResults">
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Risk Amount</span>
                  <span class="quick-stat-value" id="rcRiskAmount" style="color:var(--accent-red)">$0.00</span>
                </div>
                <div class="quick-stat-item" id="rcRewardRow" style="display:none">
                  <span class="quick-stat-label">Potential Reward</span>
                  <span class="quick-stat-value" id="rcRewardAmount" style="color:var(--accent-green)">$0.00</span>
                </div>
                <div class="quick-stat-item" id="rcRRRow" style="display:none">
                  <span class="quick-stat-label">Risk/Reward Ratio</span>
                  <span class="quick-stat-value" id="rcRiskReward" style="color:var(--accent-purple)">-</span>
                </div>
              </div>
              <div style="padding:0 24px 24px">
                <div id="rcVisual" style="background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;display:none">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <span style="font-size:12px;color:var(--text-muted)">STOP LOSS</span>
                    <span style="font-size:12px;color:var(--text-muted)">ENTRY</span>
                    <span style="font-size:12px;color:var(--text-muted)">TAKE PROFIT</span>
                  </div>
                  <div style="position:relative;height:24px;background:var(--bg-primary);border-radius:4px;overflow:hidden">
                    <div id="rcRiskBar" style="position:absolute;left:0;height:100%;background:var(--accent-red-dim)"></div>
                    <div id="rcRewardBar" style="position:absolute;right:0;height:100%;background:var(--accent-green-dim)"></div>
                    <div id="rcEntryMarker" style="position:absolute;top:0;bottom:0;width:2px;background:var(--text-primary)"></div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-top:8px">
                    <span id="rcSLPrice" style="font-family:'JetBrains Mono';font-size:12px;color:var(--accent-red)">$0.00</span>
                    <span id="rcEntryPriceLabel" style="font-family:'JetBrains Mono';font-size:12px;color:var(--text-primary)">$0.00</span>
                    <span id="rcTPPrice" style="font-family:'JetBrains Mono';font-size:12px;color:var(--accent-green)">$0.00</span>
                  </div>
                </div>
                <div id="rcWarning" style="margin-top:16px;padding:12px;background:var(--accent-red-dim);border-radius:var(--radius-sm);display:none">
                  <span style="font-size:13px;color:var(--accent-red)" id="rcWarningText">Warning message</span>
                </div>
              </div>
            </div>
            
            <!-- MARGIN RESULTS -->
            <div class="card" id="marginResults" style="display:none">
              <div class="card-header"><h2 class="card-title">Results</h2></div>
              <div class="quick-stats">
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Margin Required</span>
                  <span class="quick-stat-value" id="rcMarginRequired" style="color:var(--accent-blue)">$0.00</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Position Value</span>
                  <span class="quick-stat-value" id="rcMarginPositionValue">$0.00</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Risk Amount</span>
                  <span class="quick-stat-value" id="rcMarginRiskAmount" style="color:var(--accent-red)">$0.00</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Risk %</span>
                  <span class="quick-stat-value" id="rcMarginRiskPercent" style="color:var(--accent-red)">0%</span>
                </div>
                <div class="quick-stat-item" id="rcMarginRewardRow" style="display:none">
                  <span class="quick-stat-label">Potential Profit</span>
                  <span class="quick-stat-value" id="rcMarginRewardAmount" style="color:var(--accent-green)">$0.00</span>
                </div>
                <div class="quick-stat-item" id="rcMarginRRRow" style="display:none">
                  <span class="quick-stat-label">Risk/Reward Ratio</span>
                  <span class="quick-stat-value" id="rcMarginRiskReward" style="color:var(--accent-purple)">-</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Liquidation Price (est.)</span>
                  <span class="quick-stat-value" id="rcLiquidationPrice" style="color:var(--accent-yellow)">$0.00</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Distance to Liquidation</span>
                  <span class="quick-stat-value" id="rcLiquidationDistance">0%</span>
                </div>
              </div>
              <div style="padding:0 24px 24px">
                <div id="rcMarginVisual" style="background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;display:none">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <span style="font-size:12px;color:var(--text-muted)" id="rcMarginLeftLabel">LIQUIDATION</span>
                    <span style="font-size:12px;color:var(--text-muted)">ENTRY</span>
                    <span style="font-size:12px;color:var(--text-muted)" id="rcMarginRightLabel">TAKE PROFIT</span>
                  </div>
                  <div style="position:relative;height:24px;background:var(--bg-primary);border-radius:4px;overflow:hidden">
                    <div id="rcMarginRiskBar" style="position:absolute;left:0;height:100%;background:var(--accent-red-dim)"></div>
                    <div id="rcMarginRewardBar" style="position:absolute;right:0;height:100%;background:var(--accent-green-dim)"></div>
                    <div id="rcMarginSLMarker" style="position:absolute;top:0;bottom:0;width:2px;background:var(--accent-yellow)"></div>
                    <div id="rcMarginEntryMarker" style="position:absolute;top:0;bottom:0;width:2px;background:var(--text-primary)"></div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-top:8px">
                    <span id="rcMarginLiqPrice" style="font-family:'JetBrains Mono';font-size:12px;color:var(--accent-red)">$0.00</span>
                    <span id="rcMarginEntryLabel" style="font-family:'JetBrains Mono';font-size:12px;color:var(--text-primary)">$0.00</span>
                    <span id="rcMarginTPLabel" style="font-family:'JetBrains Mono';font-size:12px;color:var(--accent-green)">$0.00</span>
                  </div>
                </div>
                <div id="rcMarginWarning" style="margin-top:16px;padding:12px;background:var(--accent-red-dim);border-radius:var(--radius-sm);display:none">
                  <span style="font-size:13px;color:var(--accent-red)" id="rcMarginWarningText">Warning message</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Quick Reference - Updates based on mode -->
          <div class="card" style="margin-top:24px" id="spotReference">
            <div class="card-header"><h2 class="card-title">Quick Reference</h2></div>
            <div class="quick-stats">
              <div class="quick-stat-item">
                <span class="quick-stat-label">1% Risk Rule</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">Conservative - recommended for beginners</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">2% Risk Rule</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">Standard - most common among traders</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">3%+ Risk</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">Aggressive - higher drawdown potential</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">Ideal R:R</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">1:2 or better (risk $1 to make $2+)</span>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top:24px;display:none" id="marginReference">
            <div class="card-header"><h2 class="card-title">Leverage Quick Reference</h2></div>
            <div class="quick-stats">
              <div class="quick-stat-item">
                <span class="quick-stat-label">2x - 5x</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">Conservative - suitable for swing trades</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">10x - 20x</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">Moderate - common for day trading</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">50x+</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--text-secondary)">High risk - scalping only, tight stops required</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">‚ö†Ô∏è Warning</span>
                <span class="quick-stat-value" style="font-size:13px;color:var(--accent-yellow)">Higher leverage = closer liquidation price</span>
              </div>
            </div>
          </div>
        </div>
        <!-- CALENDAR -->
        <div class="page" id="page-calendar">
          <header class="header">
            <div class="header-left"><h1>Calendar</h1><p>View your daily P/L at a glance</p></div>
            <div class="header-actions">
              <button class="btn btn-secondary" onclick="prevMonth()">‚Üê Prev</button>
              <button class="btn btn-secondary" onclick="nextMonth()">Next ‚Üí</button>
            </div>
          </header>
          <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px">
            <div class="stat-card neutral" id="calPnlCard"><div class="stat-label">Month P/L</div><div class="stat-value" id="calMonthPnl">$0.00</div><div class="stat-change neutral" id="calMonthTrades">0 trades</div></div>
            <div class="stat-card positive"><div class="stat-label">Profitable Days</div><div class="stat-value" id="calProfitDays">0</div><div class="stat-change neutral" id="calProfitDaysInfo">-</div></div>
            <div class="stat-card negative"><div class="stat-label">Losing Days</div><div class="stat-value" id="calLossDays">0</div><div class="stat-change neutral" id="calLossDaysInfo">-</div></div>
          </div>
          <div class="card">
            <div class="card-header"><h2 class="card-title" id="calMonthTitle">January 2025</h2></div>
            <div class="calendar-container">
              <div class="calendar-header-row">
                <div class="calendar-day-name">Sun</div>
                <div class="calendar-day-name">Mon</div>
                <div class="calendar-day-name">Tue</div>
                <div class="calendar-day-name">Wed</div>
                <div class="calendar-day-name">Thu</div>
                <div class="calendar-day-name">Fri</div>
                <div class="calendar-day-name">Sat</div>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
            </div>
          </div>
          <div class="card" style="margin-top:24px">
            <div class="card-header"><h2 class="card-title">Daily Breakdown</h2></div>
            <div class="quick-stats" id="calDailyBreakdown"><div class="empty-state"><p>Select a day to see details</p></div></div>
          </div>
        </div>
        <!-- SETTINGS -->
        <div class="page" id="page-settings">
          <header class="header">
            <div class="header-left"><h1>Settings</h1><p>Customize your trading journal</p></div>
          </header>
          <div class="analytics-grid">
            <div class="card">
              <div class="card-header"><h2 class="card-title">Account Settings</h2></div>
              <div class="modal-body">
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Theme</label>
                  <div style="display:flex;gap:12px">
                    <button class="btn" id="themeDarkBtn" onclick="setTheme('dark')" style="flex:1;padding:12px">üåô Dark <span id="darkPremiumBadge" style="font-size:10px;background:var(--accent-purple);color:white;padding:2px 6px;border-radius:10px;margin-left:4px">PRO</span></button>
                    <button class="btn" id="themeLightBtn" onclick="setTheme('light')" style="flex:1;padding:12px">‚òÄÔ∏è Light</button>
                  </div>
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Starting Balance</label>
                  <input type="number" step="0.01" class="form-input" id="setStartingBalance" placeholder="10000.00">
                  <p style="font-size:12px;color:var(--text-muted);margin-top:6px">This is used to calculate your % returns</p>
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Currency Symbol</label>
                  <select class="form-select" id="setCurrency">
                    <option value="$">$ USD</option>
                    <option value="‚Ç¨">‚Ç¨ EUR</option>
                    <option value="¬£">¬£ GBP</option>
                    <option value="¬•">¬• JPY</option>
                    <option value="‚Çπ">‚Çπ INR</option>
                    <option value="A$">A$ AUD</option>
                    <option value="C$">C$ CAD</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="saveAccountSettings()" style="width:100%">Save Account Settings</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><h2 class="card-title">Default Trade Settings</h2></div>
              <div class="modal-body">
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Default Risk %</label>
                  <input type="number" step="0.1" class="form-input" id="setDefaultRisk" placeholder="2">
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Default Direction</label>
                  <select class="form-select" id="setDefaultDirection">
                    <option value="long">Long</option>
                    <option value="short">Short</option>
                  </select>
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Default Strategy</label>
                  <select class="form-select" id="setDefaultStrategy">
                    <option value="">None</option>
                    <option value="breakout">Breakout</option>
                    <option value="pullback">Pullback</option>
                    <option value="reversal">Reversal</option>
                    <option value="momentum">Momentum</option>
                    <option value="scalp">Scalp</option>
                    <option value="swing">Swing</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="saveDefaultSettings()" style="width:100%">Save Default Settings</button>
              </div>
            </div>
          </div>
          <div class="analytics-grid" style="margin-top:24px">
            <div class="card">
              <div class="card-header"><h2 class="card-title">Trading Goals</h2></div>
              <div class="modal-body">
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Daily Profit Target</label>
                  <input type="number" step="0.01" class="form-input" id="setDailyTarget" placeholder="500" oninput="updateGoalLive()">
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Max Daily Loss</label>
                  <input type="number" step="0.01" class="form-input" id="setMaxDailyLoss" placeholder="200" oninput="updateGoalLive()">
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Max Trades Per Day</label>
                  <input type="number" class="form-input" id="setMaxTradesPerDay" placeholder="5">
                  <p style="font-size:11px;color:var(--text-muted);margin-top:4px">Prevent overtrading (0 = unlimited)</p>
                </div>
                <div class="form-group" style="margin-bottom:20px">
                  <label class="form-label">Monthly Profit Target</label>
                  <input type="number" step="0.01" class="form-input" id="setMonthlyTarget" placeholder="5000">
                </div>
                <button class="btn btn-primary" onclick="saveGoalSettings()" style="width:100%">Save Goals</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><h2 class="card-title">Data Management</h2></div>
              <div class="modal-body">
                <div style="margin-bottom:20px">
                  <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Export all your data (trades, playbook, settings) as a backup file</p>
                  <button class="btn btn-secondary" onclick="exportAllData()" style="width:100%">üì• Export Full Backup</button>
                </div>
                <div style="margin-bottom:20px">
                  <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Import data from a backup file</p>
                  <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAllData(event)">
                  <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="width:100%">üì§ Import Backup</button>
                </div>
                <div style="border-top:1px solid var(--border-subtle);padding-top:20px;margin-top:20px">
                  <p style="font-size:13px;color:var(--accent-red);margin-bottom:12px">‚ö†Ô∏è Danger Zone</p>
                  <div style="display:flex;gap:12px">
                    <button class="btn btn-secondary" onclick="clearAllTrades()" style="flex:1;border-color:var(--accent-red);color:var(--accent-red)">Clear Trades</button>
                    <button class="btn btn-secondary" onclick="clearPlaybook()" style="flex:1;border-color:var(--accent-red);color:var(--accent-red)">Clear Playbook</button>
                  </div>
                  <button class="btn btn-secondary" onclick="resetEverything()" style="width:100%;margin-top:12px;border-color:var(--accent-red);color:var(--accent-red)">üóëÔ∏è Reset Everything</button>
                </div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-top:24px">
            <div class="card-header"><h2 class="card-title">Current Stats</h2></div>
            <div class="quick-stats">
              <div class="quick-stat-item">
                <span class="quick-stat-label">Total Trades Logged</span>
                <span class="quick-stat-value" id="setTotalTrades">0</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">Playbook Strategies</span>
                <span class="quick-stat-value" id="setTotalStrategies">0</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">Data Storage Used</span>
                <span class="quick-stat-value" id="setStorageUsed">0 KB</span>
              </div>
              <div class="quick-stat-item">
                <span class="quick-stat-label">Journal Version</span>
                <span class="quick-stat-value" style="color:var(--accent-green)">PipJournal v1.0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- SUBSCRIPTION PAGE -->
        <div class="page" id="page-subscription">
          <header class="header">
            <div class="header-left">
              <h1>Subscription</h1>
              <p>Manage your plan and unlock premium features</p>
            </div>
          </header>

          <!-- Current Plan Status -->
          <div class="card" id="currentPlanCard" style="margin-bottom:24px">
            <div style="padding:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
              <div>
                <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Current Plan</div>
                <div style="display:flex;align-items:center;gap:12px">
                  <span id="currentPlanName" style="font-size:28px;font-weight:700">Free</span>
                  <span id="currentPlanBadge" class="trade-direction" style="background:var(--bg-elevated);color:var(--text-secondary)">Basic</span>
                </div>
              </div>
              <div id="usageDisplay" style="text-align:right">
                <div style="font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px">Monthly Usage</div>
                <div style="font-family:'JetBrains Mono';font-size:24px;font-weight:600"><span id="tradesUsed">0</span> / <span id="tradesLimit">10</span></div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px">trades this month</div>
              </div>
            </div>
            <div style="padding:0 24px 24px">
              <div style="background:var(--bg-elevated);border-radius:6px;height:8px;overflow:hidden">
                <div id="usageProgressBar" style="height:100%;width:0%;background:var(--gradient-green);border-radius:6px;transition:width 0.5s ease"></div>
              </div>
            </div>
          </div>

          <!-- Pricing Cards -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:24px;margin-bottom:24px">
            
            <!-- Free Plan -->
            <div class="card" id="freePlanCard" style="position:relative;overflow:hidden">
              <div style="padding:32px">
                <div style="font-size:14px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Free</div>
                <div style="display:flex;align-items:baseline;gap:4px;margin-bottom:8px">
                  <span style="font-size:48px;font-weight:700">$0</span>
                  <span style="color:var(--text-muted)">/month</span>
                </div>
                <p style="color:var(--text-secondary);margin-bottom:24px">Perfect for getting started with trade journaling</p>
                
                <div style="space-y:12px">
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>10 trades per month</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Basic analytics</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Risk calculator</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--text-muted)">‚úó</span>
                    <span style="color:var(--text-muted)">Dark mode theme</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--text-muted)">‚úó</span>
                    <span style="color:var(--text-muted)">Unlimited trades</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--text-muted)">‚úó</span>
                    <span style="color:var(--text-muted)">Chart screenshots</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0">
                    <span style="color:var(--text-muted)">‚úó</span>
                    <span style="color:var(--text-muted)">Advanced analytics</span>
                  </div>
                </div>
                
                <button id="freeSelectBtn" class="btn btn-secondary" style="width:100%;margin-top:24px;padding:14px" onclick="selectPlan('free')">Current Plan</button>
              </div>
            </div>

            <!-- Premium Plan -->
            <div class="card" id="premiumPlanCard" style="position:relative;overflow:hidden;border:2px solid var(--accent-green)">
              <div style="position:absolute;top:16px;right:16px;background:var(--gradient-green);color:var(--bg-primary);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600">POPULAR</div>
              <div style="padding:32px">
                <div style="font-size:14px;color:var(--accent-green);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Premium</div>
                <div style="display:flex;align-items:baseline;gap:4px;margin-bottom:8px">
                  <span style="font-size:48px;font-weight:700">$9</span>
                  <span style="color:var(--text-muted)">/month</span>
                </div>
                <p style="color:var(--text-secondary);margin-bottom:24px">For serious traders who want to level up</p>
                
                <div style="space-y:12px">
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span><strong>Unlimited</strong> trades</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Dark mode theme</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Advanced analytics</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Chart screenshots</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Playbook strategies</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Calendar view</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;padding:8px 0">
                    <span style="color:var(--accent-green)">‚úì</span>
                    <span>Priority support</span>
                  </div>
                </div>
                
                <button id="premiumSelectBtn" class="btn btn-primary" style="width:100%;margin-top:24px;padding:14px" onclick="selectPlan('premium')">Upgrade to Premium</button>
              </div>
            </div>
          </div>

          <!-- Dev Testing Toggle -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">üß™ Developer Testing</h2>
            </div>
            <div style="padding:24px">
              <p style="color:var(--text-secondary);margin-bottom:16px">This toggle is for testing purposes only. It will be removed when real payment processing is connected.</p>
              <div style="display:flex;align-items:center;gap:16px">
                <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
                  <input type="checkbox" id="devPremiumToggle" onchange="toggleDevPremium()" style="width:20px;height:20px;cursor:pointer">
                  <span>Simulate Premium Subscription</span>
                </label>
              </div>
            </div>
          </div>
        </div>
    </main>
  </div>

  <!-- Trade Details Modal -->
  <div class="modal-overlay" id="tradeDetailsModal" onclick="if(event.target===this)closeTradeDetails()">
    <div class="modal">
      <div class="modal-header">
        <div style="display:flex;align-items:center;gap:16px">
          <h3 class="modal-title" id="detailsTitle">Trade Details</h3>
          <span class="trade-direction" id="detailsDirection">‚Üë Long</span>
        </div>
        <button class="modal-close" onclick="closeTradeDetails()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px">
          <div>
            <div style="font-size:14px;color:var(--text-muted);margin-bottom:4px" id="detailsDate">Jan 15, 2025</div>
            <div style="font-size:14px;color:var(--text-secondary)" id="detailsStrategy">Strategy: Breakout</div>
            <div style="margin-top:8px" id="detailsRating"></div>
            <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px" id="detailsTags"></div>
          </div>
          <div style="text-align:right">
            <div style="font-size:14px;color:var(--text-muted);margin-bottom:4px">Profit / Loss</div>
            <div style="font-family:'JetBrains Mono';font-size:36px;font-weight:700" id="detailsPnl">+$500.00</div>
            <div style="font-family:'JetBrains Mono';font-size:16px;margin-top:4px" id="detailsRMultiple">+2.50R</div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:32px">
          <div class="stat-card neutral" style="text-align:center">
            <div class="stat-label">Entry Price</div>
            <div class="stat-value" id="detailsEntry" style="font-size:20px">$150.00</div>
          </div>
          <div class="stat-card neutral" style="text-align:center">
            <div class="stat-label">Exit Price</div>
            <div class="stat-value" id="detailsExit" style="font-size:20px">$155.00</div>
          </div>
          <div class="stat-card neutral" style="text-align:center">
            <div class="stat-label">Quantity</div>
            <div class="stat-value" id="detailsQuantity" style="font-size:20px">100</div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:32px">
          <div class="stat-card neutral" style="text-align:center">
            <div class="stat-label">Stop Loss</div>
            <div class="stat-value" id="detailsStopLoss" style="font-size:20px">$148.00</div>
          </div>
          <div class="stat-card neutral" style="text-align:center">
            <div class="stat-label">Risk Amount</div>
            <div class="stat-value" id="detailsRiskAmount" style="font-size:20px">$200.00</div>
          </div>
        </div>
        
        <div id="detailsNotesSection" style="margin-bottom:32px">
          <div style="font-size:13px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Notes</div>
          <div style="background:var(--bg-elevated);border-radius:var(--radius-md);padding:20px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap" id="detailsNotes">No notes for this trade.</div>
        </div>
        
        <div id="detailsImageSection" style="margin-bottom:32px;display:none">
          <div style="font-size:13px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Chart Screenshot</div>
          <div style="background:var(--bg-elevated);border-radius:var(--radius-md);padding:16px;cursor:pointer" onclick="viewTradeImage(currentViewingTradeId)">
            <img id="detailsImage" style="width:100%;border-radius:var(--radius-sm)" src="" alt="Trade Screenshot">
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:space-between">
        <button class="btn btn-secondary" onclick="deleteTradeFromDetails()" style="border-color:var(--accent-red);color:var(--accent-red)">üóëÔ∏è Delete Trade</button>
        <div style="display:flex;gap:12px">
          <button class="btn btn-secondary" onclick="closeTradeDetails()" style="padding:14px 28px;font-size:15px">Close</button>
          <button class="btn btn-primary" onclick="editTradeFromDetails()" style="padding:14px 28px;font-size:15px">‚úèÔ∏è Edit Trade</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="tradeModal" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Log New Trade</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
      <div class="modal-body">
        <div class="form-row"><div class="form-group"><label class="form-label">Symbol *</label><input type="text" class="form-input" id="symbol" placeholder="AAPL"></div><div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-input" id="tradeDate"></div><div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="tradeTime" placeholder="09:30"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Direction *</label><select class="form-select" id="direction"><option value="long">Long</option><option value="short">Short</option></select></div><div class="form-group"><label class="form-label">P/L (Profit/Loss) *</label><input type="number" step="0.01" class="form-input" id="tradePnl" placeholder="500 or -200"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Entry Price</label><input type="number" step="0.01" class="form-input" id="entryPrice" placeholder="150.00"></div><div class="form-group"><label class="form-label">Exit Price</label><input type="number" step="0.01" class="form-input" id="exitPrice" placeholder="155.00"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Quantity</label><input type="number" class="form-input" id="quantity" placeholder="100"></div><div class="form-group"><label class="form-label">Stop Loss</label><input type="number" step="0.01" class="form-input" id="stopLoss" placeholder="148.00"></div></div>
        <div class="form-row"><div class="form-group"><label class="form-label">Strategy</label><select class="form-select" id="strategy" onchange="onStrategyChange()"></select></div><div class="form-group"><label class="form-label">Risk Amount</label><input type="number" step="0.01" class="form-input" id="riskAmount" placeholder="100.00"><p style="font-size:10px;color:var(--text-muted);margin-top:4px">For R-multiple calculation</p></div></div>
        <div id="tradeChecklistContainer" style="display:none">
          <div class="trade-checklist">
            <div class="trade-checklist-title">üìã Entry Rules Checklist</div>
            <div id="tradeChecklistItems"></div>
            <div id="checklistWarning" style="margin-top:12px;padding:10px;background:var(--accent-yellow);background:rgba(255,193,7,0.15);border-radius:var(--radius-sm);display:none">
              <span style="font-size:12px;color:#e6a800">‚ö†Ô∏è Not all entry rules are checked. Are you sure this trade follows your strategy?</span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label class="form-label">Tags</label>
            <div id="tradeTagsContainer" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px"></div>
            <div style="display:flex;gap:8px">
              <input type="text" class="form-input" id="newTagInput" placeholder="Add tag (e.g., FOMO, A+ setup)" style="flex:1" onkeypress="if(event.key==='Enter'){addTradeTag();event.preventDefault();}">
              <button type="button" class="btn btn-secondary" onclick="addTradeTag()" style="padding:8px 16px">+ Add</button>
            </div>
            <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">
              <span class="quick-tag" onclick="addQuickTag('A+ Setup')">A+ Setup</span>
              <span class="quick-tag" onclick="addQuickTag('FOMO')">FOMO</span>
              <span class="quick-tag" onclick="addQuickTag('Revenge')">Revenge</span>
              <span class="quick-tag" onclick="addQuickTag('Oversize')">Oversize</span>
              <span class="quick-tag" onclick="addQuickTag('Earnings')">Earnings</span>
              <span class="quick-tag" onclick="addQuickTag('News')">News</span>
              <span class="quick-tag" onclick="addQuickTag('Scalp')">Scalp</span>
              <span class="quick-tag" onclick="addQuickTag('Swing')">Swing</span>
            </div>
          </div>
        </div>
        <div class="form-row"><div class="form-group full-width"><label class="form-label">Notes</label><textarea class="form-textarea" id="notes" placeholder="Trade notes..."></textarea></div></div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Trade Rating</label>
            <div class="star-rating" id="tradeRating">
              <span class="star" data-rating="1" onclick="setTradeRating(1)">‚òÖ</span>
              <span class="star" data-rating="2" onclick="setTradeRating(2)">‚òÖ</span>
              <span class="star" data-rating="3" onclick="setTradeRating(3)">‚òÖ</span>
              <span class="star" data-rating="4" onclick="setTradeRating(4)">‚òÖ</span>
              <span class="star" data-rating="5" onclick="setTradeRating(5)">‚òÖ</span>
            </div>
            <p style="font-size:10px;color:var(--text-muted);margin-top:4px">Rate your trade execution (1-5 stars)</p>
          </div>
          <div class="form-group">
            <label class="form-label">Chart Screenshot</label>
            <div id="imagePreviewContainer" style="display:none;margin-bottom:12px;position:relative"><img id="imagePreview" style="max-width:100%;max-height:200px;border-radius:var(--radius-sm);border:1px solid var(--border)"><button type="button" onclick="removeTradeImage()" style="position:absolute;top:8px;right:8px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);width:28px;height:28px;cursor:pointer;font-size:16px">√ó</button></div>
            <input type="file" id="tradeImage" accept="image/*" style="display:none" onchange="previewTradeImage(event)">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('tradeImage').click()" style="width:100%">üì∑ Add Screenshot</button>
            <p style="font-size:10px;color:var(--text-muted);margin-top:4px">PNG, JPG up to 5MB</p>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()" style="padding:14px 28px;font-size:15px">Cancel</button><button class="btn btn-primary" onclick="saveTrade()" style="padding:14px 36px;font-size:15px">Save Trade</button></div>
    </div>
  </div>
  <!-- Toast -->
  <div class="toast" id="toast"><div class="toast-text" id="toastText">Trade deleted.</div><div class="toast-actions"><button class="toast-btn undo" id="toastUndo">Undo</button><button class="toast-btn" id="toastDismiss">√ó</button></div></div>

  <!-- Journal Modal -->
  <div class="modal-overlay" id="journalModal" onclick="if(event.target===this)closeJournalModal()">
    <div class="modal" style="max-width:700px">
      <div class="modal-header">
        <h3 class="modal-title" id="journalModalTitle">New Journal Entry</h3>
        <button class="modal-close" onclick="closeJournalModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" id="journalDate">
          </div>
          <div class="form-group">
            <label class="form-label">Mood</label>
            <div class="mood-selector">
              <button type="button" class="mood-btn" data-mood="great" onclick="setJournalMood('great')">üòÑ</button>
              <button type="button" class="mood-btn" data-mood="good" onclick="setJournalMood('good')">üôÇ</button>
              <button type="button" class="mood-btn" data-mood="neutral" onclick="setJournalMood('neutral')">üòê</button>
              <button type="button" class="mood-btn" data-mood="bad" onclick="setJournalMood('bad')">üòû</button>
              <button type="button" class="mood-btn" data-mood="terrible" onclick="setJournalMood('terrible')">üò´</button>
            </div>
          </div>
        </div>
        
        <div class="journal-section">
          <div class="journal-section-title">üåÖ Pre-Market Thoughts</div>
          <textarea class="journal-textarea" id="journalPreMarket" placeholder="What's your plan for today? Any key levels or setups you're watching?"></textarea>
        </div>
        
        <div class="journal-section">
          <div class="journal-section-title">üìä Market Conditions</div>
          <textarea class="journal-textarea" id="journalMarketConditions" placeholder="How is the overall market? Trending, choppy, news events?" style="min-height:80px"></textarea>
        </div>
        
        <div class="journal-section">
          <div class="journal-section-title">üåô End of Day Reflection</div>
          <textarea class="journal-textarea" id="journalReflection" placeholder="What went well? What could you improve? Did you follow your rules?"></textarea>
        </div>
        
        <div class="journal-section">
          <div class="journal-section-title">üí° Lessons Learned</div>
          <textarea class="journal-textarea" id="journalLessons" placeholder="Key takeaways from today..." style="min-height:80px"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeJournalModal()" style="padding:14px 28px">Cancel</button>
        <button class="btn btn-primary" onclick="saveJournalEntry()" style="padding:14px 36px">Save Entry</button>
      </div>
    </div>
  </div>

  <!-- Playbook Modal -->
  <div class="modal-overlay" id="playbookModal" onclick="if(event.target===this)closePlaybookModal()">
    <div class="modal" style="max-width:640px">
      <div class="modal-header">
        <h3 class="modal-title" id="playbookModalTitle">New Strategy</h3>
        <button class="modal-close" onclick="closePlaybookModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Strategy Name *</label>
            <input type="text" class="form-input" id="pbName" placeholder="e.g., Bull Flag Breakout">
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="pbCategory">
              <option value="breakout">Breakout</option>
              <option value="pullback">Pullback</option>
              <option value="reversal">Reversal</option>
              <option value="momentum">Momentum</option>
              <option value="scalp">Scalp</option>
              <option value="swing">Swing</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="pbDescription" placeholder="What does this setup look like? What are the key characteristics?"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label class="form-label">Entry Rules Checklist</label>
            <div id="entryRulesChecklist" style="background:var(--bg-elevated);border-radius:var(--radius-sm);padding:12px;margin-bottom:8px">
              <div id="entryRulesList"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input type="text" class="form-input" id="newEntryRule" placeholder="Add a rule (e.g., Price above VWAP)" style="flex:1" onkeypress="if(event.key==='Enter'){addEntryRule();event.preventDefault();}">
                <button class="btn btn-secondary" onclick="addEntryRule()" style="padding:8px 16px">+ Add</button>
              </div>
            </div>
            <p style="font-size:11px;color:var(--text-muted)">These rules will appear as a checklist when logging trades with this strategy</p>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Stop Loss Rules</label>
            <textarea class="form-textarea" id="pbStopLoss" placeholder="Where do you place your stop?" style="min-height:60px"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Take Profit Rules</label>
            <textarea class="form-textarea" id="pbTakeProfit" placeholder="Where do you take profits?" style="min-height:60px"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Best Conditions</label>
            <textarea class="form-textarea" id="pbBestConditions" placeholder="Market type, time of day, volatility..." style="min-height:60px"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Avoid When</label>
            <textarea class="form-textarea" id="pbAvoidWhen" placeholder="When should you NOT take this setup?" style="min-height:60px"></textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label class="form-label">Notes / Lessons Learned</label>
            <textarea class="form-textarea" id="pbNotes" placeholder="Any additional notes, tips, or lessons..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePlaybookModal()">Cancel</button>
        <button class="btn btn-primary" id="pbSaveBtn" onclick="savePlaybookEntry()">Save Strategy</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close" onclick="closeImageModal()">√ó</button>
    <img id="imageModalImg" src="" alt="Trade Screenshot">
  </div>

<script>
// ===== SUPABASE SETUP =====
var SUPABASE_URL = 'https://bmnizamjxqpbcrgmlzlv.supabase.co';
var SUPABASE_ANON_KEY = 'sb_publishable_q--yXqMEYeIAzsqdJQTcow_-qqggOJ5';
var supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
var currentUser = null;
var isOnlineMode = false;
var isSyncing = false;
var authMode = 'login'; // 'login' or 'signup'

// ===== AUTH FUNCTIONS =====
function toggleAuthMode(e) {
  if (e) e.preventDefault();
  authMode = authMode === 'login' ? 'signup' : 'login';
  document.getElementById('authSubmitBtn').textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
  document.getElementById('authToggleText').textContent = authMode === 'login' ? "Don't have an account?" : 'Already have an account?';
  document.getElementById('authToggleLink').textContent = authMode === 'login' ? 'Sign Up' : 'Sign In';
  document.getElementById('authSubtitle').textContent = authMode === 'login' ? 'Sign in to sync your trades across devices' : 'Create an account to sync your trades';
  hideAuthError();
  hideAuthSuccess();
}

function showAuthError(msg) {
  var el = document.getElementById('authError');
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('authSuccess').style.display = 'none';
}

function hideAuthError() { document.getElementById('authError').style.display = 'none'; }

function showAuthSuccess(msg) {
  var el = document.getElementById('authSuccess');
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('authError').style.display = 'none';
}

function hideAuthSuccess() { document.getElementById('authSuccess').style.display = 'none'; }

async function handleAuth() {
  var email = document.getElementById('authEmail').value.trim();
  var password = document.getElementById('authPassword').value;
  
  if (!email || !password) { showAuthError('Please enter email and password'); return; }
  if (password.length < 6) { showAuthError('Password must be at least 6 characters'); return; }
  
  var btn = document.getElementById('authSubmitBtn');
  btn.disabled = true;
  btn.textContent = authMode === 'login' ? 'Signing in...' : 'Creating account...';
  hideAuthError();
  
  try {
    if (!supabase) throw new Error('Supabase not loaded');
    
    var result;
    if (authMode === 'signup') {
      result = await supabase.auth.signUp({ email: email, password: password });
      if (result.error) throw result.error;
      if (result.data.user && !result.data.session) {
        showAuthSuccess('Check your email for a confirmation link!');
        btn.disabled = false;
        btn.textContent = 'Create Account';
        return;
      }
    } else {
      result = await supabase.auth.signInWithPassword({ email: email, password: password });
      if (result.error) throw result.error;
    }
    
    currentUser = result.data.user;
    isOnlineMode = true;
    await onAuthSuccess();
  } catch (err) {
    var msg = err.message || 'Authentication failed';
    if (msg.includes('Invalid login')) msg = 'Invalid email or password';
    if (msg.includes('already registered')) msg = 'Email already registered. Try signing in.';
    showAuthError(msg);
    btn.disabled = false;
    btn.textContent = authMode === 'login' ? 'Sign In' : 'Create Account';
  }
}

function continueOffline() {
  isOnlineMode = false;
  currentUser = null;
  hideAuthOverlay();
  loadFromLocalStorage();
  initApp();
}

async function onAuthSuccess() {
  hideAuthOverlay();
  updateUserUI();
  await loadFromCloud();
  initApp();
}

function hideAuthOverlay() {
  var overlay = document.getElementById('authOverlay');
  overlay.style.opacity = '0';
  setTimeout(function() { overlay.style.display = 'none'; }, 300);
}

function showAuthOverlay() {
  var overlay = document.getElementById('authOverlay');
  overlay.style.display = 'flex';
  overlay.style.opacity = '1';
}

function updateUserUI() {
  if (!currentUser) {
    document.getElementById('userBar').style.display = 'none';
    document.getElementById('syncIndicator').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    return;
  }
  var email = currentUser.email || '';
  document.getElementById('userBar').style.display = 'flex';
  document.getElementById('userAvatar').textContent = email.charAt(0).toUpperCase();
  document.getElementById('userEmail').textContent = email;
  document.getElementById('userPlan').textContent = isPremium() ? 'Premium' : 'Free';
  document.getElementById('syncIndicator').style.display = 'flex';
  document.getElementById('logoutBtn').style.display = 'block';
  updateSyncStatus('synced');
}

function updateSyncStatus(status) {
  var dot = document.getElementById('syncDot');
  var text = document.getElementById('syncText');
  dot.className = 'sync-dot';
  if (status === 'syncing') { dot.classList.add('syncing'); text.textContent = 'Syncing...'; }
  else if (status === 'offline') { dot.classList.add('offline'); text.textContent = 'Offline'; }
  else { text.textContent = 'Synced'; }
}

async function handleLogout() {
  if (!confirm('Sign out? Your local data will be kept.')) return;
  try {
    if (supabase) await supabase.auth.signOut();
  } catch(e) {}
  currentUser = null;
  isOnlineMode = false;
  document.getElementById('userBar').style.display = 'none';
  document.getElementById('syncIndicator').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'none';
  showAuthOverlay();
}

// ===== CLOUD SYNC =====
async function loadFromCloud() {
  if (!supabase || !currentUser) return;
  updateSyncStatus('syncing');
  try {
    // Load trades
    var { data: cloudTrades, error: tErr } = await supabase
      .from('trades').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: true });
    if (tErr) throw tErr;
    if (cloudTrades && cloudTrades.length > 0) {
      trades = cloudTrades.map(function(t) {
        return {
          id: t.local_id || t.id,
          cloud_id: t.id,
          date: t.date, time: t.time, symbol: t.symbol, direction: t.direction,
          entry: t.entry_price, exit: t.exit_price, quantity: t.quantity,
          pnl: t.pnl, strategy: t.strategy, notes: t.notes,
          rating: t.rating, tags: t.tags || [], riskAmount: t.risk_amount,
          fees: t.fees, screenshot: t.screenshot
        };
      });
    } else {
      // First login - push local trades to cloud
      if (trades.length > 0) { await pushAllTradesToCloud(); }
    }
    
    // Load settings
    var { data: cloudSettings, error: sErr } = await supabase
      .from('user_settings').select('*').eq('user_id', currentUser.id).single();
    if (!sErr && cloudSettings && cloudSettings.settings_json) {
      var parsed = typeof cloudSettings.settings_json === 'string' ? JSON.parse(cloudSettings.settings_json) : cloudSettings.settings_json;
      Object.assign(settings, parsed);
    } else {
      await saveSettingsToCloud();
    }
    
    // Load journal entries
    var { data: cloudJournal, error: jErr } = await supabase
      .from('journal_entries').select('*').eq('user_id', currentUser.id).order('date', { ascending: false });
    if (!jErr && cloudJournal && cloudJournal.length > 0) {
      journalEntries = cloudJournal.map(function(j) {
        return {
          cloud_id: j.id, date: j.date, preMarket: j.pre_market, marketConditions: j.market_conditions,
          endOfDay: j.end_of_day, mood: j.mood, lessonsLearned: j.lessons_learned
        };
      });
    } else if (journalEntries.length > 0) {
      await pushAllJournalToCloud();
    }
    
    // Load playbook
    var { data: cloudPlaybook, error: pErr } = await supabase
      .from('playbook').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: true });
    if (!pErr && cloudPlaybook && cloudPlaybook.length > 0) {
      playbook = cloudPlaybook.map(function(p) {
        return {
          id: p.local_id || p.id, cloud_id: p.id, name: p.name, type: p.type,
          description: p.description, entryRules: p.entry_rules || [],
          stopLoss: p.stop_loss, takeProfit: p.take_profit, notes: p.notes
        };
      });
    } else if (playbook.length > 0) {
      await pushAllPlaybookToCloud();
    }
    
    // Save everything locally as backup
    saveLocalBackup();
    updateSyncStatus('synced');
  } catch (err) {
    console.error('Cloud load error:', err);
    updateSyncStatus('offline');
    loadFromLocalStorage();
  }
}

async function syncTradeToCloud(trade) {
  if (!supabase || !currentUser || !isOnlineMode) return;
  updateSyncStatus('syncing');
  try {
    var row = {
      user_id: currentUser.id, local_id: trade.id,
      date: trade.date, time: trade.time || null, symbol: trade.symbol,
      direction: trade.direction, entry_price: trade.entry, exit_price: trade.exit,
      quantity: trade.quantity, pnl: trade.pnl, strategy: trade.strategy || null,
      notes: trade.notes || null, rating: trade.rating || 0, tags: trade.tags || [],
      risk_amount: trade.riskAmount || null, fees: trade.fees || 0, screenshot: trade.screenshot || null
    };
    
    if (trade.cloud_id) {
      await supabase.from('trades').update(row).eq('id', trade.cloud_id);
    } else {
      var { data } = await supabase.from('trades').insert(row).select().single();
      if (data) trade.cloud_id = data.id;
    }
    updateSyncStatus('synced');
  } catch(e) { console.error('Sync trade error:', e); updateSyncStatus('offline'); }
}

async function deleteTradeFromCloud(trade) {
  if (!supabase || !currentUser || !isOnlineMode || !trade.cloud_id) return;
  try { await supabase.from('trades').delete().eq('id', trade.cloud_id); } catch(e) { console.error('Delete cloud trade error:', e); }
}

async function pushAllTradesToCloud() {
  if (!supabase || !currentUser) return;
  var rows = trades.map(function(t) {
    return {
      user_id: currentUser.id, local_id: t.id, date: t.date, time: t.time || null,
      symbol: t.symbol, direction: t.direction, entry_price: t.entry, exit_price: t.exit,
      quantity: t.quantity, pnl: t.pnl, strategy: t.strategy || null, notes: t.notes || null,
      rating: t.rating || 0, tags: t.tags || [], risk_amount: t.riskAmount || null,
      fees: t.fees || 0, screenshot: t.screenshot || null
    };
  });
  if (rows.length === 0) return;
  try {
    var { data } = await supabase.from('trades').insert(rows).select();
    if (data) {
      data.forEach(function(d, i) { if (trades[i]) trades[i].cloud_id = d.id; });
    }
  } catch(e) { console.error('Push trades error:', e); }
}

async function saveSettingsToCloud() {
  if (!supabase || !currentUser || !isOnlineMode) return;
  try {
    await supabase.from('user_settings').upsert({
      user_id: currentUser.id, settings_json: JSON.stringify(settings), updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });
  } catch(e) { console.error('Save settings error:', e); }
}

async function syncJournalEntryToCloud(entry) {
  if (!supabase || !currentUser || !isOnlineMode) return;
  try {
    var row = {
      user_id: currentUser.id, date: entry.date, pre_market: entry.preMarket || '',
      market_conditions: entry.marketConditions || '', end_of_day: entry.endOfDay || '',
      mood: entry.mood || '', lessons_learned: entry.lessonsLearned || ''
    };
    if (entry.cloud_id) {
      await supabase.from('journal_entries').update(row).eq('id', entry.cloud_id);
    } else {
      var { data } = await supabase.from('journal_entries').upsert(row, { onConflict: 'user_id,date' }).select().single();
      if (data) entry.cloud_id = data.id;
    }
  } catch(e) { console.error('Sync journal error:', e); }
}

async function pushAllJournalToCloud() {
  if (!supabase || !currentUser) return;
  var rows = journalEntries.map(function(j) {
    return {
      user_id: currentUser.id, date: j.date, pre_market: j.preMarket || '',
      market_conditions: j.marketConditions || '', end_of_day: j.endOfDay || '',
      mood: j.mood || '', lessons_learned: j.lessonsLearned || ''
    };
  });
  if (rows.length === 0) return;
  try { await supabase.from('journal_entries').insert(rows); } catch(e) { console.error('Push journal error:', e); }
}

async function syncPlaybookToCloud(entry) {
  if (!supabase || !currentUser || !isOnlineMode) return;
  try {
    var row = {
      user_id: currentUser.id, local_id: entry.id, name: entry.name, type: entry.type || '',
      description: entry.description || '', entry_rules: entry.entryRules || [],
      stop_loss: entry.stopLoss || '', take_profit: entry.takeProfit || '', notes: entry.notes || ''
    };
    if (entry.cloud_id) {
      await supabase.from('playbook').update(row).eq('id', entry.cloud_id);
    } else {
      var { data } = await supabase.from('playbook').insert(row).select().single();
      if (data) entry.cloud_id = data.id;
    }
  } catch(e) { console.error('Sync playbook error:', e); }
}

async function pushAllPlaybookToCloud() {
  if (!supabase || !currentUser) return;
  var rows = playbook.map(function(p) {
    return {
      user_id: currentUser.id, local_id: p.id, name: p.name, type: p.type || '',
      description: p.description || '', entry_rules: p.entryRules || [],
      stop_loss: p.stopLoss || '', take_profit: p.takeProfit || '', notes: p.notes || ''
    };
  });
  if (rows.length === 0) return;
  try { await supabase.from('playbook').insert(rows); } catch(e) { console.error('Push playbook error:', e); }
}

async function deletePlaybookFromCloud(entry) {
  if (!supabase || !currentUser || !isOnlineMode || !entry.cloud_id) return;
  try { await supabase.from('playbook').delete().eq('id', entry.cloud_id); } catch(e) {}
}

// ===== LOCAL STORAGE HELPERS =====
function loadFromLocalStorage() {
  loadTradesFromStorage();
  loadPlaybookFromStorage();
  loadJournalFromStorage();
  loadSettingsFromStorage();
}

function saveLocalBackup() {
  saveTradesToStorage();
  saveSettingsToStorage();
  localStorage.setItem('tradingJournalEntries', JSON.stringify(journalEntries));
  localStorage.setItem('tradingJournalPlaybook', JSON.stringify(playbook));
}

function initApp() {
  applyTheme();
  applySidebarState();
  renderTrades();
  updateStats();
}

// ===== CHECK EXISTING SESSION =====
async function checkSession() {
  if (!supabase) { continueOffline(); return; }
  try {
    var { data: { session } } = await supabase.auth.getSession();
    if (session && session.user) {
      currentUser = session.user;
      isOnlineMode = true;
      // Load local data first as fallback
      loadFromLocalStorage();
      await onAuthSuccess();
    }
    // If no session, show auth overlay (it's already visible)
  } catch(e) {
    console.error('Session check error:', e);
    // Don't auto-continue offline, let user choose
  }
}

// Handle Enter key on auth form
document.getElementById('authPassword').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') handleAuth();
});
document.getElementById('authEmail').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') document.getElementById('authPassword').focus();
});

// Start session check
checkSession();
var trades = [];
var playbook = [];
var journalEntries = [];
var settings = {
  startingBalance: 10000,
  currency: '$',
  defaultRisk: 2,
  defaultDirection: 'long',
  defaultStrategy: '',
  dailyTarget: 0,
  maxDailyLoss: 0,
  maxTradesPerDay: 0,
  monthlyTarget: 0,
  theme: 'light',
  sidebarCollapsed: false,
  subscription: 'free',
  subscriptionDate: null
};
var currentFilter = 'all';
var logFilter = 'all';
var tagFilter = null;
var currentPage = 1;
var tradesPerPage = 15;
var STARTING_BALANCE = 10000;
var lastDeletedTrade = null;
var undoTimer = null;

function showToast(msg) { document.getElementById('toastText').textContent = msg; document.getElementById('toast').classList.add('show'); }
function hideToast() { document.getElementById('toast').classList.remove('show'); }
function scheduleUndoTimeout(ms) { if (undoTimer) clearTimeout(undoTimer); undoTimer = setTimeout(function() { lastDeletedTrade = null; hideToast(); }, ms); }

function deleteTrade(id) {
  id = Number(id);
  var trade = trades.find(function(t) { return t.id === id; });
  if (!trade || !confirm('Delete this trade?')) return;
  lastDeletedTrade = trade;
  deleteTradeFromCloud(trade);
  trades = trades.filter(function(t) { return t.id !== id; });
  saveTradesToStorage();
  renderTrades();
  renderFullTradeLog();
  updateStats();
  showToast('Trade deleted.');
  scheduleUndoTimeout(10000);
}

document.addEventListener('click', function(e) {
  var btn = e.target.closest('.delete-btn');
  if (btn) { deleteTrade(parseInt(btn.getAttribute('data-delete-id'), 10)); }
});

document.getElementById('toastUndo').addEventListener('click', function() {
  if (!lastDeletedTrade) return;
  trades.unshift(lastDeletedTrade);
  saveTradesToStorage();
  lastDeletedTrade = null;
  hideToast();
  renderTrades();
  renderFullTradeLog();
  updateStats();
});
document.getElementById('toastDismiss').addEventListener('click', function() { lastDeletedTrade = null; hideToast(); });

function showPage(pageId, el) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.getElementById('page-' + pageId).classList.add('active');
  el.classList.add('active');
  if (pageId === 'tradelog') renderFullTradeLog();
  if (pageId === 'analytics') renderAnalytics();
  if (pageId === 'calendar') renderCalendar();
  if (pageId === 'riskcalc') calculateRisk();
  if (pageId === 'playbook') renderPlaybook();
  if (pageId === 'settings') loadSettingsPage();
  if (pageId === 'subscription') loadSubscriptionPage();
  if (pageId === 'journal') renderJournal();
}

function setFilter(filter, btn) {
  currentFilter = filter;
  btn.parentElement.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  renderTrades();
}

function setLogFilter(filter, btn) {
  logFilter = filter;
  currentPage = 1;
  btn.parentElement.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  renderFullTradeLog();
}

function renderTrades() {
  var container = document.getElementById('tradesContainer');
  var filtered = trades;
  if (currentFilter === 'winners') filtered = trades.filter(function(t) { return t.pnl > 0; });
  if (currentFilter === 'losers') filtered = trades.filter(function(t) { return t.pnl < 0; });
  var recent = filtered.slice(0, 7);
  if (recent.length === 0) { container.innerHTML = '<div class="empty-state"><p>No trades yet. Click "+ New Trade" to add your first trade.</p></div>'; return; }
  var html = '';
  for (var i = 0; i < recent.length; i++) {
    var t = recent[i];
    var entryStr = t.entry ? '$' + t.entry.toFixed(2) : '-';
    var exitStr = t.exit ? '$' + t.exit.toFixed(2) : '-';
    var imageIcon = t.image ? '<span class="trade-image-icon" onclick="event.stopPropagation();viewTradeImage(' + t.id + ')" title="View screenshot">üì∑</span>' : '';
    html += '<div class="table-row"><div class="trade-symbol"><div class="symbol-icon">' + t.symbol.substring(0,2) + '</div><div class="symbol-info"><div class="symbol-name" style="display:flex;align-items:center">' + t.symbol + imageIcon + '</div><div class="symbol-date">' + formatDate(t.date) + '</div></div></div><div><span class="trade-direction ' + t.direction + '">' + (t.direction === 'long' ? '‚Üë Long' : '‚Üì Short') + '</span></div><div class="trade-entry">' + entryStr + '</div><div class="trade-exit">' + exitStr + '</div><div class="trade-pnl ' + (t.pnl >= 0 ? 'positive' : 'negative') + '">' + (t.pnl >= 0 ? '+' : '') + '$' + Math.abs(t.pnl).toFixed(2) + '</div><div class="trade-rr">' + (t.rMultiple ? (t.rMultiple >= 0 ? '+' : '') + t.rMultiple.toFixed(2) + 'R' : '-') + '</div><div><button class="delete-btn" data-delete-id="' + t.id + '">Delete</button></div></div>';
  }
  container.innerHTML = html;
}

function renderFullTradeLog() {
  var container = document.getElementById('fullTradesContainer');
  var search = document.getElementById('searchInput').value.toLowerCase();
  
  // Build tag filters UI
  updateTagFilters();
  
  var filtered = trades.filter(function(t) {
    if (search && t.symbol.toLowerCase().indexOf(search) === -1) return false;
    if (logFilter === 'winners') return t.pnl > 0;
    if (logFilter === 'losers') return t.pnl < 0;
    if (tagFilter && (!t.tags || t.tags.indexOf(tagFilter) === -1)) return false;
    return true;
  });
  filtered.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  var totalPages = Math.ceil(filtered.length / tradesPerPage) || 1;
  if (currentPage > totalPages) currentPage = totalPages;
  var start = (currentPage - 1) * tradesPerPage;
  var end = Math.min(start + tradesPerPage, filtered.length);
  var page = filtered.slice(start, end);
  document.getElementById('tradeCount').textContent = filtered.length + ' trade' + (filtered.length !== 1 ? 's' : '');
  document.getElementById('paginationInfo').textContent = filtered.length > 0 ? 'Showing ' + (start + 1) + '-' + end + ' of ' + filtered.length : 'No trades';
  document.getElementById('prevPageBtn').disabled = currentPage <= 1;
  document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
  if (page.length === 0) { container.innerHTML = '<div class="empty-state"><p>No trades found.</p></div>'; return; }
  var html = '';
  for (var i = 0; i < page.length; i++) {
    var t = page[i];
    var entryStr = t.entry ? '$' + t.entry.toFixed(2) : '-';
    var exitStr = t.exit ? '$' + t.exit.toFixed(2) : '-';
    var imageIcon = t.image ? '<span class="trade-image-icon" onclick="event.stopPropagation();viewTradeImage(' + t.id + ')" title="View screenshot">üì∑</span>' : '';
    var ratingStr = t.rating ? renderStars(t.rating) : '';
    var tagsStr = t.tags && t.tags.length > 0 ? '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">' + renderTagsDisplay(t.tags) + '</div>' : '';
    html += '<div class="table-row clickable-row" onclick="openTradeDetails(' + t.id + ')" data-trade-id="' + t.id + '"><div class="trade-id">' + (start + i + 1) + '</div><div class="trade-symbol"><div class="symbol-icon">' + t.symbol.substring(0,2) + '</div><div class="symbol-info"><div class="symbol-name" style="display:flex;align-items:center;gap:6px">' + t.symbol + imageIcon + ratingStr + '</div><div class="symbol-date">' + formatDate(t.date) + '</div>' + tagsStr + '</div></div><div><span class="trade-direction ' + t.direction + '">' + (t.direction === 'long' ? '‚Üë Long' : '‚Üì Short') + '</span></div><div class="trade-entry">' + entryStr + '</div><div class="trade-exit">' + exitStr + '</div><div class="trade-pnl ' + (t.pnl >= 0 ? 'positive' : 'negative') + '">' + (t.pnl >= 0 ? '+' : '') + '$' + Math.abs(t.pnl).toFixed(2) + '</div><div class="trade-rr">' + (t.rMultiple ? (t.rMultiple >= 0 ? '+' : '') + t.rMultiple.toFixed(2) + 'R' : '-') + '</div><div class="trade-strategy">' + (t.strategy || '-') + '</div><div class="trade-notes">' + (t.notes || '-') + '</div><div><button class="delete-btn" data-delete-id="' + t.id + '" onclick="event.stopPropagation()">Delete</button></div></div>';
  }
  container.innerHTML = html;
}

function updateTagFilters() {
  // Get all unique tags
  var allTags = [];
  trades.forEach(function(t) {
    if (t.tags && t.tags.length > 0) {
      t.tags.forEach(function(tag) {
        if (allTags.indexOf(tag) === -1) allTags.push(tag);
      });
    }
  });
  
  var container = document.getElementById('tagFiltersContainer');
  var listContainer = document.getElementById('tagFiltersList');
  var clearBtn = document.getElementById('clearTagFilter');
  
  if (allTags.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  var html = '';
  allTags.sort();
  allTags.forEach(function(tag) {
    var activeClass = tagFilter === tag ? ' active' : '';
    html += '<span class="tag-filter' + activeClass + '" onclick="setTagFilter(\'' + tag + '\')">' + tag + '</span>';
  });
  listContainer.innerHTML = html;
  clearBtn.style.display = tagFilter ? 'inline-block' : 'none';
}

function setTagFilter(tag) {
  tagFilter = tagFilter === tag ? null : tag;
  currentPage = 1;
  renderFullTradeLog();
}

function clearTagFilter() {
  tagFilter = null;
  currentPage = 1;
  renderFullTradeLog();
}

function prevPage() { if (currentPage > 1) { currentPage--; renderFullTradeLog(); } }
function nextPage() { currentPage++; renderFullTradeLog(); }

function formatDate(d) { var date = new Date(d); var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear(); }

function updateStats() {
  var totalPnl = 0, wins = [], losses = [];
  for (var i = 0; i < trades.length; i++) { totalPnl += trades[i].pnl; if (trades[i].pnl > 0) wins.push(trades[i]); else if (trades[i].pnl < 0) losses.push(trades[i]); }
  var winRate = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
  document.getElementById('totalPnl').textContent = (totalPnl >= 0 ? '+$' : '-$') + Math.abs(totalPnl).toFixed(2);
  document.getElementById('totalPnl').style.color = totalPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  document.getElementById('pnlCard').className = 'stat-card ' + (trades.length === 0 ? 'neutral' : (totalPnl >= 0 ? 'positive' : 'negative'));
  document.getElementById('pnlChange').textContent = trades.length === 0 ? 'No trades yet' : ((totalPnl / STARTING_BALANCE * 100).toFixed(1) + '% return');
  document.getElementById('totalTrades').textContent = trades.length;
  document.getElementById('tradesChange').textContent = trades.length === 0 ? 'Start trading' : wins.length + ' wins, ' + losses.length + ' losses';
  document.getElementById('winRatePercent').textContent = Math.round(winRate) + '%';
  document.getElementById('totalWins').textContent = wins.length;
  document.getElementById('totalLosses').textContent = losses.length;
  document.getElementById('winRateRing').style.strokeDashoffset = 377 - (winRate / 100) * 377;
  var avgWin = wins.length > 0 ? wins.reduce(function(s,t){return s+t.pnl;},0) / wins.length : 0;
  var avgLoss = losses.length > 0 ? Math.abs(losses.reduce(function(s,t){return s+t.pnl;},0) / losses.length) : 0;
  document.getElementById('avgWin').textContent = '+$' + avgWin.toFixed(2);
  document.getElementById('avgLoss').textContent = '-$' + avgLoss.toFixed(2);
  document.getElementById('largestWin').textContent = wins.length > 0 ? '+$' + Math.max.apply(null, wins.map(function(t){return t.pnl;})).toFixed(2) : '$0.00';
  document.getElementById('largestLoss').textContent = losses.length > 0 ? '-$' + Math.abs(Math.min.apply(null, losses.map(function(t){return t.pnl;}))).toFixed(2) : '$0.00';
  document.getElementById('expectancy').textContent = trades.length > 0 ? '$' + (totalPnl / trades.length).toFixed(2) : '$0.00';
  document.getElementById('accountBalance').textContent = '$' + (STARTING_BALANCE + totalPnl).toLocaleString('en-US', {minimumFractionDigits:2});
  var grossWin = wins.reduce(function(s,t){return s+t.pnl;},0);
  var grossLoss = Math.abs(losses.reduce(function(s,t){return s+t.pnl;},0));
  var pf = grossLoss > 0 ? grossWin / grossLoss : 0;
  document.getElementById('profitFactor').textContent = trades.length === 0 ? '-' : pf.toFixed(2);
  var rTrades = trades.filter(function(t){return t.rMultiple !== null;});
  var avgR = rTrades.length > 0 ? rTrades.reduce(function(s,t){return s+t.rMultiple;},0) / rTrades.length : null;
  document.getElementById('avgR').textContent = avgR !== null ? avgR.toFixed(2) + 'R' : '-';
  updateChart();
  updateGoalProgress();
  updateTradeLimitWarning();
  updateOvertradingWarning();
}

function updateTradeLimitWarning() {
  var card = document.getElementById('tradeLimitCard');
  
  if (isPremium()) {
    card.style.display = 'none';
    return;
  }
  
  var remaining = getTradesRemaining();
  var tradesThisMonth = getTradesThisMonth();
  
  if (remaining <= 3 || tradesThisMonth >= 7) {
    card.style.display = 'block';
    var text = document.getElementById('tradeLimitText');
    
    if (remaining === 0) {
      text.textContent = 'Monthly trade limit reached!';
      card.style.borderColor = 'var(--accent-red)';
    } else if (remaining === 1) {
      text.textContent = '1 trade remaining this month';
      card.style.borderColor = 'var(--accent-red)';
    } else {
      text.textContent = remaining + ' trades remaining this month';
      card.style.borderColor = 'var(--accent-yellow)';
    }
  } else {
    card.style.display = 'none';
  }
}

function updateGoalProgress() {
  var goalCard = document.getElementById('goalCard');
  
  // Check for valid goals
  var hasTarget = settings.dailyTarget !== null && settings.dailyTarget !== undefined && settings.dailyTarget > 0;
  var hasMaxLoss = settings.maxDailyLoss !== null && settings.maxDailyLoss !== undefined && settings.maxDailyLoss > 0;
  
  if (!hasTarget && !hasMaxLoss) {
    goalCard.style.display = 'none';
    return;
  }
  
  goalCard.style.display = 'block';
  
  // Calculate today's P/L
  var today = new Date().toISOString().split('T')[0];
  var todayTrades = trades.filter(function(t) { return t.date === today; });
  var todayPnl = todayTrades.reduce(function(s, t) { return s + t.pnl; }, 0);
  
  // Update today's P/L display
  var todayPnlEl = document.getElementById('goalTodayPnl');
  todayPnlEl.textContent = (todayPnl >= 0 ? '+$' : '-$') + Math.abs(todayPnl).toFixed(2);
  todayPnlEl.style.color = todayPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  
  var profitSection = document.getElementById('profitTargetSection');
  var lossSection = document.getElementById('lossLimitSection');
  var messageEl = document.getElementById('goalMessage');
  var messageTextEl = document.getElementById('goalMessageText');
  
  messageEl.style.display = 'none';
  
  // Profit Target Section
  if (hasTarget) {
    profitSection.style.display = 'block';
    var profitProgress = Math.max(0, Math.min((todayPnl / settings.dailyTarget) * 100, 100));
    document.getElementById('profitProgressBar').style.width = profitProgress + '%';
    
    var profitStatus = document.getElementById('profitTargetStatus');
    if (todayPnl >= settings.dailyTarget) {
      profitStatus.textContent = '‚úì Goal reached!';
      profitStatus.style.color = 'var(--accent-green)';
      messageEl.style.display = 'block';
      messageEl.style.background = 'var(--accent-green-dim)';
      messageTextEl.style.color = 'var(--accent-green)';
      messageTextEl.textContent = 'üéâ Congratulations! You hit your daily target!';
    } else if (todayPnl > 0) {
      profitStatus.textContent = '$' + todayPnl.toFixed(0) + ' / $' + settings.dailyTarget.toFixed(0);
      profitStatus.style.color = 'var(--accent-green)';
    } else {
      profitStatus.textContent = '$0 / $' + settings.dailyTarget.toFixed(0);
      profitStatus.style.color = 'var(--text-muted)';
    }
  } else {
    profitSection.style.display = 'none';
  }
  
  // Loss Limit Section
  if (hasMaxLoss) {
    lossSection.style.display = 'block';
    var lossAmount = todayPnl < 0 ? Math.abs(todayPnl) : 0;
    var lossProgress = Math.min((lossAmount / settings.maxDailyLoss) * 100, 100);
    document.getElementById('lossProgressBar').style.width = lossProgress + '%';
    
    var lossStatus = document.getElementById('lossLimitStatus');
    lossStatus.textContent = '$' + lossAmount.toFixed(0) + ' / $' + settings.maxDailyLoss.toFixed(0);
    
    if (lossAmount >= settings.maxDailyLoss) {
      lossStatus.style.color = 'var(--accent-red)';
      messageEl.style.display = 'block';
      messageEl.style.background = 'var(--accent-red-dim)';
      messageTextEl.style.color = 'var(--accent-red)';
      messageTextEl.textContent = 'üõë MAX DAILY LOSS REACHED - Consider stopping for today!';
    } else if (lossProgress >= 75) {
      lossStatus.style.color = 'var(--accent-red)';
      messageEl.style.display = 'block';
      messageEl.style.background = 'rgba(255,193,7,0.15)';
      messageTextEl.style.color = '#ffc107';
      messageTextEl.textContent = '‚ö†Ô∏è Warning: Approaching max daily loss (' + lossProgress.toFixed(0) + '%)';
    } else if (lossProgress >= 50) {
      lossStatus.style.color = 'var(--accent-yellow)';
    } else {
      lossStatus.style.color = 'var(--text-muted)';
    }
  } else {
    lossSection.style.display = 'none';
  }
}

function updateChart() {
  var noData = document.getElementById('chartNoData');
  var chartLine = document.getElementById('chartLine');
  var chartArea = document.getElementById('chartArea');
  var chartYAxis = document.getElementById('chartYAxis');
  var chartXAxis = document.getElementById('chartXAxis');
  var chartGrid = document.getElementById('chartGrid');
  var chartPoints = document.getElementById('chartPoints');
  var chartSvg = document.getElementById('chartSvg');
  var chartContainer = document.getElementById('chartContainer');
  
  // Get actual container dimensions - use minimum of 300 if not ready
  var containerWidth = Math.max(chartContainer.clientWidth - 48, 300);
  var containerHeight = 200;
  
  // Set viewBox dynamically
  chartSvg.setAttribute('viewBox', '0 0 ' + containerWidth + ' ' + containerHeight);
  
  // Chart dimensions
  var marginLeft = 55;
  var marginBottom = 25;
  var marginTop = 15;
  var marginRight = 15;
  var chartWidth = containerWidth - marginLeft - marginRight;
  var chartHeight = containerHeight - marginTop - marginBottom;
  
  if (trades.length === 0) { 
    noData.style.display = 'block'; 
    chartLine.setAttribute('d', ''); 
    chartArea.setAttribute('d', ''); 
    chartYAxis.innerHTML = '';
    chartXAxis.innerHTML = '';
    chartGrid.innerHTML = '';
    chartPoints.innerHTML = '';
    return; 
  }
  noData.style.display = 'none';
  
  var sorted = trades.slice().sort(function(a,b){return new Date(a.date) - new Date(b.date);});
  var cum = STARTING_BALANCE;
  var pts = [{x:0, y:cum, trade: null}];
  for (var i = 0; i < sorted.length; i++) { 
    cum += sorted[i].pnl; 
    pts.push({x:i+1, y:cum, trade: sorted[i]}); 
  }
  
  // Store points data globally for tooltip
  window.chartPointsData = pts;
  
  var minY = Math.min.apply(null, pts.map(function(p){return p.y;}));
  var maxY = Math.max.apply(null, pts.map(function(p){return p.y;}));
  var padding = (maxY - minY) * 0.1 || 100;
  minY = minY - padding;
  maxY = maxY + padding;
  var maxX = pts.length - 1;
  
  function sx(x) { return marginLeft + (x / Math.max(maxX, 1)) * chartWidth; }
  function sy(y) { return marginTop + chartHeight - ((y - minY) / (maxY - minY)) * chartHeight; }
  
  // Store scale functions globally
  window.chartSx = sx;
  window.chartSy = sy;
  
  // Draw Y axis (balance)
  var yAxisHtml = '';
  var yTicks = 4;
  for (var i = 0; i <= yTicks; i++) {
    var val = minY + (maxY - minY) * (i / yTicks);
    var yPos = sy(val);
    yAxisHtml += '<text x="' + (marginLeft - 5) + '" y="' + (yPos + 3) + '" text-anchor="end" fill="#5a5a6a" font-size="9" font-family="JetBrains Mono">$' + (val/1000).toFixed(1) + 'k</text>';
  }
  chartYAxis.innerHTML = yAxisHtml;
  
  // Draw X axis (trade numbers)
  var xAxisHtml = '';
  var xTicks;
  
  if (maxX <= 10) {
    // Show all numbers if 10 or fewer trades
    xTicks = maxX;
    for (var i = 0; i <= maxX; i++) {
      var xPos = sx(i);
      xAxisHtml += '<text x="' + xPos + '" y="' + (marginTop + chartHeight + 15) + '" text-anchor="middle" fill="#5a5a6a" font-size="9" font-family="JetBrains Mono">' + i + '</text>';
    }
  } else {
    // Calculate how many labels can fit (roughly 30px per label)
    var maxLabels = Math.floor(chartWidth / 35);
    xTicks = Math.min(maxX, Math.max(5, maxLabels));
    
    // Show evenly spaced ticks
    for (var i = 0; i <= xTicks; i++) {
      var val = Math.round(maxX * (i / xTicks));
      var xPos = sx(val);
      xAxisHtml += '<text x="' + xPos + '" y="' + (marginTop + chartHeight + 15) + '" text-anchor="middle" fill="#5a5a6a" font-size="9" font-family="JetBrains Mono">' + val + '</text>';
    }
  }
  // X axis label
  xAxisHtml += '<text x="' + (marginLeft + chartWidth/2) + '" y="' + (marginTop + chartHeight + 24) + '" text-anchor="middle" fill="#3a3a4a" font-size="8">Trades</text>';
  chartXAxis.innerHTML = xAxisHtml;
  
  // Draw grid lines
  var gridHtml = '';
  for (var i = 1; i < yTicks; i++) {
    var val = minY + (maxY - minY) * (i / yTicks);
    var yPos = sy(val);
    gridHtml += '<line x1="' + marginLeft + '" y1="' + yPos + '" x2="' + (marginLeft + chartWidth) + '" y2="' + yPos + '" stroke="#1f1f2a" stroke-dasharray="4 4"/>';
  }
  chartGrid.innerHTML = gridHtml;
  
  // Draw line and area
  var d = 'M' + pts.map(function(p){return sx(p.x) + ',' + sy(p.y);}).join(' L');
  chartLine.setAttribute('d', d);
  chartArea.setAttribute('d', d + ' L' + sx(maxX) + ',' + (marginTop + chartHeight) + ' L' + marginLeft + ',' + (marginTop + chartHeight) + ' Z');
  
  // Draw interactive points
  var pointsHtml = '';
  for (var i = 0; i < pts.length; i++) {
    var p = pts[i];
    var color = p.trade ? (p.trade.pnl >= 0 ? '#00d4a1' : '#ff4757') : '#00d4a1';
    pointsHtml += '<circle class="chart-point" cx="' + sx(p.x) + '" cy="' + sy(p.y) + '" r="4" fill="' + color + '" stroke="var(--bg-card)" stroke-width="2" data-index="' + i + '" onmouseenter="showChartTooltip(event, ' + i + ')" onmouseleave="hideChartTooltip()"/>';
  }
  chartPoints.innerHTML = pointsHtml;
}

function showChartTooltip(event, index) {
  var tooltip = document.getElementById('chartTooltip');
  var container = document.getElementById('chartContainer');
  var p = window.chartPointsData[index];
  
  var tradeText = index === 0 ? 'Starting Balance' : 'After Trade #' + index;
  if (p.trade) {
    tradeText += ' (' + p.trade.symbol + ')';
  }
  
  document.getElementById('tooltipTrade').textContent = tradeText;
  document.getElementById('tooltipBalance').textContent = '$' + p.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('tooltipBalance').style.color = p.y >= STARTING_BALANCE ? 'var(--accent-green)' : 'var(--accent-red)';
  
  // Position tooltip
  var rect = container.getBoundingClientRect();
  var svgX = window.chartSx(p.x);
  var svgY = window.chartSy(p.y);
  
  // Convert SVG coords to container coords (viewBox is 340x200, container has padding)
  var scaleX = (rect.width - 48) / 340; // 24px padding on each side
  var scaleY = (rect.height - 48) / 200;
  
  var tooltipX = 24 + svgX * scaleX;
  var tooltipY = 24 + svgY * scaleY - 50;
  
  // Keep tooltip in bounds
  if (tooltipY < 5) tooltipY = 24 + svgY * scaleY + 20;
  
  tooltip.style.left = tooltipX + 'px';
  tooltip.style.top = tooltipY + 'px';
  tooltip.style.transform = 'translateX(-50%)';
  tooltip.style.opacity = '1';
}

function hideChartTooltip() {
  document.getElementById('chartTooltip').style.opacity = '0';
}

function renderAnalytics() {
  var locked = document.getElementById('analyticsLocked');
  var content = document.getElementById('analyticsContent');
  var progressText = document.getElementById('analyticsProgressText');
  var progressBar = document.getElementById('analyticsProgressBar');
  var total = trades.length;
  var required = 5;
  if (total < required) {
    locked.style.display = 'block';
    content.style.display = 'none';
    progressText.textContent = total + ' / ' + required + ' trades logged';
    progressBar.style.width = (total / required * 100) + '%';
    return;
  }
  locked.style.display = 'none';
  content.style.display = 'block';

  var wins = trades.filter(function(t){return t.pnl > 0;});
  var losses = trades.filter(function(t){return t.pnl < 0;});
  var pnls = trades.map(function(t){return t.pnl;});

  // Best/Worst
  var best = trades.reduce(function(a,b){return a.pnl > b.pnl ? a : b;});
  var worst = trades.reduce(function(a,b){return a.pnl < b.pnl ? a : b;});
  document.getElementById('anBestTrade').textContent = '+$' + best.pnl.toFixed(2);
  document.getElementById('anBestTradeInfo').textContent = best.symbol + ' on ' + formatDate(best.date);
  document.getElementById('anWorstTrade').textContent = '-$' + Math.abs(worst.pnl).toFixed(2);
  document.getElementById('anWorstTradeInfo').textContent = worst.symbol + ' on ' + formatDate(worst.date);

  // Risk/Reward
  var avgWin = wins.length > 0 ? wins.reduce(function(s,t){return s+t.pnl;},0) / wins.length : 0;
  var avgLoss = losses.length > 0 ? Math.abs(losses.reduce(function(s,t){return s+t.pnl;},0) / losses.length) : 0;
  var rr = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : '-';
  document.getElementById('anRiskReward').textContent = rr !== '-' ? rr + ':1' : '-';
  document.getElementById('anRiskRewardInfo').textContent = avgWin > 0 && avgLoss > 0 ? '$' + avgWin.toFixed(0) + ' / $' + avgLoss.toFixed(0) : 'Avg win / Avg loss';

  // Expectancy
  var totalPnl = pnls.reduce(function(a,b){return a+b;},0);
  document.getElementById('anExpectancy').textContent = '$' + (totalPnl / trades.length).toFixed(2);

  // Streaks
  var sorted = trades.slice().sort(function(a,b){return new Date(a.date) - new Date(b.date);});
  var maxWin = 0, maxLoss = 0, tempWin = 0, tempLoss = 0;
  for (var i = 0; i < sorted.length; i++) {
    if (sorted[i].pnl > 0) { tempWin++; tempLoss = 0; if (tempWin > maxWin) maxWin = tempWin; }
    else if (sorted[i].pnl < 0) { tempLoss++; tempWin = 0; if (tempLoss > maxLoss) maxLoss = tempLoss; }
  }
  var currentStreak = 0, currentType = '';
  for (var i = sorted.length - 1; i >= 0; i--) {
    var type = sorted[i].pnl > 0 ? 'win' : 'loss';
    if (currentType === '') { currentType = type; currentStreak = 1; }
    else if (type === currentType) { currentStreak++; }
    else break;
  }
  document.getElementById('anMaxWinStreak').textContent = maxWin;
  document.getElementById('anMaxLossStreak').textContent = maxLoss;
  document.getElementById('anCurrentStreak').textContent = currentStreak;
  document.getElementById('anCurrentStreakLabel').textContent = currentType === 'win' ? 'Win Streak' : 'Loss Streak';

  // Day performance
  var dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  var dayPnl = [0,0,0,0,0,0,0];
  var dayCounts = [0,0,0,0,0,0,0];
  trades.forEach(function(t){ var d = new Date(t.date).getDay(); dayPnl[d] += t.pnl; dayCounts[d]++; });
  var dayHtml = '';
  for (var i = 0; i < 7; i++) {
    var pnl = dayPnl[i];
    var cls = pnl > 0 ? 'positive' : (pnl < 0 ? 'negative' : '');
    var val = dayCounts[i] > 0 ? (pnl >= 0 ? '+' : '') + '$' + Math.abs(pnl).toFixed(0) : '-';
    dayHtml += '<div class="day-cell ' + cls + '"><div class="day-name">' + dayNames[i] + '</div><div class="day-value">' + val + '</div></div>';
  }
  document.getElementById('dayHeatmap').innerHTML = dayHtml;

  // Long vs Short
  var longs = trades.filter(function(t){return t.direction === 'long';});
  var shorts = trades.filter(function(t){return t.direction === 'short';});
  var longWins = longs.filter(function(t){return t.pnl > 0;}).length;
  var shortWins = shorts.filter(function(t){return t.pnl > 0;}).length;
  var longPnl = longs.reduce(function(s,t){return s+t.pnl;},0);
  var shortPnl = shorts.reduce(function(s,t){return s+t.pnl;},0);
  var lsHtml = '';
  lsHtml += '<div class="dist-row"><div class="dist-label">Long (' + longs.length + ')</div><div class="dist-bar">';
  if (longs.length > 0) { var pct = (longWins / longs.length) * 100; lsHtml += '<div class="dist-bar-win" style="width:' + pct + '%"></div><div class="dist-bar-loss" style="width:' + (100-pct) + '%"></div>'; }
  lsHtml += '</div><div class="dist-value" style="color:' + (longPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (longPnl >= 0 ? '+' : '') + '$' + Math.abs(longPnl).toFixed(0) + '</div></div>';
  lsHtml += '<div class="dist-row"><div class="dist-label">Short (' + shorts.length + ')</div><div class="dist-bar">';
  if (shorts.length > 0) { var pct = (shortWins / shorts.length) * 100; lsHtml += '<div class="dist-bar-win" style="width:' + pct + '%"></div><div class="dist-bar-loss" style="width:' + (100-pct) + '%"></div>'; }
  lsHtml += '</div><div class="dist-value" style="color:' + (shortPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (shortPnl >= 0 ? '+' : '') + '$' + Math.abs(shortPnl).toFixed(0) + '</div></div>';
  document.getElementById('longShortBars').innerHTML = lsHtml;

  // Strategy performance
  var strategies = {};
  trades.forEach(function(t){ var s = t.strategy || 'Untagged'; if (!strategies[s]) strategies[s] = {trades:0, wins:0, pnl:0}; strategies[s].trades++; if (t.pnl > 0) strategies[s].wins++; strategies[s].pnl += t.pnl; });
  var stratHtml = '';
  Object.keys(strategies).sort(function(a,b){return strategies[b].pnl - strategies[a].pnl;}).forEach(function(s){
    var d = strategies[s];
    var wr = ((d.wins / d.trades) * 100).toFixed(0);
    stratHtml += '<div class="strategy-item"><div class="strategy-name">' + s + '</div><div class="strategy-stats"><div class="strategy-stat"><div class="strategy-stat-value">' + d.trades + '</div><div class="strategy-stat-label">Trades</div></div><div class="strategy-stat"><div class="strategy-stat-value">' + wr + '%</div><div class="strategy-stat-label">Win Rate</div></div><div class="strategy-stat"><div class="strategy-stat-value" style="color:' + (d.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (d.pnl >= 0 ? '+' : '') + '$' + Math.abs(d.pnl).toFixed(0) + '</div><div class="strategy-stat-label">P/L</div></div></div></div>';
  });
  document.getElementById('strategyPerformance').innerHTML = stratHtml || '<div class="empty-state"><p>No strategies recorded</p></div>';

  // Bottom stats
  var symbolCounts = {};
  trades.forEach(function(t){ symbolCounts[t.symbol] = (symbolCounts[t.symbol] || 0) + 1; });
  var topSymbol = Object.keys(symbolCounts).sort(function(a,b){return symbolCounts[b] - symbolCounts[a];})[0] || '-';
  document.getElementById('anTopSymbol').textContent = topSymbol;
  document.getElementById('anTopSymbolCount').textContent = (symbolCounts[topSymbol] || 0) + ' trades';

  // Trades per week
  if (trades.length >= 2) {
    var dates = trades.map(function(t){return new Date(t.date).getTime();});
    var minDate = Math.min.apply(null, dates);
    var maxDate = Math.max.apply(null, dates);
    var weeks = Math.max(1, (maxDate - minDate) / (7*24*60*60*1000));
    document.getElementById('anTradesPerWeek').textContent = (trades.length / weeks).toFixed(1);
  } else {
    document.getElementById('anTradesPerWeek').textContent = trades.length.toString();
  }

  // Consistency (profitable days %)
  var dayResults = {};
  trades.forEach(function(t){ if (!dayResults[t.date]) dayResults[t.date] = 0; dayResults[t.date] += t.pnl; });
  var profitDays = Object.keys(dayResults).filter(function(d){return dayResults[d] > 0;}).length;
  var totalDays = Object.keys(dayResults).length;
  var consistency = totalDays > 0 ? ((profitDays / totalDays) * 100).toFixed(0) : 0;
  document.getElementById('anConsistency').textContent = consistency + '%';
  document.getElementById('anConsistencyInfo').textContent = profitDays + ' of ' + totalDays + ' days profitable';
  
  // Drawdown calculation
  renderDrawdownTracker(sorted);
  
  // Time of day analysis
  renderTimeAnalysis();
  
  // Tag performance
  renderTagPerformance();
  
  // Risk tracking
  renderRiskTracking();
}

function renderTimeAnalysis() {
  var tradesWithTime = trades.filter(function(t) { return t.time; });
  var totalTrades = trades.length;
  
  document.getElementById('taTradesWithTime').textContent = tradesWithTime.length;
  document.getElementById('taTradesWithTimePct').textContent = totalTrades > 0 ? Math.round((tradesWithTime.length / totalTrades) * 100) + '% of total' : '0%';
  
  var heatmapEl = document.getElementById('timeHeatmap');
  var noDataMsg = document.getElementById('timeNoDataMsg');
  
  if (tradesWithTime.length < 3) {
    heatmapEl.style.display = 'none';
    noDataMsg.style.display = 'block';
    document.getElementById('taBestTime').textContent = '-';
    document.getElementById('taBestTimeInfo').textContent = '-';
    document.getElementById('taWorstTime').textContent = '-';
    document.getElementById('taWorstTimeInfo').textContent = '-';
    return;
  }
  
  heatmapEl.style.display = 'grid';
  noDataMsg.style.display = 'none';
  
  // Define time slots
  var slots = [
    { label: 'Pre-Market', start: 4, end: 9, key: 'premarket' },
    { label: '9:30-10:30', start: 9, end: 10, key: 'open' },
    { label: '10:30-12:00', start: 10, end: 12, key: 'midmorning' },
    { label: '12:00-14:00', start: 12, end: 14, key: 'lunch' },
    { label: '14:00-15:30', start: 14, end: 15, key: 'afternoon' },
    { label: '15:30-16:00', start: 15, end: 16, key: 'close' }
  ];
  
  var slotData = {};
  slots.forEach(function(s) {
    slotData[s.key] = { pnl: 0, trades: 0, wins: 0, label: s.label };
  });
  
  tradesWithTime.forEach(function(t) {
    var hour = parseInt(t.time.split(':')[0]);
    var minute = parseInt(t.time.split(':')[1]) || 0;
    var decimalHour = hour + minute / 60;
    
    var slotKey = null;
    if (decimalHour >= 4 && decimalHour < 9.5) slotKey = 'premarket';
    else if (decimalHour >= 9.5 && decimalHour < 10.5) slotKey = 'open';
    else if (decimalHour >= 10.5 && decimalHour < 12) slotKey = 'midmorning';
    else if (decimalHour >= 12 && decimalHour < 14) slotKey = 'lunch';
    else if (decimalHour >= 14 && decimalHour < 15.5) slotKey = 'afternoon';
    else if (decimalHour >= 15.5 && decimalHour < 20) slotKey = 'close';
    
    if (slotKey && slotData[slotKey]) {
      slotData[slotKey].pnl += t.pnl;
      slotData[slotKey].trades++;
      if (t.pnl > 0) slotData[slotKey].wins++;
    }
  });
  
  // Find best and worst
  var best = null, worst = null;
  Object.keys(slotData).forEach(function(key) {
    var data = slotData[key];
    if (data.trades >= 1) {
      if (!best || data.pnl > best.pnl) best = { key: key, data: data };
      if (!worst || data.pnl < worst.pnl) worst = { key: key, data: data };
    }
  });
  
  if (best) {
    document.getElementById('taBestTime').textContent = best.data.label;
    var wr = best.data.trades > 0 ? Math.round((best.data.wins / best.data.trades) * 100) : 0;
    document.getElementById('taBestTimeInfo').textContent = '+$' + best.data.pnl.toFixed(0) + ' (' + wr + '% WR)';
  }
  
  if (worst && worst.data.pnl < 0) {
    document.getElementById('taWorstTime').textContent = worst.data.label;
    var wr = worst.data.trades > 0 ? Math.round((worst.data.wins / worst.data.trades) * 100) : 0;
    document.getElementById('taWorstTimeInfo').textContent = '-$' + Math.abs(worst.data.pnl).toFixed(0) + ' (' + wr + '% WR)';
  } else {
    document.getElementById('taWorstTime').textContent = '-';
    document.getElementById('taWorstTimeInfo').textContent = 'All profitable!';
  }
  
  // Render heatmap
  var html = '';
  slots.forEach(function(slot) {
    var data = slotData[slot.key];
    var cls = data.trades === 0 ? '' : (data.pnl >= 0 ? 'positive' : 'negative');
    var pnlStr = data.trades === 0 ? '-' : ((data.pnl >= 0 ? '+' : '') + '$' + Math.abs(data.pnl).toFixed(0));
    html += '<div class="time-slot ' + cls + '">';
    html += '<div class="time-slot-label">' + data.label + '</div>';
    html += '<div class="time-slot-value">' + pnlStr + '</div>';
    html += '<div class="time-slot-trades">' + data.trades + ' trades</div>';
    html += '</div>';
  });
  heatmapEl.innerHTML = html;
}

function renderTagPerformance() {
  var tagData = {};
  
  // Collect tag stats
  trades.forEach(function(t) {
    if (t.tags && t.tags.length > 0) {
      t.tags.forEach(function(tag) {
        if (!tagData[tag]) {
          tagData[tag] = { pnl: 0, trades: 0, wins: 0 };
        }
        tagData[tag].pnl += t.pnl;
        tagData[tag].trades++;
        if (t.pnl > 0) tagData[tag].wins++;
      });
    }
  });
  
  var tagKeys = Object.keys(tagData);
  var listContainer = document.getElementById('tagPerformanceList');
  var noDataMsg = document.getElementById('tagNoDataMsg');
  
  if (tagKeys.length === 0) {
    listContainer.style.display = 'none';
    noDataMsg.style.display = 'block';
    document.getElementById('tpBestTag').textContent = '-';
    document.getElementById('tpBestTagInfo').textContent = '-';
    document.getElementById('tpWorstTag').textContent = '-';
    document.getElementById('tpWorstTagInfo').textContent = '-';
    return;
  }
  
  listContainer.style.display = 'block';
  noDataMsg.style.display = 'none';
  
  // Sort by P/L
  tagKeys.sort(function(a, b) { return tagData[b].pnl - tagData[a].pnl; });
  
  // Find best and worst
  var bestTag = tagKeys[0];
  var worstTag = tagKeys[tagKeys.length - 1];
  
  var bestData = tagData[bestTag];
  var worstData = tagData[worstTag];
  
  document.getElementById('tpBestTag').textContent = bestTag;
  var bestWR = bestData.trades > 0 ? Math.round((bestData.wins / bestData.trades) * 100) : 0;
  document.getElementById('tpBestTagInfo').textContent = '+$' + bestData.pnl.toFixed(0) + ' | ' + bestWR + '% WR | ' + bestData.trades + ' trades';
  
  if (worstData.pnl < 0) {
    document.getElementById('tpWorstTag').textContent = worstTag;
    var worstWR = worstData.trades > 0 ? Math.round((worstData.wins / worstData.trades) * 100) : 0;
    document.getElementById('tpWorstTagInfo').textContent = '-$' + Math.abs(worstData.pnl).toFixed(0) + ' | ' + worstWR + '% WR | ' + worstData.trades + ' trades';
  } else {
    document.getElementById('tpWorstTag').textContent = '-';
    document.getElementById('tpWorstTagInfo').textContent = 'All tags profitable!';
  }
  
  // Find max values for bar scaling
  var maxPnl = Math.max.apply(null, tagKeys.map(function(k) { return Math.abs(tagData[k].pnl); }));
  
  // Render list
  var html = '';
  tagKeys.forEach(function(tag) {
    var data = tagData[tag];
    var winRate = data.trades > 0 ? Math.round((data.wins / data.trades) * 100) : 0;
    var pnlColor = data.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    var barColor = data.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    var barWidth = maxPnl > 0 ? (Math.abs(data.pnl) / maxPnl) * 100 : 0;
    
    html += '<div class="tag-perf-item">';
    html += '<div class="tag-perf-name"><span class="trade-tag" style="font-size:13px;padding:5px 12px">' + tag + '</span></div>';
    html += '<div class="tag-perf-stats">';
    html += '<div class="tag-perf-stat"><div class="tag-perf-stat-value">' + data.trades + '</div><div class="tag-perf-stat-label">Trades</div></div>';
    html += '<div class="tag-perf-stat"><div class="tag-perf-stat-value">' + winRate + '%</div><div class="tag-perf-stat-label">Win Rate</div></div>';
    html += '<div class="tag-perf-stat"><div class="tag-perf-stat-value" style="color:' + pnlColor + '">' + (data.pnl >= 0 ? '+' : '-') + '$' + Math.abs(data.pnl).toFixed(0) + '</div><div class="tag-perf-stat-label">P/L</div></div>';
    html += '<div class="tag-perf-bar"><div class="tag-perf-bar-fill" style="width:' + barWidth + '%;background:' + barColor + '"></div></div>';
    html += '</div>';
    html += '</div>';
  });
  
  listContainer.innerHTML = html;
}

function renderRiskTracking() {
  var maxRiskPct = settings.defaultRisk || 2;
  var startingBalance = settings.startingBalance || 10000;
  
  // Calculate current balance
  var currentBalance = startingBalance + trades.reduce(function(sum, t) { return sum + t.pnl; }, 0);
  
  // Get trades with risk data
  var tradesWithRisk = trades.filter(function(t) { return t.riskAmount && t.riskAmount > 0; });
  
  var noDataMsg = document.getElementById('riskNoDataMsg');
  var violationsList = document.getElementById('riskViolationsList');
  
  document.getElementById('rtMaxRiskSetting').textContent = maxRiskPct + '%';
  document.getElementById('rtTradesWithRisk').textContent = tradesWithRisk.length;
  document.getElementById('rtTradesWithRiskPct').textContent = trades.length > 0 ? Math.round((tradesWithRisk.length / trades.length) * 100) + '% of trades' : '0%';
  
  if (tradesWithRisk.length === 0) {
    noDataMsg.style.display = 'block';
    violationsList.style.display = 'none';
    document.getElementById('rtCompliance').textContent = '-';
    document.getElementById('rtComplianceInfo').textContent = 'No risk data';
    document.getElementById('rtAvgRisk').textContent = '-';
    document.getElementById('rtAvgRiskPct').textContent = '-';
    document.getElementById('rtMaxRisk').textContent = '-';
    document.getElementById('rtMaxRiskInfo').textContent = '-';
    document.getElementById('rtComplianceBarPct').textContent = '0%';
    document.getElementById('rtComplianceBarFill').style.width = '0%';
    document.getElementById('rtViolations').textContent = '0';
    return;
  }
  
  noDataMsg.style.display = 'none';
  
  // Calculate stats
  var totalRisk = 0;
  var maxRisk = 0;
  var maxRiskTrade = null;
  var violations = [];
  var compliantTrades = 0;
  
  // Sort trades by date for balance calculation at time of trade
  var sortedTrades = trades.slice().sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
  var runningBalance = startingBalance;
  var tradeBalances = {};
  
  sortedTrades.forEach(function(t) {
    tradeBalances[t.id] = runningBalance;
    runningBalance += t.pnl;
  });
  
  tradesWithRisk.forEach(function(t) {
    var balanceAtTrade = tradeBalances[t.id] || startingBalance;
    var riskPct = (t.riskAmount / balanceAtTrade) * 100;
    
    totalRisk += t.riskAmount;
    
    if (t.riskAmount > maxRisk) {
      maxRisk = t.riskAmount;
      maxRiskTrade = t;
    }
    
    if (riskPct <= maxRiskPct * 1.1) { // Allow 10% buffer
      compliantTrades++;
    } else {
      violations.push({
        trade: t,
        riskPct: riskPct,
        balanceAtTrade: balanceAtTrade
      });
    }
  });
  
  var avgRisk = totalRisk / tradesWithRisk.length;
  var avgRiskPct = (avgRisk / currentBalance) * 100;
  var complianceRate = (compliantTrades / tradesWithRisk.length) * 100;
  
  // Update display
  document.getElementById('rtCompliance').textContent = complianceRate.toFixed(0) + '%';
  document.getElementById('rtComplianceInfo').textContent = compliantTrades + ' of ' + tradesWithRisk.length + ' compliant';
  
  var complianceCard = document.getElementById('rtComplianceCard');
  if (complianceRate >= 90) {
    complianceCard.className = 'stat-card positive';
    document.getElementById('rtCompliance').style.color = 'var(--accent-green)';
  } else if (complianceRate >= 70) {
    complianceCard.className = 'stat-card yellow';
    document.getElementById('rtCompliance').style.color = 'var(--accent-yellow)';
  } else {
    complianceCard.className = 'stat-card negative';
    document.getElementById('rtCompliance').style.color = 'var(--accent-red)';
  }
  
  document.getElementById('rtAvgRisk').textContent = '$' + avgRisk.toFixed(0);
  document.getElementById('rtAvgRiskPct').textContent = avgRiskPct.toFixed(2) + '% of account';
  
  document.getElementById('rtMaxRisk').textContent = '$' + maxRisk.toFixed(0);
  var maxRiskCard = document.getElementById('rtMaxRiskCard');
  if (maxRiskTrade) {
    var maxRiskPctActual = (maxRisk / (tradeBalances[maxRiskTrade.id] || startingBalance)) * 100;
    document.getElementById('rtMaxRiskInfo').textContent = maxRiskTrade.symbol + ' (' + maxRiskPctActual.toFixed(1) + '%)';
    
    if (maxRiskPctActual > maxRiskPct * 1.5) {
      maxRiskCard.className = 'stat-card negative';
      document.getElementById('rtMaxRisk').style.color = 'var(--accent-red)';
    } else if (maxRiskPctActual > maxRiskPct) {
      maxRiskCard.className = 'stat-card yellow';
      document.getElementById('rtMaxRisk').style.color = 'var(--accent-yellow)';
    } else {
      maxRiskCard.className = 'stat-card positive';
      document.getElementById('rtMaxRisk').style.color = 'var(--accent-green)';
    }
  }
  
  // Compliance bar
  document.getElementById('rtComplianceBarPct').textContent = complianceRate.toFixed(0) + '%';
  document.getElementById('rtComplianceBarFill').style.width = complianceRate + '%';
  document.getElementById('rtComplianceBarFill').style.background = complianceRate >= 90 ? 'var(--accent-green)' : (complianceRate >= 70 ? 'var(--accent-yellow)' : 'var(--accent-red)');
  document.getElementById('rtViolations').textContent = violations.length;
  
  // Violations list (show last 5)
  if (violations.length > 0) {
    violationsList.style.display = 'block';
    var html = '<div style="font-size:12px;color:var(--text-muted);text-transform:uppercase;margin-bottom:12px">Recent Violations</div>';
    
    violations.sort(function(a, b) { return new Date(b.trade.date) - new Date(a.trade.date); });
    var recentViolations = violations.slice(0, 5);
    
    recentViolations.forEach(function(v) {
      html += '<div class="risk-violation">';
      html += '<div class="risk-violation-icon">‚ö†Ô∏è</div>';
      html += '<div class="risk-violation-info">';
      html += '<div class="risk-violation-title">' + v.trade.symbol + ' - ' + formatDate(v.trade.date) + '</div>';
      html += '<div class="risk-violation-detail">Risked ' + v.riskPct.toFixed(1) + '% (limit: ' + maxRiskPct + '%)</div>';
      html += '</div>';
      html += '<div class="risk-violation-amount">$' + v.trade.riskAmount.toFixed(0) + '</div>';
      html += '</div>';
    });
    
    if (violations.length > 5) {
      html += '<div style="text-align:center;padding:8px;color:var(--text-muted);font-size:12px">+ ' + (violations.length - 5) + ' more violations</div>';
    }
    
    violationsList.innerHTML = html;
  } else {
    violationsList.style.display = 'block';
    violationsList.innerHTML = '<div style="text-align:center;padding:16px;background:var(--accent-green-dim);border-radius:var(--radius-sm);color:var(--accent-green)"><span style="font-size:20px">‚úì</span><div style="margin-top:4px;font-weight:500">All trades within risk limits!</div></div>';
  }
}

function renderDrawdownTracker(sortedTrades) {
  if (!sortedTrades || sortedTrades.length === 0) return;
  
  var startingBalance = settings.startingBalance || 10000;
  var balance = startingBalance;
  var peak = startingBalance;
  var peakDate = null;
  var maxDrawdown = 0;
  var maxDrawdownPct = 0;
  var maxDrawdownDate = null;
  
  var equityData = [{balance: startingBalance, drawdown: 0, date: null}];
  
  for (var i = 0; i < sortedTrades.length; i++) {
    balance += sortedTrades[i].pnl;
    
    if (balance > peak) {
      peak = balance;
      peakDate = sortedTrades[i].date;
    }
    
    var currentDrawdown = peak - balance;
    var currentDrawdownPct = (currentDrawdown / peak) * 100;
    
    if (currentDrawdown > maxDrawdown) {
      maxDrawdown = currentDrawdown;
      maxDrawdownPct = currentDrawdownPct;
      maxDrawdownDate = sortedTrades[i].date;
    }
    
    equityData.push({
      balance: balance,
      peak: peak,
      drawdown: currentDrawdown,
      drawdownPct: currentDrawdownPct,
      date: sortedTrades[i].date
    });
  }
  
  var currentDrawdown = peak - balance;
  var currentDrawdownPct = peak > 0 ? (currentDrawdown / peak) * 100 : 0;
  
  // Update display
  document.getElementById('ddMaxDrawdown').textContent = '-$' + maxDrawdown.toFixed(2);
  document.getElementById('ddMaxDrawdownPct').textContent = maxDrawdownPct.toFixed(1) + '% from peak';
  
  document.getElementById('ddCurrentDrawdown').textContent = currentDrawdown > 0 ? '-$' + currentDrawdown.toFixed(2) : '$0.00';
  document.getElementById('ddCurrentDrawdownPct').textContent = currentDrawdownPct.toFixed(1) + '% from peak';
  
  var currentDDCard = document.getElementById('ddCurrentDrawdown').parentElement;
  if (currentDrawdown > 0) {
    currentDDCard.className = 'stat-card negative';
    document.getElementById('ddCurrentDrawdown').style.color = 'var(--accent-red)';
  } else {
    currentDDCard.className = 'stat-card positive';
    document.getElementById('ddCurrentDrawdown').style.color = 'var(--accent-green)';
  }
  
  document.getElementById('ddPeakBalance').textContent = '$' + peak.toFixed(2);
  document.getElementById('ddPeakDate').textContent = peakDate ? 'Reached ' + formatDate(peakDate) : 'Starting balance';
  
  // Recovery status
  var recoveryEl = document.getElementById('ddRecoveryStatus');
  if (currentDrawdown === 0) {
    recoveryEl.textContent = '‚úì At new highs';
    recoveryEl.style.color = 'var(--accent-green)';
  } else {
    var pctToRecover = ((peak - balance) / balance) * 100;
    recoveryEl.textContent = 'Need +' + pctToRecover.toFixed(1) + '% to recover';
    recoveryEl.style.color = 'var(--accent-yellow)';
  }
  
  // Draw chart
  drawDrawdownChart(equityData, startingBalance, peak);
}

function drawDrawdownChart(data, startingBalance, peak) {
  var canvas = document.getElementById('drawdownChart');
  if (!canvas) return;
  
  var ctx = canvas.getContext('2d');
  var container = document.getElementById('drawdownChartContainer');
  var width = container.clientWidth;
  var height = 120;
  
  canvas.width = width * 2;
  canvas.height = height * 2;
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  ctx.scale(2, 2);
  
  ctx.clearRect(0, 0, width, height);
  
  if (data.length < 2) return;
  
  // Find min/max for scaling
  var minBalance = Math.min.apply(null, data.map(function(d) { return d.balance; }));
  var maxBalance = Math.max.apply(null, data.map(function(d) { return d.balance; }));
  var range = maxBalance - minBalance;
  if (range === 0) range = maxBalance * 0.1;
  
  var padding = 10;
  var chartWidth = width - padding * 2;
  var chartHeight = height - padding * 2;
  
  // Draw peak line (dashed)
  ctx.strokeStyle = 'rgba(0, 212, 161, 0.3)';
  ctx.setLineDash([5, 5]);
  ctx.beginPath();
  var peakY = padding + chartHeight - ((peak - minBalance) / range) * chartHeight;
  ctx.moveTo(padding, peakY);
  ctx.lineTo(width - padding, peakY);
  ctx.stroke();
  ctx.setLineDash([]);
  
  // Draw drawdown area (red fill)
  ctx.fillStyle = 'rgba(239, 83, 80, 0.2)';
  ctx.beginPath();
  for (var i = 0; i < data.length; i++) {
    var x = padding + (i / (data.length - 1)) * chartWidth;
    var yPeak = padding + chartHeight - ((data[i].peak || peak) - minBalance) / range * chartHeight;
    var yBalance = padding + chartHeight - ((data[i].balance) - minBalance) / range * chartHeight;
    
    if (i === 0) {
      ctx.moveTo(x, yPeak);
    } else {
      ctx.lineTo(x, yPeak);
    }
  }
  for (var i = data.length - 1; i >= 0; i--) {
    var x = padding + (i / (data.length - 1)) * chartWidth;
    var yBalance = padding + chartHeight - ((data[i].balance) - minBalance) / range * chartHeight;
    ctx.lineTo(x, yBalance);
  }
  ctx.closePath();
  ctx.fill();
  
  // Draw equity line
  ctx.strokeStyle = '#00d4a1';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (var i = 0; i < data.length; i++) {
    var x = padding + (i / (data.length - 1)) * chartWidth;
    var y = padding + chartHeight - ((data[i].balance - minBalance) / range) * chartHeight;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
}

function loadSettingsPage() {
  document.getElementById('setStartingBalance').value = settings.startingBalance;
  document.getElementById('setCurrency').value = settings.currency;
  document.getElementById('setDefaultRisk').value = settings.defaultRisk;
  document.getElementById('setDefaultDirection').value = settings.defaultDirection;
  document.getElementById('setDefaultStrategy').value = settings.defaultStrategy;
  document.getElementById('setDailyTarget').value = settings.dailyTarget || '';
  document.getElementById('setMaxDailyLoss').value = settings.maxDailyLoss || '';
  document.getElementById('setMaxTradesPerDay').value = settings.maxTradesPerDay || '';
  document.getElementById('setMonthlyTarget').value = settings.monthlyTarget || '';
  
  // Update theme buttons
  updateThemeButtons();
  
  document.getElementById('setTotalTrades').textContent = trades.length;
  document.getElementById('setTotalStrategies').textContent = playbook.length;
  
  var dataSize = (JSON.stringify(trades).length + JSON.stringify(playbook).length + JSON.stringify(settings).length) / 1024;
  document.getElementById('setStorageUsed').textContent = dataSize.toFixed(1) + ' KB';
}

// Subscription functions
var FREE_TRADE_LIMIT = 10;

function getTradesThisMonth() {
  var now = new Date();
  var firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  return trades.filter(function(t) { return t.date >= firstOfMonth; }).length;
}

function getTradesToday() {
  var today = new Date().toISOString().split('T')[0];
  return trades.filter(function(t) { return t.date === today; }).length;
}

function canAddTradeToday() {
  if (!settings.maxTradesPerDay || settings.maxTradesPerDay <= 0) return true;
  return getTradesToday() < settings.maxTradesPerDay;
}

function getTradesRemainingToday() {
  if (!settings.maxTradesPerDay || settings.maxTradesPerDay <= 0) return Infinity;
  return Math.max(0, settings.maxTradesPerDay - getTradesToday());
}

function updateOvertradingWarning() {
  var card = document.getElementById('overtradingCard');
  
  if (!settings.maxTradesPerDay || settings.maxTradesPerDay <= 0) {
    card.style.display = 'none';
    return;
  }
  
  var tradesToday = getTradesToday();
  var maxTrades = settings.maxTradesPerDay;
  var remaining = maxTrades - tradesToday;
  
  // Show if at 80% or more of limit
  if (tradesToday >= maxTrades * 0.8 || tradesToday >= maxTrades) {
    card.style.display = 'block';
    
    document.getElementById('overtradingText').textContent = tradesToday + ' / ' + maxTrades + ' trades today';
    
    if (tradesToday >= maxTrades) {
      // Limit reached
      card.style.borderColor = 'var(--accent-red)';
      document.getElementById('overtradingIcon').textContent = 'üõë';
      document.getElementById('overtradingSubtext').textContent = "You've reached your daily trade limit";
      document.getElementById('overtradingBadge').textContent = 'LIMIT REACHED';
      document.getElementById('overtradingBadge').style.background = 'var(--accent-red-dim)';
      document.getElementById('overtradingBadge').style.color = 'var(--accent-red)';
    } else {
      // Approaching limit
      card.style.borderColor = 'var(--accent-yellow)';
      document.getElementById('overtradingIcon').textContent = '‚ö†Ô∏è';
      document.getElementById('overtradingSubtext').textContent = remaining + ' trade' + (remaining !== 1 ? 's' : '') + ' remaining today';
      document.getElementById('overtradingBadge').textContent = 'APPROACHING LIMIT';
      document.getElementById('overtradingBadge').style.background = 'rgba(255,193,7,0.15)';
      document.getElementById('overtradingBadge').style.color = '#e6a800';
    }
  } else {
    card.style.display = 'none';
  }
}

function isPremium() {
  return settings.subscription === 'premium';
}

function canAddTrade() {
  if (isPremium()) return true;
  return getTradesThisMonth() < FREE_TRADE_LIMIT;
}

function getTradesRemaining() {
  if (isPremium()) return Infinity;
  return Math.max(0, FREE_TRADE_LIMIT - getTradesThisMonth());
}

function loadSubscriptionPage() {
  var tradesThisMonth = getTradesThisMonth();
  var premium = isPremium();
  
  // Update current plan display
  document.getElementById('currentPlanName').textContent = premium ? 'Premium' : 'Free';
  document.getElementById('currentPlanBadge').textContent = premium ? 'Pro' : 'Basic';
  document.getElementById('currentPlanBadge').style.background = premium ? 'var(--accent-green-dim)' : 'var(--bg-elevated)';
  document.getElementById('currentPlanBadge').style.color = premium ? 'var(--accent-green)' : 'var(--text-secondary)';
  
  // Update usage display
  document.getElementById('tradesUsed').textContent = tradesThisMonth;
  document.getElementById('tradesLimit').textContent = premium ? '‚àû' : FREE_TRADE_LIMIT;
  document.getElementById('usageDisplay').style.display = premium ? 'none' : 'block';
  
  // Update progress bar
  var usagePercent = premium ? 0 : Math.min((tradesThisMonth / FREE_TRADE_LIMIT) * 100, 100);
  var progressBar = document.getElementById('usageProgressBar');
  progressBar.style.width = usagePercent + '%';
  if (usagePercent >= 100) {
    progressBar.style.background = 'var(--gradient-red)';
  } else if (usagePercent >= 80) {
    progressBar.style.background = 'linear-gradient(135deg, #ffc107 0%, #e6a800 100%)';
  } else {
    progressBar.style.background = 'var(--gradient-green)';
  }
  
  // Update plan card styling
  document.getElementById('freePlanCard').style.borderColor = premium ? 'var(--border)' : 'var(--accent-blue)';
  document.getElementById('freePlanCard').style.borderWidth = premium ? '1px' : '2px';
  document.getElementById('premiumPlanCard').style.borderColor = premium ? 'var(--accent-green)' : 'var(--accent-green)';
  
  // Update buttons
  document.getElementById('freeSelectBtn').textContent = premium ? 'Downgrade' : 'Current Plan';
  document.getElementById('freeSelectBtn').disabled = !premium;
  document.getElementById('freeSelectBtn').className = premium ? 'btn btn-secondary' : 'btn btn-secondary';
  document.getElementById('freeSelectBtn').style.opacity = premium ? '1' : '0.6';
  
  document.getElementById('premiumSelectBtn').textContent = premium ? 'Current Plan' : 'Upgrade to Premium';
  document.getElementById('premiumSelectBtn').disabled = premium;
  document.getElementById('premiumSelectBtn').className = premium ? 'btn btn-secondary' : 'btn btn-primary';
  document.getElementById('premiumSelectBtn').style.opacity = premium ? '0.6' : '1';
  
  // Update dev toggle
  document.getElementById('devPremiumToggle').checked = premium;
}

function selectPlan(plan) {
  if (plan === 'premium' && !isPremium()) {
    // In production, this would redirect to Stripe checkout
    alert('In production, this would open Stripe checkout.\n\nFor now, use the Developer Testing toggle below to simulate Premium.');
  } else if (plan === 'free' && isPremium()) {
    if (confirm('Are you sure you want to downgrade to Free? You will be limited to 10 trades per month.')) {
      settings.subscription = 'free';
      settings.subscriptionDate = null;
      saveSettingsToStorage();
      loadSubscriptionPage();
      showToast('Downgraded to Free plan');
    }
  }
}

function toggleDevPremium() {
  var isChecked = document.getElementById('devPremiumToggle').checked;
  if (isChecked) {
    settings.subscription = 'premium';
    settings.subscriptionDate = new Date().toISOString();
    showToast('üéâ Premium activated (test mode)');
  } else {
    settings.subscription = 'free';
    settings.subscriptionDate = null;
    // Reset to light theme when downgrading
    if (settings.theme === 'dark') {
      settings.theme = 'light';
      applyTheme();
    }
    showToast('Switched to Free plan');
  }
  saveSettingsToStorage();
  loadSubscriptionPage();
  updateThemeButtons();
}

function setTheme(theme) {
  if (theme === 'dark' && !isPremium()) {
    alert('Dark mode is a Premium feature!\n\nUpgrade to Premium to unlock dark mode and other features.');
    showPage('subscription', document.querySelector('[onclick*="subscription"]'));
    return;
  }
  settings.theme = theme;
  saveSettingsToStorage();
  applyTheme();
  updateThemeButtons();
}

function applyTheme() {
  if (settings.theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
}

function toggleSidebar() {
  var sidebar = document.getElementById('sidebar');
  settings.sidebarCollapsed = !settings.sidebarCollapsed;
  if (settings.sidebarCollapsed) {
    sidebar.classList.add('collapsed');
  } else {
    sidebar.classList.remove('collapsed');
  }
  saveSettingsToStorage();
}

function applySidebarState() {
  var sidebar = document.getElementById('sidebar');
  if (settings.sidebarCollapsed) {
    sidebar.classList.add('collapsed');
  } else {
    sidebar.classList.remove('collapsed');
  }
}

function updateThemeButtons() {
  var darkBtn = document.getElementById('themeDarkBtn');
  var lightBtn = document.getElementById('themeLightBtn');
  var proBadge = document.getElementById('darkPremiumBadge');
  
  if (darkBtn && lightBtn) {
    if (settings.theme === 'dark') {
      darkBtn.className = 'btn btn-primary';
      lightBtn.className = 'btn btn-secondary';
    } else {
      darkBtn.className = 'btn btn-secondary';
      lightBtn.className = 'btn btn-primary';
    }
  }
  
  // Hide PRO badge if user is premium
  if (proBadge) {
    proBadge.style.display = isPremium() ? 'none' : 'inline';
  }
}

function saveAccountSettings() {
  var balance = parseFloat(document.getElementById('setStartingBalance').value);
  if (balance && balance > 0) {
    settings.startingBalance = balance;
    STARTING_BALANCE = balance;
  }
  settings.currency = document.getElementById('setCurrency').value;
  saveSettingsToStorage();
  updateStats();
  showToast('Account settings saved!');
}

function saveDefaultSettings() {
  settings.defaultRisk = parseFloat(document.getElementById('setDefaultRisk').value) || 2;
  settings.defaultDirection = document.getElementById('setDefaultDirection').value;
  settings.defaultStrategy = document.getElementById('setDefaultStrategy').value;
  saveSettingsToStorage();
  showToast('Default settings saved!');
}

function saveGoalSettings() {
  settings.dailyTarget = parseFloat(document.getElementById('setDailyTarget').value) || 0;
  settings.maxDailyLoss = parseFloat(document.getElementById('setMaxDailyLoss').value) || 0;
  settings.maxTradesPerDay = parseInt(document.getElementById('setMaxTradesPerDay').value) || 0;
  settings.monthlyTarget = parseFloat(document.getElementById('setMonthlyTarget').value) || 0;
  saveSettingsToStorage();
  updateGoalProgress();
  showToast('Goals saved!');
}

function updateGoalLive() {
  settings.dailyTarget = parseFloat(document.getElementById('setDailyTarget').value) || 0;
  settings.maxDailyLoss = parseFloat(document.getElementById('setMaxDailyLoss').value) || 0;
  saveSettingsToStorage();
  updateGoalProgress();
}

function exportAllData() {
  var data = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    trades: trades,
    playbook: playbook,
    settings: settings
  };
  var json = JSON.stringify(data, null, 2);
  var blob = new Blob([json], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'tradevault-backup-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Backup exported!');
}

function importAllData(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      
      if (!data.trades || !Array.isArray(data.trades)) {
        alert('Invalid backup file: missing trades data');
        return;
      }
      
      if (!confirm('This will replace all your current data with the backup. Continue?')) return;
      
      trades = data.trades || [];
      playbook = data.playbook || [];
      if (data.settings) {
        settings = Object.assign(settings, data.settings);
        STARTING_BALANCE = settings.startingBalance;
      }
      
      saveTradesToStorage();
      savePlaybookToStorage();
      saveSettingsToStorage();
      
      renderTrades();
      updateStats();
      loadSettingsPage();
      
      showToast('Backup imported successfully!');
    } catch(err) {
      alert('Error reading backup file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearAllTrades() {
  if (!confirm('Delete ALL trades? This cannot be undone.')) return;
  if (!confirm('Are you really sure? All ' + trades.length + ' trades will be permanently deleted.')) return;
  
  trades = [];
  saveTradesToStorage();
  renderTrades();
  renderFullTradeLog();
  updateStats();
  loadSettingsPage();
  showToast('All trades deleted');
}

function clearPlaybook() {
  if (!confirm('Delete ALL playbook strategies? This cannot be undone.')) return;
  
  playbook = [];
  savePlaybookToStorage();
  renderPlaybook();
  loadSettingsPage();
  showToast('Playbook cleared');
}

function resetEverything() {
  if (!confirm('‚ö†Ô∏è RESET EVERYTHING? All trades, playbook, and settings will be deleted.')) return;
  if (!confirm('FINAL WARNING: This will permanently delete all your data. Continue?')) return;
  
  trades = [];
  playbook = [];
  settings = {
    startingBalance: 10000,
    currency: '$',
    defaultRisk: 2,
    defaultDirection: 'long',
    defaultStrategy: '',
    dailyTarget: 0,
    maxDailyLoss: 0,
    monthlyTarget: 0
  };
  STARTING_BALANCE = 10000;
  
  saveTradesToStorage();
  savePlaybookToStorage();
  saveSettingsToStorage();
  
  renderTrades();
  updateStats();
  loadSettingsPage();
  showToast('Everything has been reset');
}

function saveSettingsToStorage() {
  localStorage.setItem('tradingJournalSettings', JSON.stringify(settings));
  saveSettingsToCloud();
  if (currentUser) {
    document.getElementById('userPlan').textContent = isPremium() ? 'Premium' : 'Free';
  }
}

function loadSettingsFromStorage() {
  var stored = localStorage.getItem('tradingJournalSettings');
  if (stored) {
    try { 
      settings = Object.assign(settings, JSON.parse(stored));
      STARTING_BALANCE = settings.startingBalance;
    } catch(e) {}
  }
}

var editingPlaybookId = null;
var tempEntryRules = [];

function addEntryRule() {
  var input = document.getElementById('newEntryRule');
  var rule = input.value.trim();
  if (!rule) return;
  
  tempEntryRules.push(rule);
  input.value = '';
  renderEntryRulesList();
}

function removeEntryRule(index) {
  tempEntryRules.splice(index, 1);
  renderEntryRulesList();
}

function renderEntryRulesList() {
  var container = document.getElementById('entryRulesList');
  if (tempEntryRules.length === 0) {
    container.innerHTML = '<p style="font-size:13px;color:var(--text-muted);text-align:center;padding:8px 0">No rules added yet</p>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < tempEntryRules.length; i++) {
    html += '<div class="checklist-item">';
    html += '<span style="color:var(--accent-green);font-size:14px">‚Ä¢</span>';
    html += '<span>' + tempEntryRules[i] + '</span>';
    html += '<button class="remove-rule" onclick="removeEntryRule(' + i + ')">√ó</button>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function openPlaybookModal(id) {
  editingPlaybookId = id || null;
  document.getElementById('playbookModal').classList.add('active');
  
  if (id) {
    var entry = playbook.find(function(p) { return p.id === id; });
    if (entry) {
      document.getElementById('playbookModalTitle').textContent = 'Edit Strategy';
      document.getElementById('pbName').value = entry.name || '';
      document.getElementById('pbCategory').value = entry.category || 'breakout';
      document.getElementById('pbDescription').value = entry.description || '';
      
      // Handle entryRules - could be array (new) or string (old format)
      if (Array.isArray(entry.entryRules)) {
        tempEntryRules = entry.entryRules.slice();
      } else if (typeof entry.entryRules === 'string' && entry.entryRules.trim()) {
        // Convert old string format to array (split by newlines)
        tempEntryRules = entry.entryRules.split('\n').filter(function(r) { return r.trim(); });
      } else {
        tempEntryRules = [];
      }
      
      document.getElementById('pbStopLoss').value = entry.stopLoss || '';
      document.getElementById('pbTakeProfit').value = entry.takeProfit || '';
      document.getElementById('pbBestConditions').value = entry.bestConditions || '';
      document.getElementById('pbAvoidWhen').value = entry.avoidWhen || '';
      document.getElementById('pbNotes').value = entry.notes || '';
    }
  } else {
    document.getElementById('playbookModalTitle').textContent = 'New Strategy';
    document.getElementById('pbName').value = '';
    document.getElementById('pbCategory').value = 'breakout';
    document.getElementById('pbDescription').value = '';
    tempEntryRules = [];
    document.getElementById('pbStopLoss').value = '';
    document.getElementById('pbTakeProfit').value = '';
    document.getElementById('pbBestConditions').value = '';
    document.getElementById('pbAvoidWhen').value = '';
    document.getElementById('pbNotes').value = '';
  }
  renderEntryRulesList();
}

function closePlaybookModal() {
  document.getElementById('playbookModal').classList.remove('active');
  editingPlaybookId = null;
  tempEntryRules = [];
}

function savePlaybookEntry() {
  var name = document.getElementById('pbName').value.trim();
  if (!name) { alert('Please enter a strategy name'); return; }
  
  var entry = {
    id: editingPlaybookId || Date.now(),
    name: name,
    category: document.getElementById('pbCategory').value,
    description: document.getElementById('pbDescription').value.trim(),
    entryRules: tempEntryRules.slice(),
    stopLoss: document.getElementById('pbStopLoss').value.trim(),
    takeProfit: document.getElementById('pbTakeProfit').value.trim(),
    bestConditions: document.getElementById('pbBestConditions').value.trim(),
    avoidWhen: document.getElementById('pbAvoidWhen').value.trim(),
    notes: document.getElementById('pbNotes').value.trim()
  };
  
  if (editingPlaybookId) {
    var index = playbook.findIndex(function(p) { return p.id === editingPlaybookId; });
    if (index !== -1) playbook[index] = entry;
  } else {
    playbook.unshift(entry);
  }
  
  savePlaybookToStorage();
  syncPlaybookToCloud(entry);
  closePlaybookModal();
  renderPlaybook();
}

function deletePlaybookEntry(id) {
  if (!confirm('Delete this strategy?')) return;
  var entry = playbook.find(function(p) { return p.id === id; });
  if (entry) deletePlaybookFromCloud(entry);
  playbook = playbook.filter(function(p) { return p.id !== id; });
  savePlaybookToStorage();
  renderPlaybook();
}

function togglePlaybookContent(id) {
  var content = document.getElementById('pb-content-' + id);
  if (content) {
    content.classList.toggle('expanded');
  }
}

// ============ JOURNAL FUNCTIONS ============
var currentJournalMood = null;
var editingJournalId = null;

function openJournalModal(date) {
  editingJournalId = null;
  currentJournalMood = null;
  
  document.getElementById('journalModal').classList.add('active');
  document.getElementById('journalModalTitle').textContent = 'New Journal Entry';
  
  // Set date to today or provided date
  var targetDate = date || new Date().toISOString().split('T')[0];
  document.getElementById('journalDate').value = targetDate;
  
  // Check if entry exists for this date
  var existing = journalEntries.find(function(e) { return e.date === targetDate; });
  if (existing) {
    editingJournalId = existing.id;
    document.getElementById('journalModalTitle').textContent = 'Edit Journal Entry';
    document.getElementById('journalPreMarket').value = existing.preMarket || '';
    document.getElementById('journalMarketConditions').value = existing.marketConditions || '';
    document.getElementById('journalReflection').value = existing.reflection || '';
    document.getElementById('journalLessons').value = existing.lessons || '';
    setJournalMood(existing.mood);
  } else {
    document.getElementById('journalPreMarket').value = '';
    document.getElementById('journalMarketConditions').value = '';
    document.getElementById('journalReflection').value = '';
    document.getElementById('journalLessons').value = '';
    clearMoodSelection();
  }
}

function closeJournalModal() {
  document.getElementById('journalModal').classList.remove('active');
  editingJournalId = null;
  currentJournalMood = null;
}

function setJournalMood(mood) {
  currentJournalMood = mood;
  document.querySelectorAll('.mood-btn').forEach(function(btn) {
    btn.classList.remove('active');
    if (btn.dataset.mood === mood) {
      btn.classList.add('active');
    }
  });
}

function clearMoodSelection() {
  currentJournalMood = null;
  document.querySelectorAll('.mood-btn').forEach(function(btn) {
    btn.classList.remove('active');
  });
}

function saveJournalEntry() {
  var date = document.getElementById('journalDate').value;
  if (!date) {
    alert('Please select a date');
    return;
  }
  
  var entry = {
    id: editingJournalId || Date.now(),
    date: date,
    mood: currentJournalMood,
    preMarket: document.getElementById('journalPreMarket').value.trim(),
    marketConditions: document.getElementById('journalMarketConditions').value.trim(),
    reflection: document.getElementById('journalReflection').value.trim(),
    lessons: document.getElementById('journalLessons').value.trim()
  };
  
  // Check if any content
  if (!entry.preMarket && !entry.marketConditions && !entry.reflection && !entry.lessons && !entry.mood) {
    alert('Please add some content to your journal entry');
    return;
  }
  
  if (editingJournalId) {
    var index = journalEntries.findIndex(function(e) { return e.id === editingJournalId; });
    if (index !== -1) journalEntries[index] = entry;
  } else {
    // Check for existing entry on same date
    var existingIndex = journalEntries.findIndex(function(e) { return e.date === date; });
    if (existingIndex !== -1) {
      if (confirm('An entry already exists for this date. Replace it?')) {
        entry.id = journalEntries[existingIndex].id;
        journalEntries[existingIndex] = entry;
      } else {
        return;
      }
    } else {
      journalEntries.unshift(entry);
    }
  }
  
  saveJournalToStorage();
  syncJournalEntryToCloud(entry);
  closeJournalModal();
  showToast('Journal entry saved!');
}

function deleteJournalEntry(id) {
  if (!confirm('Delete this journal entry?')) return;
  journalEntries = journalEntries.filter(function(e) { return e.id !== id; });
  saveJournalToStorage();
  renderJournal();
  showToast('Journal entry deleted');
}

function renderJournal() {
  var today = new Date().toISOString().split('T')[0];
  var todayFormatted = formatJournalDate(today);
  document.getElementById('journalTodayDate').textContent = todayFormatted;
  
  // Render today's entry
  var todayEntry = journalEntries.find(function(e) { return e.date === today; });
  var todayContainer = document.getElementById('todayJournalContent');
  
  if (todayEntry) {
    var todayPnl = getTradePnlForDate(today);
    var pnlColor = todayPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    var pnlStr = todayPnl !== 0 ? '<span style="font-family:JetBrains Mono;color:' + pnlColor + '">' + (todayPnl >= 0 ? '+' : '') + '$' + todayPnl.toFixed(2) + '</span>' : '';
    
    var html = '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">';
    html += '<div style="display:flex;align-items:center;gap:12px">';
    if (todayEntry.mood) html += '<span style="font-size:32px">' + getMoodEmoji(todayEntry.mood) + '</span>';
    html += pnlStr;
    html += '</div>';
    html += '<div style="display:flex;gap:8px">';
    html += '<button class="btn btn-secondary" onclick="openJournalModal(\'' + today + '\')" style="padding:8px 16px;font-size:13px">Edit</button>';
    html += '</div></div>';
    
    if (todayEntry.preMarket) {
      html += '<div class="journal-section"><div class="journal-section-title">üåÖ Pre-Market</div><p style="color:var(--text-secondary);line-height:1.6">' + escapeHtml(todayEntry.preMarket) + '</p></div>';
    }
    if (todayEntry.marketConditions) {
      html += '<div class="journal-section"><div class="journal-section-title">üìä Market Conditions</div><p style="color:var(--text-secondary);line-height:1.6">' + escapeHtml(todayEntry.marketConditions) + '</p></div>';
    }
    if (todayEntry.reflection) {
      html += '<div class="journal-section"><div class="journal-section-title">üåô Reflection</div><p style="color:var(--text-secondary);line-height:1.6">' + escapeHtml(todayEntry.reflection) + '</p></div>';
    }
    if (todayEntry.lessons) {
      html += '<div class="journal-section"><div class="journal-section-title">üí° Lessons</div><p style="color:var(--text-secondary);line-height:1.6">' + escapeHtml(todayEntry.lessons) + '</p></div>';
    }
    
    todayContainer.innerHTML = html;
  } else {
    todayContainer.innerHTML = '<div class="empty-state"><p style="color:var(--text-muted)">No entry for today yet</p></div>';
  }
  
  // Render past entries
  var listContainer = document.getElementById('journalEntriesList');
  var pastEntries = journalEntries.filter(function(e) { return e.date !== today; });
  pastEntries.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  
  document.getElementById('journalCount').textContent = journalEntries.length + ' entr' + (journalEntries.length === 1 ? 'y' : 'ies');
  
  if (pastEntries.length === 0) {
    listContainer.innerHTML = '<div class="empty-state"><p>No past entries</p></div>';
    return;
  }
  
  var html = '';
  pastEntries.forEach(function(entry) {
    var pnl = getTradePnlForDate(entry.date);
    var preview = entry.reflection || entry.preMarket || entry.lessons || entry.marketConditions || '';
    
    html += '<div class="journal-entry" onclick="openJournalModal(\'' + entry.date + '\')">';
    html += '<div class="journal-entry-header">';
    html += '<div><span class="journal-entry-date">' + formatJournalDate(entry.date) + '</span></div>';
    if (pnl !== 0) {
      var pnlColor = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
      html += '<span class="journal-entry-pnl" style="color:' + pnlColor + '">' + (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2) + '</span>';
    }
    html += '</div>';
    if (entry.mood) {
      html += '<div class="journal-entry-mood"><span class="mood-indicator">' + getMoodEmoji(entry.mood) + '</span></div>';
    }
    if (preview) {
      html += '<div class="journal-entry-preview">' + escapeHtml(preview) + '</div>';
    }
    html += '</div>';
  });
  
  listContainer.innerHTML = html;
}

function getTradePnlForDate(date) {
  return trades.filter(function(t) { return t.date === date; })
    .reduce(function(sum, t) { return sum + t.pnl; }, 0);
}

function formatJournalDate(dateStr) {
  var date = new Date(dateStr + 'T12:00:00');
  var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return days[date.getDay()] + ', ' + months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
}

function getMoodEmoji(mood) {
  var moods = { great: 'üòÑ', good: 'üôÇ', neutral: 'üòê', bad: 'üòû', terrible: 'üò´' };
  return moods[mood] || '';
}

function saveJournalToStorage() {
  localStorage.setItem('tradingJournalEntries', JSON.stringify(journalEntries));
}

function loadJournalFromStorage() {
  var stored = localStorage.getItem('tradingJournalEntries');
  if (stored) {
    try { journalEntries = JSON.parse(stored); } catch(e) {}
  }
}

function getStrategyStats(strategyName) {
  var strategyTrades = trades.filter(function(t) {
    return t.strategy && t.strategy.toLowerCase() === strategyName.toLowerCase();
  });
  
  if (strategyTrades.length === 0) return null;
  
  var wins = strategyTrades.filter(function(t) { return t.pnl > 0; });
  var totalPnl = strategyTrades.reduce(function(s, t) { return s + t.pnl; }, 0);
  var winRate = (wins.length / strategyTrades.length) * 100;
  
  var rTrades = strategyTrades.filter(function(t) { return t.rMultiple !== null; });
  var avgR = rTrades.length > 0 ? rTrades.reduce(function(s, t) { return s + t.rMultiple; }, 0) / rTrades.length : null;
  
  return {
    trades: strategyTrades.length,
    wins: wins.length,
    winRate: winRate,
    pnl: totalPnl,
    avgR: avgR
  };
}

function renderPlaybook() {
  var list = document.getElementById('playbookList');
  var empty = document.getElementById('playbookEmpty');
  
  if (playbook.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  
  empty.style.display = 'none';
  var html = '';
  
  playbook.forEach(function(entry) {
    // Get stats by strategy NAME (not category)
    var stats = getStrategyStats(entry.name);
    
    html += '<div class="playbook-card">';
    html += '<div class="playbook-card-header" onclick="togglePlaybookContent(' + entry.id + ')">';
    html += '<div><div class="playbook-title-row">';
    html += '<span class="playbook-category ' + entry.category + '">' + entry.category + '</span>';
    html += '<span class="playbook-name">' + entry.name + '</span>';
    html += '</div>';
    
    // Show stats if trades exist for this strategy name
    if (stats) {
      html += '<div class="playbook-stats">';
      html += '<div class="playbook-stat"><div class="playbook-stat-value">' + stats.trades + '</div><div class="playbook-stat-label">Trades</div></div>';
      html += '<div class="playbook-stat"><div class="playbook-stat-value">' + stats.winRate.toFixed(0) + '%</div><div class="playbook-stat-label">Win Rate</div></div>';
      html += '<div class="playbook-stat"><div class="playbook-stat-value" style="color:' + (stats.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (stats.pnl >= 0 ? '+' : '') + '$' + Math.abs(stats.pnl).toFixed(0) + '</div><div class="playbook-stat-label">P/L</div></div>';
      if (stats.avgR !== null) {
        html += '<div class="playbook-stat"><div class="playbook-stat-value">' + (stats.avgR >= 0 ? '+' : '') + stats.avgR.toFixed(2) + 'R</div><div class="playbook-stat-label">Avg R</div></div>';
      }
      html += '</div>';
    } else {
      html += '<div class="playbook-stats"><span style="font-size:12px;color:var(--text-muted)">No trades with this strategy yet</span></div>';
    }
    
    html += '</div>';
    html += '<div class="playbook-actions" onclick="event.stopPropagation()">';
    html += '<button class="playbook-btn" onclick="openPlaybookModal(' + entry.id + ')">Edit</button>';
    html += '<button class="playbook-btn delete" onclick="deletePlaybookEntry(' + entry.id + ')">Delete</button>';
    html += '</div></div>';
    
    // Expandable content
    html += '<div class="playbook-content" id="pb-content-' + entry.id + '">';
    
    if (entry.description) {
      html += '<div class="playbook-section"><div class="playbook-section-title">Description</div><div class="playbook-section-text">' + escapeHtml(entry.description) + '</div></div>';
    }
    
    if (entry.entryRules && ((Array.isArray(entry.entryRules) && entry.entryRules.length > 0) || (typeof entry.entryRules === 'string' && entry.entryRules.trim()))) {
      var rules = Array.isArray(entry.entryRules) ? entry.entryRules : entry.entryRules.split('\n').filter(function(r) { return r.trim(); });
      html += '<div class="playbook-section"><div class="playbook-section-title">Entry Rules Checklist</div><div style="margin-top:8px">';
      for (var i = 0; i < rules.length; i++) {
        html += '<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--bg-elevated);border-radius:var(--radius-sm);margin-bottom:6px">';
        html += '<span style="color:var(--accent-green)">‚òë</span>';
        html += '<span style="font-size:14px">' + escapeHtml(rules[i]) + '</span>';
        html += '</div>';
      }
      html += '</div></div>';
    }
    
    html += '<div class="playbook-grid">';
    if (entry.stopLoss) {
      html += '<div class="playbook-section"><div class="playbook-section-title">Stop Loss Rules</div><div class="playbook-section-text">' + escapeHtml(entry.stopLoss) + '</div></div>';
    }
    if (entry.takeProfit) {
      html += '<div class="playbook-section"><div class="playbook-section-title">Take Profit Rules</div><div class="playbook-section-text">' + escapeHtml(entry.takeProfit) + '</div></div>';
    }
    html += '</div>';
    
    html += '<div class="playbook-grid">';
    if (entry.bestConditions) {
      html += '<div class="playbook-section"><div class="playbook-section-title">Best Conditions</div><div class="playbook-section-text">' + escapeHtml(entry.bestConditions) + '</div></div>';
    }
    if (entry.avoidWhen) {
      html += '<div class="playbook-section"><div class="playbook-section-title">Avoid When</div><div class="playbook-section-text">' + escapeHtml(entry.avoidWhen) + '</div></div>';
    }
    html += '</div>';
    
    if (entry.notes) {
      html += '<div class="playbook-section"><div class="playbook-section-title">Notes / Lessons Learned</div><div class="playbook-section-text">' + escapeHtml(entry.notes) + '</div></div>';
    }
    
    html += '</div></div>';
  });
  
  list.innerHTML = html;
}

function escapeHtml(text) {
  var div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function savePlaybookToStorage() {
  localStorage.setItem('tradingJournalPlaybook', JSON.stringify(playbook));
}

function loadPlaybookFromStorage() {
  var stored = localStorage.getItem('tradingJournalPlaybook');
  if (stored) {
    try { playbook = JSON.parse(stored); } catch(e) {}
  }
}

function setRiskPercent(pct) {
  document.getElementById('rcRiskPercent').value = pct;
  calculateRisk();
}

function useCurrentBalance() {
  var totalPnl = trades.reduce(function(s, t) { return s + t.pnl; }, 0);
  var balance = STARTING_BALANCE + totalPnl;
  document.getElementById('rcAccountBalance').value = balance.toFixed(2);
  calculateRisk();
}

function calculateRisk() {
  var balance = parseFloat(document.getElementById('rcAccountBalance').value) || 0;
  var riskPct = parseFloat(document.getElementById('rcRiskPercent').value) || 0;
  
  // Set default risk if empty
  if (!document.getElementById('rcRiskPercent').value && settings.defaultRisk) {
    document.getElementById('rcRiskPercent').value = settings.defaultRisk;
    riskPct = settings.defaultRisk;
  }
  
  var entry = parseFloat(document.getElementById('rcEntryPrice').value) || 0;
  var stopLoss = parseFloat(document.getElementById('rcStopLoss').value) || 0;
  var takeProfit = parseFloat(document.getElementById('rcTakeProfit').value) || 0;
  var direction = document.getElementById('rcDirection').value;
  
  // Update current balance display
  var totalPnl = trades.reduce(function(s, t) { return s + t.pnl; }, 0);
  document.getElementById('rcCurrentBal').textContent = (STARTING_BALANCE + totalPnl).toLocaleString('en-US', {minimumFractionDigits: 2});
  
  // Reset displays
  document.getElementById('rcWarning').style.display = 'none';
  document.getElementById('rcRewardRow').style.display = 'none';
  document.getElementById('rcRRRow').style.display = 'none';
  document.getElementById('rcVisual').style.display = 'none';
  
  // Validate inputs
  if (!balance || !riskPct) {
    document.getElementById('rcRiskAmount').textContent = '$0.00';
    return;
  }
  
  // Calculate risk amount
  var riskAmount = balance * (riskPct / 100);
  document.getElementById('rcRiskAmount').textContent = '$' + riskAmount.toFixed(2) + ' (' + riskPct + '% of account)';
  
  // If entry and stop loss provided, validate direction and calculate R:R
  if (entry > 0 && stopLoss > 0) {
    var riskPerUnit;
    if (direction === 'long') {
      riskPerUnit = entry - stopLoss;
    } else {
      riskPerUnit = stopLoss - entry;
    }
    
    // Validate stop loss direction
    if (riskPerUnit <= 0) {
      document.getElementById('rcWarning').style.display = 'block';
      document.getElementById('rcWarningText').textContent = direction === 'long' 
        ? 'Stop loss must be below entry price for long positions' 
        : 'Stop loss must be above entry price for short positions';
      return;
    }
    
    // Calculate reward if take profit is set
    if (takeProfit > 0) {
      var rewardPerUnit;
      if (direction === 'long') {
        rewardPerUnit = takeProfit - entry;
      } else {
        rewardPerUnit = entry - takeProfit;
      }
      
      if (rewardPerUnit > 0) {
        var rrRatio = rewardPerUnit / riskPerUnit;
        var rewardAmount = riskAmount * rrRatio;
        
        document.getElementById('rcRewardRow').style.display = 'flex';
        document.getElementById('rcRRRow').style.display = 'flex';
        document.getElementById('rcRewardAmount').textContent = '$' + rewardAmount.toFixed(2);
        document.getElementById('rcRiskReward').textContent = '1:' + rrRatio.toFixed(2);
        
        // Color the R:R based on quality
        var rrColor = rrRatio >= 2 ? 'var(--accent-green)' : (rrRatio >= 1 ? 'var(--accent-yellow)' : 'var(--accent-red)');
        document.getElementById('rcRiskReward').style.color = rrColor;
        
        // Show visual
        document.getElementById('rcVisual').style.display = 'block';
        var totalRange = riskPerUnit + rewardPerUnit;
        var riskPctBar = (riskPerUnit / totalRange) * 100;
        var rewardPctBar = (rewardPerUnit / totalRange) * 100;
        
        document.getElementById('rcRiskBar').style.width = riskPctBar + '%';
        document.getElementById('rcRewardBar').style.width = rewardPctBar + '%';
        document.getElementById('rcEntryMarker').style.left = riskPctBar + '%';
        
        document.getElementById('rcSLPrice').textContent = '$' + stopLoss.toFixed(2);
        document.getElementById('rcEntryPriceLabel').textContent = '$' + entry.toFixed(2);
        document.getElementById('rcTPPrice').textContent = '$' + takeProfit.toFixed(2);
      } else {
        document.getElementById('rcWarning').style.display = 'block';
        document.getElementById('rcWarningText').textContent = direction === 'long'
          ? 'Take profit must be above entry price for long positions'
          : 'Take profit must be below entry price for short positions';
      }
    }
  }
}

var tradingMode = 'spot';

function setTradingMode(mode) {
  tradingMode = mode;
  
  // Update buttons
  document.getElementById('spotModeBtn').className = mode === 'spot' ? 'btn btn-primary' : 'btn btn-secondary';
  document.getElementById('marginModeBtn').className = mode === 'margin' ? 'btn btn-primary' : 'btn btn-secondary';
  
  // Show/hide inputs and results
  document.getElementById('spotInputs').style.display = mode === 'spot' ? 'block' : 'none';
  document.getElementById('spotResults').style.display = mode === 'spot' ? 'block' : 'none';
  document.getElementById('spotReference').style.display = mode === 'spot' ? 'block' : 'none';
  
  document.getElementById('marginInputs').style.display = mode === 'margin' ? 'block' : 'none';
  document.getElementById('marginResults').style.display = mode === 'margin' ? 'block' : 'none';
  document.getElementById('marginReference').style.display = mode === 'margin' ? 'block' : 'none';
  
  // Calculate based on mode
  if (mode === 'spot') {
    calculateRisk();
  } else {
    calculateMarginRisk();
  }
}

function calculateMarginRisk() {
  var positionSize = parseFloat(document.getElementById('rcMarginPositionSize').value) || 0;
  var leverage = parseFloat(document.getElementById('rcLeverage').value) || 10;
  var entry = parseFloat(document.getElementById('rcMarginEntryPrice').value) || 0;
  var stopLoss = parseFloat(document.getElementById('rcMarginStopLoss').value) || 0;
  var takeProfit = parseFloat(document.getElementById('rcMarginTakeProfit').value) || 0;
  var direction = document.getElementById('rcMarginDirection').value;
  
  // Reset displays
  document.getElementById('rcMarginWarning').style.display = 'none';
  document.getElementById('rcMarginRewardRow').style.display = 'none';
  document.getElementById('rcMarginRRRow').style.display = 'none';
  document.getElementById('rcMarginVisual').style.display = 'none';
  
  // Validate inputs
  if (!positionSize || !entry || !stopLoss) {
    document.getElementById('rcMarginRequired').textContent = '$0.00';
    document.getElementById('rcMarginPositionValue').textContent = '$0.00';
    document.getElementById('rcMarginRiskAmount').textContent = '$0.00';
    document.getElementById('rcMarginRiskPercent').textContent = '0%';
    document.getElementById('rcLiquidationPrice').textContent = '$0.00';
    document.getElementById('rcLiquidationDistance').textContent = '0%';
    return;
  }
  
  // Calculate margin required
  var marginRequired = positionSize / leverage;
  
  // Calculate price movement percentages
  var slDistance, slPercent;
  if (direction === 'long') {
    slDistance = entry - stopLoss;
    slPercent = (slDistance / entry) * 100;
  } else {
    slDistance = stopLoss - entry;
    slPercent = (slDistance / entry) * 100;
  }
  
  // Validate stop loss direction
  if (slDistance <= 0) {
    document.getElementById('rcMarginWarning').style.display = 'block';
    document.getElementById('rcMarginWarningText').textContent = direction === 'long' 
      ? 'Stop loss must be below entry price for long positions' 
      : 'Stop loss must be above entry price for short positions';
    return;
  }
  
  // Calculate risk amount (loss if SL is hit)
  var riskAmount = positionSize * (slPercent / 100);
  var riskPercentOfMargin = (riskAmount / marginRequired) * 100;
  
  // Calculate liquidation price (simplified - assumes 100% margin loss = liquidation)
  // In reality, exchanges have maintenance margin requirements
  var liqPercent = 100 / leverage; // Price move % that wipes margin
  var liquidationPrice;
  if (direction === 'long') {
    liquidationPrice = entry * (1 - liqPercent / 100);
  } else {
    liquidationPrice = entry * (1 + liqPercent / 100);
  }
  
  var liqDistance = Math.abs(entry - liquidationPrice);
  var liqDistancePercent = (liqDistance / entry) * 100;
  
  // Display results
  document.getElementById('rcMarginRequired').textContent = '$' + marginRequired.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('rcMarginPositionValue').textContent = '$' + positionSize.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('rcMarginRiskAmount').textContent = '$' + riskAmount.toFixed(2);
  document.getElementById('rcMarginRiskPercent').textContent = riskPercentOfMargin.toFixed(1) + '% of margin';
  document.getElementById('rcLiquidationPrice').textContent = '$' + liquidationPrice.toFixed(2);
  document.getElementById('rcLiquidationDistance').textContent = liqDistancePercent.toFixed(2) + '% from entry';
  
  // Warning if stop loss is beyond liquidation
  if ((direction === 'long' && stopLoss <= liquidationPrice) || (direction === 'short' && stopLoss >= liquidationPrice)) {
    document.getElementById('rcMarginWarning').style.display = 'block';
    document.getElementById('rcMarginWarningText').textContent = '‚ö†Ô∏è Stop loss is beyond liquidation price! You will be liquidated before your stop is hit.';
  } else if (riskPercentOfMargin > 50) {
    document.getElementById('rcMarginWarning').style.display = 'block';
    document.getElementById('rcMarginWarningText').textContent = '‚ö†Ô∏è High risk! You\'re risking ' + riskPercentOfMargin.toFixed(0) + '% of your margin on this trade.';
  }
  
  // Calculate reward if take profit is set
  if (takeProfit > 0) {
    var tpDistance, tpPercent;
    if (direction === 'long') {
      tpDistance = takeProfit - entry;
      tpPercent = (tpDistance / entry) * 100;
    } else {
      tpDistance = entry - takeProfit;
      tpPercent = (tpDistance / entry) * 100;
    }
    
    if (tpDistance > 0) {
      var rewardAmount = positionSize * (tpPercent / 100);
      var rrRatio = tpDistance / slDistance;
      
      document.getElementById('rcMarginRewardRow').style.display = 'flex';
      document.getElementById('rcMarginRRRow').style.display = 'flex';
      document.getElementById('rcMarginRewardAmount').textContent = '$' + rewardAmount.toFixed(2) + ' (' + (rewardAmount / marginRequired * 100).toFixed(1) + '% of margin)';
      document.getElementById('rcMarginRiskReward').textContent = '1:' + rrRatio.toFixed(2);
      
      // Color the R:R based on quality
      var rrColor = rrRatio >= 2 ? 'var(--accent-green)' : (rrRatio >= 1 ? 'var(--accent-yellow)' : 'var(--accent-red)');
      document.getElementById('rcMarginRiskReward').style.color = rrColor;
      
      // Show visual
      document.getElementById('rcMarginVisual').style.display = 'block';
      
      // Calculate bar positions
      var totalRange = Math.abs(liquidationPrice - takeProfit);
      var riskZone, rewardZone, entryPos, slPos;
      
      if (direction === 'long') {
        entryPos = ((entry - liquidationPrice) / totalRange) * 100;
        slPos = ((stopLoss - liquidationPrice) / totalRange) * 100;
        riskZone = entryPos;
        rewardZone = 100 - entryPos;
      } else {
        entryPos = ((takeProfit - entry) / totalRange) * 100;
        slPos = ((takeProfit - stopLoss) / totalRange) * 100;
        riskZone = 100 - entryPos;
        rewardZone = entryPos;
      }
      
      document.getElementById('rcMarginRiskBar').style.width = riskZone + '%';
      document.getElementById('rcMarginRewardBar').style.width = rewardZone + '%';
      document.getElementById('rcMarginEntryMarker').style.left = entryPos + '%';
      document.getElementById('rcMarginSLMarker').style.left = slPos + '%';
      
      document.getElementById('rcMarginLiqPrice').textContent = '$' + liquidationPrice.toFixed(2);
      document.getElementById('rcMarginEntryLabel').textContent = '$' + entry.toFixed(2);
      document.getElementById('rcMarginTPLabel').textContent = '$' + takeProfit.toFixed(2);
      
      // Update labels based on direction
      if (direction === 'long') {
        document.getElementById('rcMarginLeftLabel').textContent = 'LIQUIDATION';
        document.getElementById('rcMarginRightLabel').textContent = 'TAKE PROFIT';
      } else {
        document.getElementById('rcMarginLeftLabel').textContent = 'TAKE PROFIT';
        document.getElementById('rcMarginRightLabel').textContent = 'LIQUIDATION';
      }
    } else {
      document.getElementById('rcMarginWarning').style.display = 'block';
      document.getElementById('rcMarginWarningText').textContent = direction === 'long'
        ? 'Take profit must be above entry price for long positions'
        : 'Take profit must be below entry price for short positions';
    }
  }
}

var calendarDate = new Date();
var selectedCalendarDate = null;

function prevMonth() {
  calendarDate.setMonth(calendarDate.getMonth() - 1);
  renderCalendar();
}

function nextMonth() {
  calendarDate.setMonth(calendarDate.getMonth() + 1);
  renderCalendar();
}

function renderCalendar() {
  var year = calendarDate.getFullYear();
  var month = calendarDate.getMonth();
  var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calMonthTitle').textContent = monthNames[month] + ' ' + year;

  // Get daily P/L for this month
  var dailyData = {};
  var monthTrades = 0;
  var monthPnl = 0;
  trades.forEach(function(t) {
    var d = new Date(t.date);
    if (d.getFullYear() === year && d.getMonth() === month) {
      var key = t.date;
      if (!dailyData[key]) dailyData[key] = { pnl: 0, trades: 0, list: [] };
      dailyData[key].pnl += t.pnl;
      dailyData[key].trades++;
      dailyData[key].list.push(t);
      monthPnl += t.pnl;
      monthTrades++;
    }
  });

  // Update month stats
  document.getElementById('calMonthPnl').textContent = (monthPnl >= 0 ? '+$' : '-$') + Math.abs(monthPnl).toFixed(2);
  document.getElementById('calMonthPnl').style.color = monthPnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  document.getElementById('calMonthTrades').textContent = monthTrades + ' trade' + (monthTrades !== 1 ? 's' : '');
  document.getElementById('calPnlCard').className = 'stat-card ' + (monthTrades === 0 ? 'neutral' : (monthPnl >= 0 ? 'positive' : 'negative'));

  var profitDays = 0, lossDays = 0;
  Object.keys(dailyData).forEach(function(k) {
    if (dailyData[k].pnl > 0) profitDays++;
    else if (dailyData[k].pnl < 0) lossDays++;
  });
  document.getElementById('calProfitDays').textContent = profitDays;
  document.getElementById('calLossDays').textContent = lossDays;
  var totalDays = profitDays + lossDays;
  document.getElementById('calProfitDaysInfo').textContent = totalDays > 0 ? ((profitDays / totalDays * 100).toFixed(0) + '% of trading days') : 'No trading days';
  document.getElementById('calLossDaysInfo').textContent = totalDays > 0 ? ((lossDays / totalDays * 100).toFixed(0) + '% of trading days') : 'No trading days';

  // Build calendar grid
  var firstDay = new Date(year, month, 1).getDay();
  var daysInMonth = new Date(year, month + 1, 0).getDate();
  var today = new Date();
  var todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

  var html = '';
  // Empty cells before first day
  for (var i = 0; i < firstDay; i++) {
    html += '<div class="calendar-day empty"></div>';
  }

  // Days of month
  for (var d = 1; d <= daysInMonth; d++) {
    var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    var data = dailyData[dateStr];
    var cls = 'calendar-day';
    if (data) cls += data.pnl > 0 ? ' positive' : (data.pnl < 0 ? ' negative' : '');
    if (dateStr === todayStr) cls += ' today';
    if (dateStr === selectedCalendarDate) cls += ' selected';

    html += '<div class="' + cls + '" onclick="selectCalendarDay(\'' + dateStr + '\')">';
    html += '<div class="calendar-day-number">' + d + '</div>';
    if (data) {
      html += '<div class="calendar-day-pnl">' + (data.pnl >= 0 ? '+' : '') + '$' + Math.abs(data.pnl).toFixed(0) + '</div>';
      html += '<div class="calendar-day-trades">' + data.trades + ' trade' + (data.trades !== 1 ? 's' : '') + '</div>';
    }
    html += '</div>';
  }

  document.getElementById('calendarGrid').innerHTML = html;

  // Show selected day details if any
  if (selectedCalendarDate && dailyData[selectedCalendarDate]) {
    showDayDetails(selectedCalendarDate, dailyData[selectedCalendarDate]);
  } else {
    document.getElementById('calDailyBreakdown').innerHTML = '<div class="empty-state"><p>Click on a day to see trade details</p></div>';
  }
}

function selectCalendarDay(dateStr) {
  selectedCalendarDate = dateStr;
  renderCalendar();
}

function showDayDetails(dateStr, data) {
  var html = '';
  var d = new Date(dateStr);
  var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var dateLabel = dayNames[d.getDay()] + ', ' + monthNames[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();

  html += '<div class="quick-stat-item"><span class="quick-stat-label">' + dateLabel + '</span><span class="quick-stat-value" style="color:' + (data.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (data.pnl >= 0 ? '+' : '') + '$' + Math.abs(data.pnl).toFixed(2) + '</span></div>';

  data.list.forEach(function(t) {
    html += '<div class="quick-stat-item">';
    html += '<span class="quick-stat-label" style="display:flex;align-items:center;gap:8px"><span class="trade-direction ' + t.direction + '" style="font-size:11px">' + (t.direction === 'long' ? '‚Üë' : '‚Üì') + '</span> ' + t.symbol + '</span>';
    html += '<span class="quick-stat-value" style="color:' + (t.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)') + '">' + (t.pnl >= 0 ? '+' : '') + '$' + Math.abs(t.pnl).toFixed(2) + '</span>';
    html += '</div>';
  });

  document.getElementById('calDailyBreakdown').innerHTML = html;
}

var tradeImageData = null;
var currentViewingTradeId = null;
var currentTradeRating = 0;
var currentTradeTags = [];

function openTradeDetails(tradeId) {
  var trade = trades.find(function(t) { return t.id === tradeId; });
  if (!trade) return;
  
  currentViewingTradeId = tradeId;
  
  document.getElementById('detailsTitle').textContent = trade.symbol;
  document.getElementById('detailsDirection').textContent = trade.direction === 'long' ? '‚Üë Long' : '‚Üì Short';
  document.getElementById('detailsDirection').className = 'trade-direction ' + trade.direction;
  document.getElementById('detailsDate').textContent = formatDate(trade.date);
  document.getElementById('detailsStrategy').textContent = trade.strategy ? 'Strategy: ' + trade.strategy : 'No strategy';
  
  // Show rating
  var ratingEl = document.getElementById('detailsRating');
  if (trade.rating && trade.rating > 0) {
    ratingEl.innerHTML = renderStars(trade.rating);
    ratingEl.style.display = 'block';
  } else {
    ratingEl.style.display = 'none';
  }
  
  // Show tags
  var tagsEl = document.getElementById('detailsTags');
  if (trade.tags && trade.tags.length > 0) {
    tagsEl.innerHTML = renderTagsDisplay(trade.tags);
    tagsEl.style.display = 'flex';
  } else {
    tagsEl.style.display = 'none';
  }
  
  var pnlEl = document.getElementById('detailsPnl');
  pnlEl.textContent = (trade.pnl >= 0 ? '+$' : '-$') + Math.abs(trade.pnl).toFixed(2);
  pnlEl.style.color = trade.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
  
  var rEl = document.getElementById('detailsRMultiple');
  if (trade.rMultiple !== null) {
    rEl.textContent = (trade.rMultiple >= 0 ? '+' : '') + trade.rMultiple.toFixed(2) + 'R';
    rEl.style.color = trade.rMultiple >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
    rEl.style.display = 'block';
  } else {
    rEl.style.display = 'none';
  }
  
  document.getElementById('detailsEntry').textContent = trade.entry ? '$' + trade.entry.toFixed(2) : '-';
  document.getElementById('detailsExit').textContent = trade.exit ? '$' + trade.exit.toFixed(2) : '-';
  document.getElementById('detailsQuantity').textContent = trade.quantity || '-';
  document.getElementById('detailsStopLoss').textContent = trade.stopLoss ? '$' + trade.stopLoss.toFixed(2) : '-';
  document.getElementById('detailsRiskAmount').textContent = trade.riskAmount ? '$' + trade.riskAmount.toFixed(2) : '-';
  
  document.getElementById('detailsNotes').textContent = trade.notes || 'No notes for this trade.';
  
  var imageSection = document.getElementById('detailsImageSection');
  if (trade.image) {
    document.getElementById('detailsImage').src = trade.image;
    imageSection.style.display = 'block';
  } else {
    imageSection.style.display = 'none';
  }
  
  document.getElementById('tradeDetailsModal').classList.add('active');
}

function closeTradeDetails() {
  document.getElementById('tradeDetailsModal').classList.remove('active');
  currentViewingTradeId = null;
}

function deleteTradeFromDetails() {
  if (!currentViewingTradeId) return;
  if (!confirm('Delete this trade?')) return;
  
  trades = trades.filter(function(t) { return t.id !== currentViewingTradeId; });
  saveTradesToStorage();
  closeTradeDetails();
  renderTrades();
  renderFullTradeLog();
  updateStats();
  showToast('Trade deleted');
}

function editTradeFromDetails() {
  if (!currentViewingTradeId) return;
  var trade = trades.find(function(t) { return t.id === currentViewingTradeId; });
  if (!trade) return;
  
  closeTradeDetails();
  openEditModal(trade);
}

function openEditModal(trade) {
  document.getElementById('tradeModal').classList.add('active');
  document.getElementById('tradeDate').value = trade.date;
  document.getElementById('tradeTime').value = trade.time || '';
  document.getElementById('symbol').value = trade.symbol;
  document.getElementById('direction').value = trade.direction;
  document.getElementById('tradePnl').value = trade.pnl;
  document.getElementById('quantity').value = trade.quantity || '';
  document.getElementById('entryPrice').value = trade.entry || '';
  document.getElementById('exitPrice').value = trade.exit || '';
  document.getElementById('stopLoss').value = trade.stopLoss || '';
  document.getElementById('riskAmount').value = trade.riskAmount || '';
  document.getElementById('notes').value = trade.notes || '';
  
  // Populate strategy dropdown
  var strategySelect = document.getElementById('strategy');
  var html = '<option value="">Select...</option>';
  if (playbook.length > 0) {
    playbook.forEach(function(p) {
      html += '<option value="' + p.name + '">' + p.name + '</option>';
    });
    html += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
  }
  html += '<option value="breakout">Breakout</option>';
  html += '<option value="pullback">Pullback</option>';
  html += '<option value="reversal">Reversal</option>';
  html += '<option value="momentum">Momentum</option>';
  html += '<option value="scalp">Scalp</option>';
  html += '<option value="swing">Swing</option>';
  strategySelect.innerHTML = html;
  strategySelect.value = trade.strategy || '';
  
  // Handle image
  if (trade.image) {
    tradeImageData = trade.image;
    document.getElementById('imagePreview').src = trade.image;
    document.getElementById('imagePreviewContainer').style.display = 'block';
  } else {
    tradeImageData = null;
    document.getElementById('imagePreviewContainer').style.display = 'none';
  }
  
  // Handle rating
  currentTradeRating = trade.rating || 0;
  setTradeRating(currentTradeRating);
  
  // Handle tags
  currentTradeTags = trade.tags ? trade.tags.slice() : [];
  renderTradeTags();
  
  // Change modal to edit mode
  document.querySelector('#tradeModal .modal-title').textContent = 'Edit Trade';
  document.querySelector('#tradeModal .modal-footer').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()" style="padding:14px 28px;font-size:15px">Cancel</button><button class="btn btn-primary" onclick="updateTrade(' + trade.id + ')" style="padding:14px 36px;font-size:15px">Update Trade</button>';
}

function updateTrade(tradeId) {
  var symbol = document.getElementById('symbol').value.toUpperCase().trim();
  var date = document.getElementById('tradeDate').value;
  var time = document.getElementById('tradeTime').value || null;
  var direction = document.getElementById('direction').value;
  var pnl = parseFloat(document.getElementById('tradePnl').value);
  var quantity = parseFloat(document.getElementById('quantity').value) || null;
  var entry = parseFloat(document.getElementById('entryPrice').value) || null;
  var exit = parseFloat(document.getElementById('exitPrice').value) || null;
  var stopLoss = parseFloat(document.getElementById('stopLoss').value) || null;
  var riskAmount = parseFloat(document.getElementById('riskAmount').value) || null;
  var strategy = document.getElementById('strategy').value;
  var notes = document.getElementById('notes').value;
  
  if (!symbol || !date || isNaN(pnl)) { alert('Please fill in Symbol, Date, and P/L'); return; }
  
  var rMultiple = null;
  if (riskAmount && riskAmount > 0) {
    rMultiple = pnl / riskAmount;
  } else if (stopLoss && entry && quantity) {
    var risk = direction === 'long' ? entry - stopLoss : stopLoss - entry;
    if (risk > 0) rMultiple = pnl / (risk * quantity);
  }
  
  var index = trades.findIndex(function(t) { return t.id === tradeId; });
  if (index !== -1) {
    trades[index] = {
      id: tradeId,
      symbol: symbol,
      date: date,
      time: time,
      direction: direction,
      entry: entry,
      exit: exit,
      quantity: quantity,
      stopLoss: stopLoss,
      pnl: pnl,
      rMultiple: rMultiple,
      riskAmount: riskAmount,
      strategy: strategy,
      notes: notes,
      image: tradeImageData || null,
      rating: currentTradeRating || null,
      tags: currentTradeTags.slice() || []
    };
  }
  
  saveTradesToStorage();
  closeModal();
  renderTrades();
  renderFullTradeLog();
  updateStats();
  showToast('Trade updated!');
}

function previewTradeImage(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 5 * 1024 * 1024) {
    alert('Image too large. Maximum size is 5MB.');
    event.target.value = '';
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    tradeImageData = e.target.result;
    document.getElementById('imagePreview').src = tradeImageData;
    document.getElementById('imagePreviewContainer').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function removeTradeImage() {
  tradeImageData = null;
  document.getElementById('tradeImage').value = '';
  document.getElementById('imagePreviewContainer').style.display = 'none';
}

function setTradeRating(rating) {
  currentTradeRating = rating;
  var stars = document.querySelectorAll('#tradeRating .star');
  stars.forEach(function(star, index) {
    if (index < rating) {
      star.classList.add('active');
    } else {
      star.classList.remove('active');
    }
  });
}

function renderStars(rating) {
  var html = '<span class="star-display">';
  for (var i = 1; i <= 5; i++) {
    html += i <= rating ? '‚òÖ' : '<span class="empty">‚òÖ</span>';
  }
  html += '</span>';
  return html;
}

function addTradeTag() {
  var input = document.getElementById('newTagInput');
  var tag = input.value.trim();
  if (!tag) return;
  if (currentTradeTags.indexOf(tag) === -1) {
    currentTradeTags.push(tag);
    renderTradeTags();
  }
  input.value = '';
}

function addQuickTag(tag) {
  if (currentTradeTags.indexOf(tag) === -1) {
    currentTradeTags.push(tag);
    renderTradeTags();
  }
}

function removeTradeTag(index) {
  currentTradeTags.splice(index, 1);
  renderTradeTags();
}

function renderTradeTags() {
  var container = document.getElementById('tradeTagsContainer');
  if (currentTradeTags.length === 0) {
    container.innerHTML = '';
    return;
  }
  var html = '';
  for (var i = 0; i < currentTradeTags.length; i++) {
    html += '<span class="trade-tag">' + currentTradeTags[i] + '<span class="remove-tag" onclick="removeTradeTag(' + i + ')">√ó</span></span>';
  }
  container.innerHTML = html;
}

function renderTagsDisplay(tags) {
  if (!tags || tags.length === 0) return '';
  var html = '';
  for (var i = 0; i < tags.length; i++) {
    html += '<span class="trade-tag" style="font-size:11px;padding:2px 8px">' + tags[i] + '</span>';
  }
  return html;
}

function viewTradeImage(tradeId) {
  var trade = trades.find(function(t) { return t.id === tradeId; });
  if (trade && trade.image) {
    document.getElementById('imageModalImg').src = trade.image;
    document.getElementById('imageModal').classList.add('active');
  }
}

function closeImageModal() {
  document.getElementById('imageModal').classList.remove('active');
}

function openModal() { 
  document.getElementById('tradeModal').classList.add('active'); 
  document.getElementById('tradeDate').valueAsDate = new Date();
  document.getElementById('direction').value = settings.defaultDirection || 'long';
  
  // Reset image
  tradeImageData = null;
  document.getElementById('tradeImage').value = '';
  document.getElementById('imagePreviewContainer').style.display = 'none';
  
  // Reset checklist
  document.getElementById('tradeChecklistContainer').style.display = 'none';
  document.getElementById('tradeChecklistItems').innerHTML = '';
  
  // Populate strategy dropdown from playbook
  var strategySelect = document.getElementById('strategy');
  var html = '<option value="">Select...</option>';
  
  // Add playbook strategies first
  if (playbook.length > 0) {
    playbook.forEach(function(p) {
      html += '<option value="' + p.name + '">' + p.name + '</option>';
    });
    html += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
  }
  
  // Add default categories
  html += '<option value="breakout">Breakout</option>';
  html += '<option value="pullback">Pullback</option>';
  html += '<option value="reversal">Reversal</option>';
  html += '<option value="momentum">Momentum</option>';
  html += '<option value="scalp">Scalp</option>';
  html += '<option value="swing">Swing</option>';
  
  strategySelect.innerHTML = html;
  strategySelect.value = settings.defaultStrategy || '';
  
  // Trigger checklist if default strategy has rules
  onStrategyChange();
}

function onStrategyChange() {
  var strategyName = document.getElementById('strategy').value;
  var container = document.getElementById('tradeChecklistContainer');
  var itemsContainer = document.getElementById('tradeChecklistItems');
  var warningEl = document.getElementById('checklistWarning');
  
  // Find strategy in playbook
  var strategy = playbook.find(function(p) { return p.name === strategyName; });
  
  // Get rules array (handle both formats)
  var rules = [];
  if (strategy && strategy.entryRules) {
    if (Array.isArray(strategy.entryRules)) {
      rules = strategy.entryRules;
    } else if (typeof strategy.entryRules === 'string' && strategy.entryRules.trim()) {
      rules = strategy.entryRules.split('\n').filter(function(r) { return r.trim(); });
    }
  }
  
  if (rules.length > 0) {
    // Show checklist
    container.style.display = 'block';
    warningEl.style.display = 'none';
    
    var html = '';
    for (var i = 0; i < rules.length; i++) {
      html += '<div class="checklist-item" id="tradeRule' + i + '">';
      html += '<input type="checkbox" id="ruleCheck' + i + '" onchange="updateChecklistWarning()">';
      html += '<span>' + rules[i] + '</span>';
      html += '</div>';
    }
    itemsContainer.innerHTML = html;
  } else {
    // Hide checklist
    container.style.display = 'none';
    itemsContainer.innerHTML = '';
  }
}

function updateChecklistWarning() {
  var checkboxes = document.querySelectorAll('#tradeChecklistItems input[type="checkbox"]');
  var allChecked = true;
  
  checkboxes.forEach(function(cb, index) {
    var item = document.getElementById('tradeRule' + index);
    if (cb.checked) {
      item.classList.add('checked');
    } else {
      item.classList.remove('checked');
      allChecked = false;
    }
  });
  
  var warningEl = document.getElementById('checklistWarning');
  warningEl.style.display = allChecked ? 'none' : 'block';
}

function getChecklistStatus() {
  var checkboxes = document.querySelectorAll('#tradeChecklistItems input[type="checkbox"]');
  var total = checkboxes.length;
  var checked = 0;
  checkboxes.forEach(function(cb) { if (cb.checked) checked++; });
  return { total: total, checked: checked };
}
function closeModal() { 
  document.getElementById('tradeModal').classList.remove('active'); 
  document.getElementById('symbol').value = ''; 
  document.getElementById('tradePnl').value = ''; 
  document.getElementById('tradeTime').value = '';
  document.getElementById('quantity').value = ''; 
  document.getElementById('entryPrice').value = ''; 
  document.getElementById('exitPrice').value = ''; 
  document.getElementById('stopLoss').value = ''; 
  document.getElementById('riskAmount').value = ''; 
  document.getElementById('strategy').value = ''; 
  document.getElementById('notes').value = '';
  tradeImageData = null;
  document.getElementById('tradeImage').value = '';
  document.getElementById('imagePreviewContainer').style.display = 'none';
  // Reset rating
  currentTradeRating = 0;
  setTradeRating(0);
  // Reset tags
  currentTradeTags = [];
  renderTradeTags();
  // Reset checklist
  document.getElementById('tradeChecklistContainer').style.display = 'none';
  document.getElementById('tradeChecklistItems').innerHTML = '';
  // Reset to new trade mode
  document.querySelector('#tradeModal .modal-title').textContent = 'Log New Trade';
  document.querySelector('#tradeModal .modal-footer').innerHTML = '<button class="btn btn-secondary" onclick="closeModal()" style="padding:14px 28px;font-size:15px">Cancel</button><button class="btn btn-primary" onclick="saveTrade()" style="padding:14px 36px;font-size:15px">Save Trade</button>';
}

function saveTrade() {
  // Check trade limit (monthly - subscription)
  if (!canAddTrade()) {
    alert('You have reached your monthly limit of ' + FREE_TRADE_LIMIT + ' trades.\n\nUpgrade to Premium for unlimited trades!');
    closeModal();
    showPage('subscription', document.querySelector('[onclick*="subscription"]'));
    return;
  }
  
  // Check daily trade limit (overtrading prevention)
  if (!canAddTradeToday()) {
    alert('You have reached your daily limit of ' + settings.maxTradesPerDay + ' trades.\n\nThis limit helps prevent overtrading. You can change it in Settings > Goals.');
    closeModal();
    return;
  }
  
  var symbol = document.getElementById('symbol').value.toUpperCase().trim();
  var date = document.getElementById('tradeDate').value;
  var time = document.getElementById('tradeTime').value || null;
  var direction = document.getElementById('direction').value;
  var pnl = parseFloat(document.getElementById('tradePnl').value);
  var quantity = parseFloat(document.getElementById('quantity').value) || null;
  var entry = parseFloat(document.getElementById('entryPrice').value) || null;
  var exit = parseFloat(document.getElementById('exitPrice').value) || null;
  var stopLoss = parseFloat(document.getElementById('stopLoss').value) || null;
  var riskAmount = parseFloat(document.getElementById('riskAmount').value) || null;
  var strategy = document.getElementById('strategy').value;
  var notes = document.getElementById('notes').value;
  
  if (!symbol || !date || isNaN(pnl)) { alert('Please fill in Symbol, Date, and P/L'); return; }
  
  var rMultiple = null;
  if (riskAmount && riskAmount > 0) {
    rMultiple = pnl / riskAmount;
  } else if (stopLoss && entry && quantity) {
    var risk = direction === 'long' ? entry - stopLoss : stopLoss - entry;
    if (risk > 0) rMultiple = pnl / (risk * quantity);
  }
  
  trades.unshift({ 
    id: Date.now(), 
    symbol: symbol, 
    date: date,
    time: time,
    direction: direction, 
    entry: entry, 
    exit: exit, 
    quantity: quantity, 
    stopLoss: stopLoss, 
    pnl: pnl, 
    rMultiple: rMultiple, 
    riskAmount: riskAmount, 
    strategy: strategy, 
    notes: notes,
    image: tradeImageData || null,
    rating: currentTradeRating || null,
    tags: currentTradeTags.slice() || []
  });
  saveTradesToStorage();
  syncTradeToCloud(trades[0]);
  closeModal();
  renderTrades();
  renderFullTradeLog();
  updateStats();
}

function exportTrades() {
  if (trades.length === 0) { alert('No trades to export'); return; }
  var csv = 'Date,Symbol,Direction,Entry,Exit,Quantity,P/L,Strategy,Notes\n';
  for (var i = 0; i < trades.length; i++) { var t = trades[i]; csv += t.date + ',' + t.symbol + ',' + t.direction + ',' + t.entry + ',' + t.exit + ',' + t.quantity + ',' + t.pnl.toFixed(2) + ',' + (t.strategy||'') + ',"' + (t.notes||'') + '"\n'; }
  var a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); a.download = 'trades.csv'; a.click();
}

function saveTradesToStorage() { localStorage.setItem('tradingJournalTrades', JSON.stringify(trades)); }
function loadTradesFromStorage() { var stored = localStorage.getItem('tradingJournalTrades'); if (stored) { try { trades = JSON.parse(stored); } catch(e) {} } }

// Note: App initialization is handled by checkSession() at the top of the script.
// checkSession() calls either onAuthSuccess() or continueOffline() which calls initApp().

// Resize chart on window resize
window.addEventListener('resize', function() {
  updateChart();
});

// Redraw chart after DOM is fully ready
setTimeout(function() {
  updateChart();
}, 100);
</script>
</body>
</html>
